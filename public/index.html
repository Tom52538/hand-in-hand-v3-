<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbeitszeiterfassung</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Stile wie gehabt */
    .hidden { display: none; }
    .booking-row { margin-bottom: 0.5rem; }
    .table-wrapper { overflow-x: auto; margin-bottom: 1rem; }
    .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    h1, h2, h3 { color: #333; }
    button { padding: 10px 15px; cursor: pointer; margin-top: 5px; margin-right: 5px;}
    button:disabled { cursor: not-allowed; background-color: #ccc; border-color: #bbb; } /* Deutlicher disabled style */
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: middle; }
    input[readonly] { background-color: #e9e9e9; cursor: default; }
    .tabs { list-style: none; padding: 0; margin: 0 0 1rem 0; display: flex; flex-wrap: wrap; border-bottom: 1px solid #ccc; }
    .tabs li { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; margin-right: 5px; margin-bottom: -1px; background: #f1f1f1; border-radius: 4px 4px 0 0; }
    .tabs li.active { background: #fff; font-weight: bold; border-bottom: 1px solid #fff; }
    .tab-content { border: 1px solid #ccc; padding: 20px; background: #fff; border-radius: 0 0 4px 4px; border-top: none; margin-bottom: 2rem; }
    /* Styling für Formulare */
    #balanceForm label, #addAbsenceForm label, #addEmployeeForm label, #editEmployeeForm label, #editForm label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
    #balanceForm select, #balanceForm input[type="number"],
    #addAbsenceForm select, #addAbsenceForm input[type="date"], #addAbsenceForm input[type="text"],
    #addEmployeeForm input, #editEmployeeForm input, #editForm input { width: calc(100% - 18px); padding: 8px; margin-bottom: 0.8rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
     #balanceForm > div, #addAbsenceForm > div, #addEmployeeForm > div, #editEmployeeForm > div, #editForm > div { margin-bottom: 1rem; }
     #addAbsenceForm { border: 1px solid #eee; padding: 15px; margin-top: 1.5rem; background-color: #fdfdfd; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbeitszeiterfassung</h1>

    <form id="workHoursForm">
      <div><label for="employeeSelect">Mitarbeiter:</label><select id="employeeSelect" name="employeeSelect" required><option value="">Bitte auswählen</option></select></div>
      <div><button type="button" id="workTimeBtn" disabled>Arbeitsbeginn buchen</button></div>
      <div id="bookingDetails" class="booking-details">
         <div class="booking-row"><label for="displayDate">Datum:</label><input type="text" id="displayDate" readonly></div>
         <div class="booking-row"><label for="displayStartTime">Arbeitsbeginn:</label><input type="text" id="displayStartTime" readonly></div>
         <div class="booking-row"><label for="displayEndTime">Arbeitsende:</label><input type="text" id="displayEndTime" readonly></div>
         <div id="summaryHours" class="hidden"><div class="booking-row"><label>Arbeitszeit Tag:</label><span id="dailyTotalHours">--</span></div><div class="booking-row"><label>Arbeitszeit Monat:</label><span id="monthlyTotalHours">--</span></div></div>
       </div>
    </form>
    <hr>
    <h2>Admin Login</h2>
    <form id="adminLoginForm"><div><label for="adminPassword">Passwort:</label><input type="password" id="adminPassword" name="adminPassword" required></div><button type="submit">Anmelden</button></form>
    <div id="adminTabs" class="hidden">
      <ul class="tabs">
        <li data-tab="workhours" class="active">Arbeitszeiten</li><li data-tab="employees">Mitarbeiter</li><li data-tab="absences">Abwesenheiten</li><li data-tab="reports">Auswertungen</li>
      </ul>
      <div id="tab-workhours" class="tab-content"><h2>Arbeitszeiten verwalten</h2>...</div>
      <div id="tab-employees" class="tab-content hidden"><h2>Mitarbeiterverwaltung</h2>...</div>
      <div id="tab-absences" class="tab-content hidden"><h2>Abwesenheiten verwalten</h2>...</div>
      <div id="tab-reports" class="tab-content hidden">
        <h2>Auswertungen</h2>
        <form id="balanceForm">
          <div><label for="balanceName">Mitarbeitername:</label><select id="balanceName" name="balanceName" required><option value="">Bitte auswählen</option></select></div>
          <div><label for="balanceYear">Jahr:</label><input type="number" id="balanceYear" name="balanceYear" required></div>
          <div><label for="periodTypeSelect">Zeitraum:</label><select id="periodTypeSelect" name="periodType" required><option value="MONTH" selected>Monat</option><option value="QUARTER">Quartal</option><option value="YEAR">Jahr</option></select></div>
          <div id="monthSelectDiv"><label for="balanceMonth">Monat (1-12):</label><input type="number" id="balanceMonth" name="balanceMonth" required min="1" max="12"></div>
          <div id="quarterSelectDiv" class="hidden"><label for="balanceQuarter">Quartal:</label><select id="balanceQuarter" name="balanceQuarter" required><option value="1">Q1</option><option value="2">Q2</option><option value="3">Q3</option><option value="4">Q4</option></select></div>
          <button type="submit">Auswertung berechnen</button>
        </form><br>
        <button id="downloadPdfBtn" disabled>PDF herunterladen</button> <div id="balanceResult" style="margin-top: 1rem;"></div>
      </div>
    </div>
  </div>
  <script>
    // Globale Variablen
    let currentWorkEntryId = null;
    // ==== DOM-Referenzen ====
    const employeeSelect = document.getElementById('employeeSelect');
    const workTimeBtn = document.getElementById('workTimeBtn');
    const displayDateInput = document.getElementById('displayDate');
    const displayStartTimeInput = document.getElementById('displayStartTime');
    const displayEndTimeInput = document.getElementById('displayEndTime');
    const summaryHoursDiv = document.getElementById('summaryHours');
    const dailyTotalHoursSpan = document.getElementById('dailyTotalHours');
    const monthlyTotalHoursSpan = document.getElementById('monthlyTotalHours');
    // Auswertungsformular
    const balanceForm = document.getElementById('balanceForm');
    const balanceNameSelect = document.getElementById('balanceName');
    const balanceYearInput = document.getElementById('balanceYear');
    const periodTypeSelect = document.getElementById('periodTypeSelect');
    const monthSelectDiv = document.getElementById('monthSelectDiv');
    const balanceMonthInput = document.getElementById('balanceMonth');
    const quarterSelectDiv = document.getElementById('quarterSelectDiv');
    const balanceQuarterSelect = document.getElementById('balanceQuarter');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const balanceResultDiv = document.getElementById('balanceResult');
    // Abwesenheits-Tab Elemente
    const absenceEmployeeSelect = document.getElementById('absenceEmployeeSelect');
    const absencesTableBody = document.querySelector('#absencesTable tbody');
    const addAbsenceForm = document.getElementById('addAbsenceForm');
    const addAbsenceEmployeeIdInput = document.getElementById('addAbsenceEmployeeId');
    const addAbsenceDateInput = document.getElementById('addAbsenceDate');
    const addAbsenceTypeSelect = document.getElementById('addAbsenceType');
    const addAbsenceCommentInput = document.getElementById('addAbsenceComment');
    const addAbsenceSubmitBtn = document.getElementById('addAbsenceSubmitBtn');
    const absenceFormNote = document.getElementById('absenceFormNote');

    // ==== Initialisierung ====
    document.addEventListener('DOMContentLoaded', () => {
      resetWorkTimeForm();
      loadEmployeeOptions();
      setupEventListeners();
      const now = new Date();
      balanceYearInput.value = now.getFullYear();
      balanceMonthInput.value = now.getMonth() + 1;
      periodTypeSelect.value = 'MONTH';
      handlePeriodTypeChange(); // Stellt sicher, dass Button initial korrekt ist
    });

    function setupEventListeners() {
      employeeSelect.addEventListener('change', handleEmployeeSelection);
      workTimeBtn.addEventListener('click', handleWorkTimeToggle);
      document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
      document.querySelectorAll('.tabs li').forEach(tab => { tab.addEventListener('click', handleTabSwitch); });
      document.getElementById('adminDownloadCsv').addEventListener('click', downloadAdminCsv);
      document.getElementById('adminDeleteData').addEventListener('click', deleteAllWorkHours);
      document.getElementById('addEmployeeForm').addEventListener('submit', handleAddEmployee);
      balanceForm.addEventListener('submit', handleCalculateBalance);
      periodTypeSelect.addEventListener('change', handlePeriodTypeChange);
      downloadPdfBtn.addEventListener('click', handleDownloadPdf); // Aufruf der geänderten Funktion
      // Listener für Abwesenheiten
      absenceEmployeeSelect.addEventListener('change', handleAbsenceEmployeeSelectChange);
      addAbsenceForm.addEventListener('submit', handleAddAbsence);
    }

    // ==== Funktionen Zeiterfassung (Benutzer) ====
    // loadEmployeeOptions, handleEmployeeSelection, checkNextBookingAction, handleWorkTimeToggle, displaySummaryHours, resetWorkTimeForm, resetBookingDetails
    // (Unverändert von letzter korrekter Version)
     async function loadEmployeeOptions() { try { const response = await fetch('/employees'); if (!response.ok) throw new Error(`Ladefehler (${response.status}).`); const employees = await response.json(); const populateSelectWithId = (selectElement) => { selectElement.innerHTML = '<option value="">Bitte auswählen</option>'; employees.forEach(emp => { const option = document.createElement('option'); option.value = emp.id; option.textContent = emp.name; selectElement.appendChild(option); }); }; employeeSelect.innerHTML = '<option value="">Bitte auswählen</option>'; employees.forEach(emp => { const option = document.createElement('option'); option.value = emp.name; option.textContent = emp.name; employeeSelect.appendChild(option); }); populateSelectWithId(balanceNameSelect); populateSelectWithId(absenceEmployeeSelect); } catch (err) { console.error("Fehler Laden MA-Optionen:", err); const errorMsg = '<option value="">Fehler</option>'; employeeSelect.innerHTML = errorMsg; if(balanceNameSelect) balanceNameSelect.innerHTML = errorMsg; if(absenceEmployeeSelect) absenceEmployeeSelect.innerHTML = errorMsg; alert("❌ Mitarbeiterliste Ladefehler: " + err.message); } }
     function handleEmployeeSelection() { checkNextBookingAction(); }
     async function checkNextBookingAction() { const name = employeeSelect.value; resetBookingDetails(); workTimeBtn.disabled = true; currentWorkEntryId = null; if (!name) return; try { const response = await fetch(`/next-booking-details?name=${encodeURIComponent(name)}`); if (!response.ok) throw new Error(`Fehler ${response.status}.`); const data = await response.json(); if (data.nextBooking === 'arbeitsende') { workTimeBtn.textContent = 'Arbeitsende buchen'; workTimeBtn.style.backgroundColor = 'orange'; currentWorkEntryId = data.id; workTimeBtn.disabled = false; if (data.startDate) { try { const dateObj = new Date(data.startDate + 'T00:00:00Z'); displayDateInput.value = dateObj.toLocaleDateString('de-DE', { timeZone: 'UTC' }); } catch(e) { displayDateInput.value = data.startDate; } } displayStartTimeInput.value = data.startTime ? data.startTime + " Uhr" : ''; displayEndTimeInput.value = ''; } else { workTimeBtn.textContent = 'Arbeitsbeginn buchen'; workTimeBtn.style.backgroundColor = ''; workTimeBtn.disabled = false; } } catch (error) { console.error("Fehler '/next-booking-details':", error); alert("❌ Fehler Buchungsstatus: " + error.message); } }
     async function handleWorkTimeToggle() { const name = employeeSelect.value; if (!name) return; const action = workTimeBtn.textContent.includes('Arbeitsbeginn') ? 'start' : 'end'; const now = new Date(); const date = now.toISOString().split("T")[0]; const time = now.toTimeString().slice(0, 5); const displayDate = now.toLocaleDateString('de-DE'); workTimeBtn.disabled = true; if (action === 'start') { try { const response = await fetch("/log-start", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, date, startTime: time }) }); if (response.ok) { const result = await response.json(); alert("✅ Arbeitsbeginn gebucht."); displayDateInput.value = displayDate; displayStartTimeInput.value = time + " Uhr"; displayEndTimeInput.value = ''; summaryHoursDiv.classList.add('hidden'); currentWorkEntryId = result.id; } else { const result = await response.json().catch(() => ({ message: 'Unbekannter Fehler.' })); alert("❌ Fehler Arbeitsbeginn: " + (result.message || response.statusText)); } } catch (err) { console.error("Fehler Arbeitsbeginn:", err); alert("❌ Netzwerkfehler!"); } finally { workTimeBtn.disabled = false; checkNextBookingAction(); } } else { if (!currentWorkEntryId) { alert("Fehler: Keine ID für offenen Eintrag."); workTimeBtn.disabled = false; checkNextBookingAction(); return; } try { const response = await fetch(`/log-end/${currentWorkEntryId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ endTime: time, comment: "" }) }); if (response.ok) { alert("✅ Arbeitsende gebucht."); displayEndTimeInput.value = time + " Uhr"; currentWorkEntryId = null; displaySummaryHours(name, date); } else { const result = await response.json().catch(() => ({ message: 'Unbekannter Fehler.' })); alert("❌ Fehler Arbeitsende: " + (result.message || response.statusText)); } } catch (err) { console.error("Fehler Arbeitsende:", err); alert("❌ Netzwerkfehler!"); } finally { workTimeBtn.disabled = false; checkNextBookingAction(); } } }
     async function displaySummaryHours(employeeName, dayDate) { if (!employeeName || !dayDate) return; summaryHoursDiv.classList.add('hidden'); dailyTotalHoursSpan.textContent = 'lade...'; monthlyTotalHoursSpan.textContent = 'lade...'; try { let queryDate = dayDate; if (!/^\d{4}-\d{2}-\d{2}$/.test(dayDate)) { try { const dateParts = dayDate.split('.'); queryDate = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`; } catch(e){ console.error("Konnte Datum nicht parsen:", dayDate); queryDate = new Date().toISOString().split('T')[0]; } } const response = await fetch(`/summary-hours?name=${encodeURIComponent(employeeName)}&date=${queryDate}`); if (!response.ok) throw new Error(`Fehler ${response.status}.`); const summary = await response.json(); dailyTotalHoursSpan.textContent = `${summary.dailyHours ? summary.dailyHours.toFixed(2) : '0.00'} Std.`; monthlyTotalHoursSpan.textContent = `${summary.monthlyHours ? summary.monthlyHours.toFixed(2) : '0.00'} Std.`; summaryHoursDiv.classList.remove('hidden'); } catch (error) { console.error("Fehler Zusammenfassung:", error); dailyTotalHoursSpan.textContent = 'Fehler'; monthlyTotalHoursSpan.textContent = 'Fehler'; summaryHoursDiv.classList.remove('hidden'); } }
     function resetWorkTimeForm() { employeeSelect.value = ''; workTimeBtn.textContent = 'Arbeitsbeginn buchen'; workTimeBtn.style.backgroundColor = ''; workTimeBtn.disabled = true; resetBookingDetails(); }
     function resetBookingDetails() { displayDateInput.value = ''; displayStartTimeInput.value = ''; displayEndTimeInput.value = ''; summaryHoursDiv.classList.add('hidden'); dailyTotalHoursSpan.textContent = '--'; monthlyTotalHoursSpan.textContent = '--'; currentWorkEntryId = null; }

    // ==== Admin-Funktionen ====
    // handleAdminLogin (Unverändert)
    async function handleAdminLogin(e) { e.preventDefault(); const password = document.getElementById("adminPassword").value; try { const response = await fetch("/admin-login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ password }), credentials: "include" }); if (response.ok) { alert("✅ Admin angemeldet."); document.getElementById("adminPassword").value = ""; document.getElementById("adminTabs").classList.remove("hidden"); document.getElementById("adminLoginForm").classList.add("hidden"); loadAdminWorkHours(); } else { const result = await response.text(); alert("❌ Login fehlgeschlagen: " + response.status + " – " + result); } } catch (error) { console.error("❌ Netzwerkfehler Admin-Login:", error); alert("❌ Netzwerkfehler."); } }
    // handleTabSwitch (Unverändert von letzter korrekter Version)
    function handleTabSwitch(event) { const clickedTab = event.currentTarget; document.querySelectorAll(".tabs li").forEach(t => t.classList.remove("active")); document.querySelectorAll(".tab-content").forEach(tc => tc.classList.add("hidden")); clickedTab.classList.add("active"); const targetContentId = "tab-" + clickedTab.getAttribute("data-tab"); const targetContent = document.getElementById(targetContentId); if (targetContent) { targetContent.classList.remove("hidden"); if (targetContentId === 'tab-workhours') loadAdminWorkHours(); if (targetContentId === 'tab-employees') loadEmployees(); if (targetContentId === 'tab-absences') { loadEmployeeOptionsForAbsences(); absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>'; addAbsenceSubmitBtn.disabled = true; absenceFormNote.classList.remove('hidden'); addAbsenceForm.reset(); } if (targetContentId === 'tab-reports') loadEmployeeOptionsForReports(); } }
    function loadEmployeeOptionsForReports() { console.log("Mitarbeiteroptionen für Auswertungen geprüft."); }
    function loadEmployeeOptionsForAbsences() { console.log("Mitarbeiteroptionen für Abwesenheiten geprüft."); }
    // loadAdminWorkHours, editEntry, cancelEditWorkHours, saveChanges, deleteEntry, downloadAdminCsv, deleteAllWorkHours
    // (Unverändert von letzter korrekter Version)
     async function loadAdminWorkHours() { const tbody = document.querySelector("#workHoursTable tbody"); tbody.innerHTML = "<tr><td colspan='7'>Lade Daten...</td></tr>"; try { const response = await fetch('/admin-work-hours', { credentials: "include" }); if (!response.ok) throw new Error(`Laden fehlgeschlagen (${response.status}).`); const data = await response.json(); tbody.innerHTML = ""; if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='7'>Keine Arbeitszeiten erfasst.</td></tr>"; return; } data.forEach(entry => { const row = document.createElement("tr"); const hours = parseFloat(entry.hours) || 0; let displayDate = 'N/A'; if (entry.date) { try { const dateObj = new Date(entry.date.split('T')[0] + 'T00:00:00Z'); displayDate = dateObj.toLocaleDateString("de-DE", { timeZone: 'UTC' }); } catch(e) { displayDate = entry.date; console.warn("Admin Datumsformat Fehler:", entry.date, e); } } row.innerHTML = `<td>${entry.id}</td><td>${entry.name || 'Unbekannt'}</td><td>${displayDate}</td><td>${entry.startTime || '--:--'} - ${entry.endTime || '--:--'}</td><td>${hours.toFixed(2)}</td><td>${entry.comment || ''}</td><td><button onclick='editEntry(${JSON.stringify(entry)})'>Bearbeiten</button> <button onclick="deleteEntry(${entry.id})">Löschen</button></td>`; tbody.appendChild(row); }); } catch (error) { console.error("Fehler Laden Admin-Arbeitszeiten:", error); tbody.innerHTML = `<tr><td colspan="7">❌ Fehler: ${error.message}</td></tr>`; } }
     function editEntry(entry) { document.getElementById("editId").value = entry.id; document.getElementById("editName").value = entry.name || ""; document.getElementById("editDate").value = entry.date ? entry.date.split("T")[0] : ""; document.getElementById("editStartTime").value = entry.startTime || ""; document.getElementById("editEndTime").value = entry.endTime || ""; document.getElementById("editComment").value = entry.comment || ""; document.getElementById("editWorkHoursSection").classList.remove("hidden"); document.getElementById("editWorkHoursSection").scrollIntoView({ behavior: "smooth" }); }
     function cancelEditWorkHours() { document.getElementById("editWorkHoursSection").classList.add("hidden"); document.getElementById("editForm").reset(); document.getElementById("editId").value = ""; }
     async function saveChanges() { const id = document.getElementById("editId").value; if (!id) return; const data = { id, name: document.getElementById("editName").value, date: document.getElementById("editDate").value, startTime: document.getElementById("editStartTime").value, endTime: document.getElementById("editEndTime").value, comment: document.getElementById("editComment").value }; if (!data.name || !data.date || !data.startTime || !data.endTime) { alert("Bitte alle erforderlichen Felder ausfüllen."); return; } try { const response = await fetch("/api/admin/update-hours", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data), credentials: "include" }); const result = await response.text(); if (response.ok) { alert("✅ Änderungen gespeichert."); cancelEditWorkHours(); loadAdminWorkHours(); } else { alert(`❌ Fehler Speichern (${response.status}): ${result}`); } } catch (error) { console.error("Fehler Speichern:", error); alert("❌ Netzwerkfehler."); } }
     async function deleteEntry(id) { if (!confirm(`Soll der Eintrag mit ID ${id} wirklich gelöscht werden?`)) return; try { const response = await fetch(`/api/admin/delete-hours/${id}`, { method: "DELETE", credentials: "include" }); const result = await response.text(); if (response.ok) { alert("✅ Eintrag gelöscht."); loadAdminWorkHours(); } else { alert(`❌ Fehler Löschen (${response.status}): ${result}`); } } catch (error) { console.error(`Fehler Löschen ${id}:`, error); alert("❌ Netzwerkfehler."); } }
     async function downloadAdminCsv() { window.open('/admin-download-csv', '_blank'); }
     async function deleteAllWorkHours() { if (!confirm('WARNUNG!\n\nAlle Arbeitszeiten, Monatsbilanzen UND Abwesenheiten unwiderruflich löschen?')) return; try { const response = await fetch('/adminDeleteData', { method: 'DELETE', credentials: 'include' }); const result = await response.text(); if (response.ok) { alert(`✅ ${result}`); loadAdminWorkHours(); balanceResultDiv.innerHTML = ''; if(absencesTableBody) absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>'; } else { alert(`❌ Fehler Löschen (${response.status}): ${result}`); } } catch (error) { console.error('Fehler Löschen aller Daten:', error); alert('❌ Netzwerkfehler.'); } }

    // ==== Mitarbeiterverwaltung ====
    // loadEmployees, handleAddEmployee, editEmployee, cancelEditEmployee, saveEmployeeChanges, deleteEmployee
    // (Unverändert von letzter korrekter Version)
     async function loadEmployees() { const list = document.getElementById("employeeList"); list.innerHTML = "<li>Lade MA...</li>"; try { const response = await fetch("/admin/employees", { credentials: "include" }); if (!response.ok) throw new Error(`Ladefehler (${response.status}).`); const data = await response.json(); list.innerHTML = ""; if (data.length > 0) { data.forEach(emp => { const li = document.createElement("li"); li.innerHTML = `<span>${emp.name} (Soll: Mo:${emp.mo_hours||0}, Di:${emp.di_hours||0}, Mi:${emp.mi_hours||0}, Do:${emp.do_hours||0}, Fr:${emp.fr_hours||0})</span> <div> <button onclick='editEmployee(${JSON.stringify(emp)})'>Bearbeiten</button> <button onclick="deleteEmployee(${emp.id}, '${emp.name}')">Löschen</button> </div>`; list.appendChild(li); }); } else { list.innerHTML = "<li>Keine MA angelegt.</li>"; } } catch (error) { console.error("Fehler Laden MA:", error); list.innerHTML = `<li>❌ Fehler: ${error.message}</li>`; } }
     async function handleAddEmployee(event) { event.preventDefault(); const form = event.target; const data = { name: form.employeeName.value.trim(), mo_hours: parseFloat(form.mo_hours.value) || 0, di_hours: parseFloat(form.di_hours.value) || 0, mi_hours: parseFloat(form.mi_hours.value) || 0, do_hours: parseFloat(form.do_hours.value) || 0, fr_hours: parseFloat(form.fr_hours.value) || 0 }; if (!data.name) { alert("Namen eingeben."); return; } try { const response = await fetch('/admin/employees', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), credentials: 'include' }); if (response.ok) { const result = await response.json(); alert(`✅ MA "${result.name}" hinzugefügt.`); form.reset(); loadEmployees(); loadEmployeeOptions(); } else { const errorText = await response.text().catch(() => response.statusText); alert(`❌ Fehler Hinzufügen (${response.status}): ${errorText}`); } } catch (error) { console.error('Fehler Hinzufügen MA:', error); alert('❌ Netzwerkfehler.'); } }
     function editEmployee(emp) { document.getElementById("editEmployeeId").value = emp.id; document.getElementById("editEmployeeName").value = emp.name; document.getElementById("editMoHours").value = emp.mo_hours || 0; document.getElementById("editDiHours").value = emp.di_hours || 0; document.getElementById("editMiHours").value = emp.mi_hours || 0; document.getElementById("editDoHours").value = emp.do_hours || 0; document.getElementById("editFrHours").value = emp.fr_hours || 0; document.getElementById("editEmployeeSection").classList.remove("hidden"); document.getElementById("addEmployeeSection").classList.add("hidden"); document.getElementById("editEmployeeSection").scrollIntoView({ behavior: "smooth" }); }
     function cancelEditEmployee() { document.getElementById("editEmployeeSection").classList.add("hidden"); document.getElementById("addEmployeeSection").classList.remove("hidden"); document.getElementById("editEmployeeForm").reset(); document.getElementById("editEmployeeId").value = ""; }
     async function saveEmployeeChanges() { const id = document.getElementById("editEmployeeId").value; if (!id) return; const data = { id, name: document.getElementById("editEmployeeName").value.trim(), mo_hours: parseFloat(document.getElementById("editMoHours").value) || 0, di_hours: parseFloat(document.getElementById("editDiHours").value) || 0, mi_hours: parseFloat(document.getElementById("editMiHours").value) || 0, do_hours: parseFloat(document.getElementById("editDoHours").value) || 0, fr_hours: parseFloat(document.getElementById("editFrHours").value) || 0 }; if (!data.name) { alert("Name darf nicht leer sein."); return; } try { const response = await fetch(`/admin/employees/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), credentials: 'include' }); const result = await response.text(); if (response.ok) { alert(`✅ MA-Daten aktualisiert.`); cancelEditEmployee(); loadEmployees(); loadEmployeeOptions(); } else { alert(`❌ Fehler Aktualisieren (${response.status}): ${result}`); } } catch (error) { console.error("Fehler Speichern MA:", error); alert("❌ Netzwerkfehler."); } }
     async function deleteEmployee(id, name) { if (!confirm(`MA "${name}" (ID: ${id}) und alle Daten löschen?`)) return; try { const response = await fetch(`/admin/employees/${id}`, { method: 'DELETE', credentials: 'include' }); const result = await response.text(); if (response.ok) { alert(`✅ MA "${name}" und Daten gelöscht.`); loadEmployees(); loadEmployeeOptions(); if(document.querySelector('#tab-workhours').classList.contains('active')) loadAdminWorkHours(); balanceResultDiv.innerHTML = ''; if(absencesTableBody) absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>'; } else { alert(`❌ Fehler Löschen (${response.status}): ${result}`); } } catch (error) { console.error(`Fehler Löschen MA ${id}:`, error); alert("❌ Netzwerkfehler."); } }
    // === Funktionen für Abwesenheiten ===
    // handleAbsenceEmployeeSelectChange, loadAbsences, handleAddAbsence, deleteAbsence
    // (Unverändert von letzter korrekter Version)
     function handleAbsenceEmployeeSelectChange() { const selectedEmployeeId = absenceEmployeeSelect.value; const employeeName = absenceEmployeeSelect.options[absenceEmployeeSelect.selectedIndex].text; if (selectedEmployeeId) { addAbsenceEmployeeIdInput.value = selectedEmployeeId; addAbsenceSubmitBtn.disabled = false; absenceFormNote.classList.add('hidden'); loadAbsences(selectedEmployeeId, employeeName); } else { addAbsenceEmployeeIdInput.value = ''; addAbsenceSubmitBtn.disabled = true; absenceFormNote.classList.remove('hidden'); absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>'; } addAbsenceForm.reset(); addAbsenceTypeSelect.value = ""; }
     async function loadAbsences(employeeId, employeeName) { if (!employeeId) return; absencesTableBody.innerHTML = `<tr><td colspan="5">Lade Abwesenheiten für ${employeeName}...</td></tr>`; try { const response = await fetch(`/admin/absences?employeeId=${employeeId}`, { credentials: 'include' }); if (!response.ok) { throw new Error(`Fehler ${response.status}.`); } const absences = await response.json(); absencesTableBody.innerHTML = ''; if (absences.length === 0) { absencesTableBody.innerHTML = `<tr><td colspan="5">Keine Abwesenheiten für ${employeeName} erfasst.</td></tr>`; return; } absences.forEach(absence => { const row = absencesTableBody.insertRow(); let displayDate = absence.date; try { displayDate = new Date(absence.date + 'T00:00:00Z').toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' }); } catch(e) { console.warn("Datumsformat Fehler (Absence):", absence.date); } let absenceTypeText = absence.absence_type; switch(absence.absence_type) { case 'VACATION': absenceTypeText = 'Urlaub'; break; case 'SICK': absenceTypeText = 'Krankheit'; break; case 'PUBLIC_HOLIDAY': absenceTypeText = 'Feiertag'; break; } row.innerHTML = `<td>${displayDate}</td> <td>${absenceTypeText}</td> <td>${(absence.credited_hours || 0).toFixed(2)}</td> <td>${absence.comment || ''}</td> <td><button onclick="deleteAbsence(${absence.id}, ${employeeId}, '${employeeName}')" style="color: red; padding: 5px 10px;">Löschen</button></td>`; }); } catch (error) { console.error(`Fehler Laden Abw. MA ID ${employeeId}:`, error); absencesTableBody.innerHTML = `<tr><td colspan="5" style="color: red;">❌ Fehler Laden: ${error.message}</td></tr>`; } }
     async function handleAddAbsence(event) { event.preventDefault(); const employeeId = addAbsenceEmployeeIdInput.value; const date = addAbsenceDateInput.value; const absenceType = addAbsenceTypeSelect.value; const comment = addAbsenceCommentInput.value; const employeeName = absenceEmployeeSelect.options[absenceEmployeeSelect.selectedIndex].text; if (!employeeId || !date || !absenceType) { alert("Mitarbeiter, Datum und Typ angeben."); return; } addAbsenceSubmitBtn.disabled = true; try { const response = await fetch('/admin/absences', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ employeeId, date, absenceType, comment }), credentials: 'include' }); const resultText = await response.text(); let resultJson = null; try { resultJson = JSON.parse(resultText); } catch(e) {} if (response.ok && resultJson) { let displayDateAlert = resultJson.date; try { displayDateAlert = new Date(resultJson.date+'T00:00:00Z').toLocaleDateString('de-DE',{timeZone:'UTC'}); } catch(e) {} alert(`✅ Abwesenheit (${resultJson.absence_type} am ${displayDateAlert}) gespeichert.`); addAbsenceForm.reset(); addAbsenceTypeSelect.value = ""; addAbsenceEmployeeIdInput.value = employeeId; loadAbsences(employeeId, employeeName); } else { const errorMessage = resultJson?.message || resultText || `HTTP Status ${response.status}`; alert(`❌ Fehler Speichern: ${errorMessage}`); } } catch (error) { console.error("Netzwerk/JSON Fehler Hinzufügen Abw.:", error); alert("❌ Netzwerkfehler/Serverproblem."); } finally { if(addAbsenceEmployeeIdInput.value) { addAbsenceSubmitBtn.disabled = false; } } }
     async function deleteAbsence(absenceId, employeeId, employeeName) { if (!confirm(`Abwesenheitseintrag (ID: ${absenceId}) löschen?`)) return; try { const response = await fetch(`/admin/absences/${absenceId}`, { method: 'DELETE', credentials: 'include' }); if (response.ok) { alert("✅ Abwesenheit gelöscht."); loadAbsences(employeeId, employeeName); } else { const errorText = await response.text().catch(() => `HTTP Status ${response.status}`); alert(`❌ Fehler Löschen: ${errorText}`); } } catch (error) { console.error(`Fehler Löschen Abw. ${absenceId}:`, error); alert("❌ Netzwerkfehler."); } }

    // === Auswertungen (Monat/Quartal/Jahr) ===
    // handlePeriodTypeChange, handleCalculateBalance
    // (Funktionen leicht angepasst für PDF Button Steuerung)
    function handlePeriodTypeChange() {
        const selectedType = periodTypeSelect.value;
        const pdfButton = downloadPdfBtn;

        // Felder ein/ausblenden
        monthSelectDiv.classList.toggle('hidden', selectedType !== 'MONTH');
        quarterSelectDiv.classList.toggle('hidden', selectedType !== 'QUARTER');
        balanceMonthInput.required = (selectedType === 'MONTH');
        balanceQuarterSelect.required = (selectedType === 'QUARTER');

        // *** GEÄNDERT: PDF Button immer aktivieren ***
        pdfButton.disabled = false;
        if (selectedType === 'MONTH') {
            pdfButton.title = "Monatsauswertung als PDF herunterladen";
        } else if (selectedType === 'QUARTER') {
            pdfButton.title = "Quartalsauswertung als PDF herunterladen";
        } else { // YEAR
             pdfButton.title = "Jahresauswertung als PDF herunterladen";
        }
        // *** ENDE ÄNDERUNG ***

        balanceResultDiv.innerHTML = ''; // Ergebnis leeren
    }
    // handleCalculateBalance (unverändert von letzter korrekter Version)
    async function handleCalculateBalance(e) { e.preventDefault(); const employeeId = balanceNameSelect.value; const name = balanceNameSelect.options[balanceNameSelect.selectedIndex].text; const year = balanceYearInput.value; const selectedType = periodTypeSelect.value; let month = null, quarter = null, valid = true, url = ''; if (!employeeId) { alert("Bitte Mitarbeiter auswählen."); valid = false; } if (!year || isNaN(parseInt(year))) { alert("Gültiges Jahr eingeben."); valid = false; } if (selectedType === 'MONTH') { month = balanceMonthInput.value; if (!month || isNaN(parseInt(month)) || month < 1 || month > 12) { alert("Gültigen Monat (1-12) eingeben."); valid = false; } else { url = `/calculate-monthly-balance?name=${encodeURIComponent(name)}&year=${year}&month=${month}`; } } else if (selectedType === 'QUARTER') { quarter = balanceQuarterSelect.value; if (!quarter) { alert("Quartal auswählen."); valid = false; } else { url = `/calculate-period-balance?name=${encodeURIComponent(name)}&year=${year}&periodType=QUARTER&periodValue=${quarter}`; } } else { url = `/calculate-period-balance?name=${encodeURIComponent(name)}&year=${year}&periodType=YEAR`; } if (!valid) return; balanceResultDiv.innerHTML = "Berechnung läuft..."; try { const response = await fetch(url, { credentials: "include" }); if (!response.ok) { const errorText = await response.text().catch(() => `HTTP Status ${response.status}`); throw new Error(`Fehler ${response.status}: ${errorText}`); } const data = await response.json(); let html = ''; if (selectedType === 'MONTH') { html = `<h3>Monatsauswertung für ${data.employeeName || name} (${String(data.month).padStart(2,'0')}/${data.year})</h3>`; if (data.previousCarryOver !== undefined) { html += `<p>Übertrag Vormonat: <strong>${data.previousCarryOver.toFixed(2)} Std.</strong></p><p>Soll (Monat): <strong>${data.totalExpected.toFixed(2)} Std.</strong></p><p>Ist (Monat): <strong>${data.totalActual.toFixed(2)} Std.</strong> (Gearbeitet: ${data.workedHours?.toFixed(2) || '0.00'} Std., Abwesenheit: ${data.absenceHours?.toFixed(2) || '0.00'} Std.)</p><p>Differenz (Monat): <strong>${(data.totalActual - data.totalExpected).toFixed(2)} Std.</strong></p><hr><p>Neuer Übertrag: <strong>${data.newCarryOver.toFixed(2)} Std.</strong></p>`; } else if (data.message) { html += `<p>${data.message}</p>`; } else { html += `<p style="color:orange;">Keine Daten.</p>`; } } else { const periodLabel = data.periodIdentifier || (selectedType === 'QUARTER' ? `Q${quarter}` : 'Jahr'); const startDateFormatted = new Date(data.periodStartDate + 'T00:00:00Z').toLocaleDateString('de-DE', { timeZone: 'UTC' }); const endDateFormatted = new Date(data.periodEndDate + 'T00:00:00Z').toLocaleDateString('de-DE', { timeZone: 'UTC' }); html = `<h3>Auswertung ${periodLabel} für ${data.employeeName || name} (${data.year})</h3><p>Zeitraum: ${startDateFormatted} - ${endDateFormatted}</p>`; if (data.startingBalance !== undefined) { html += `<p>Übertrag Periodenbeginn: <strong>${data.startingBalance.toFixed(2)} Std.</strong></p><p>Soll (${periodLabel}): <strong>${data.totalExpectedPeriod.toFixed(2)} Std.</strong></p><p>Ist (${periodLabel}): <strong>${data.totalActualPeriod.toFixed(2)} Std.</strong> (Gearbeitet: ${data.workedHoursPeriod?.toFixed(2) || '0.00'} Std., Abwesenheit: ${data.absenceHoursPeriod?.toFixed(2) || '0.00'} Std.)</p><p>Differenz (${periodLabel}): <strong>${data.periodDifference.toFixed(2)} Std.</strong></p><hr><p>Neuer Übertrag Periodenende: <strong>${data.endingBalancePeriod.toFixed(2)} Std.</strong></p>`; } else if (data.message) { html += `<p>${data.message}</p>`; } else { html += `<p style="color:orange;">Keine Daten.</p>`; } } balanceResultDiv.innerHTML = html; } catch (error) { console.error(`Fehler ${selectedType}-Auswertung:`, error); balanceResultDiv.innerHTML = `<p style="color:red;">Fehler Berechnung: ${error.message}</p>`; } }
    // --- PDF DOWNLOAD (Jetzt für alle Zeiträume) ---
    function handleDownloadPdf() {
      const selectedType = periodTypeSelect.value;
      const employeeId = balanceNameSelect.value;
      const name = balanceNameSelect.options[balanceNameSelect.selectedIndex].text;
      const year = balanceYearInput.value;

      let pdfUrl = '';
      let valid = true;

      // Validierung der Basisfelder
      if (!employeeId || !name || name === 'Bitte auswählen' || !year || isNaN(parseInt(year))) {
        alert("Bitte wählen Sie einen Mitarbeiter aus und geben Sie ein gültiges Jahr ein.");
        return;
      }

      // URL basierend auf Zeitraum bauen
      if (selectedType === 'MONTH') {
          const month = balanceMonthInput.value;
          if (!month || isNaN(parseInt(month)) || month < 1 || month > 12) {
              alert("Bitte geben Sie einen gültigen Monat (1-12) ein.");
              valid = false;
          } else {
              // Wichtig: Der Endpunkt erwartet den Namen
              pdfUrl = `/api/pdf/create-monthly-pdf?name=${encodeURIComponent(name)}&year=${year}&month=${month}`;
          }
      } else if (selectedType === 'QUARTER') {
          const quarter = balanceQuarterSelect.value;
          if (!quarter) {
              alert("Bitte wählen Sie ein Quartal aus.");
              valid = false;
          } else {
              // Der neue Endpunkt erwartet den Namen
              pdfUrl = `/api/pdf/create-period-pdf?name=${encodeURIComponent(name)}&year=${year}&periodType=QUARTER&periodValue=${quarter}`;
          }
      } else { // YEAR
           // Der neue Endpunkt erwartet den Namen
           pdfUrl = `/api/pdf/create-period-pdf?name=${encodeURIComponent(name)}&year=${year}&periodType=YEAR`;
      }

      if (!valid) return; // Abbruch, wenn spezifische Validierung fehlschlägt

      // PDF in neuem Tab öffnen
      if (pdfUrl) {
          console.log("Öffne PDF URL:", pdfUrl);
          window.open(pdfUrl, '_blank');
      } else {
          // Sollte nicht passieren wegen Validierung, aber sicher ist sicher
          console.error("Konnte PDF URL nicht bauen für Typ:", selectedType);
          alert("Ein Fehler ist aufgetreten. PDF URL konnte nicht erstellt werden.");
      }
    }
    // --- ENDE PDF DOWNLOAD ---

  </script>
</body>
</html>
