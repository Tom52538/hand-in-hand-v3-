<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbeitszeiterfassung</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Stile wie zuletzt definiert */
    .hidden { display: none; }
    .booking-row { margin-bottom: 0.5rem; }
    .table-wrapper { overflow-x: auto; margin-bottom: 1rem; }
    .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f9f9f9; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    h1, h2, h3 { color: #333; }
    button { padding: 10px 15px; cursor: pointer; margin-top: 5px; margin-right: 5px;}
    button:disabled { cursor: not-allowed; background-color: #ccc; border-color: #bbb; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: middle; }
    input[readonly] { background-color: #e9e9e9; cursor: default; }
    .tabs { list-style: none; padding: 0; margin: 0 0 1rem 0; display: flex; flex-wrap: wrap; border-bottom: 1px solid #ccc; }
    .tabs li { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; margin-right: 5px; margin-bottom: -1px; background: #f1f1f1; border-radius: 4px 4px 0 0; }
    .tabs li.active { background: #fff; font-weight: bold; border-bottom: 1px solid #fff; }
    .tab-content { border: 1px solid #ccc; padding: 20px; background: #fff; border-radius: 0 0 4px 4px; border-top: none; margin-bottom: 2rem; }
    #balanceForm label, #addAbsenceForm label, #addEmployeeForm label, #editEmployeeForm label, #editForm label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
    #balanceForm select, #balanceForm input[type="number"],
    #addAbsenceForm select, #addAbsenceForm input[type="date"], #addAbsenceForm input[type="text"],
    #addEmployeeForm input, #editEmployeeForm input, #editForm input { width: calc(100% - 18px); padding: 8px; margin-bottom: 0.8rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
     #balanceForm > div, #addAbsenceForm > div, #addEmployeeForm > div, #editEmployeeForm > div, #editForm > div { margin-bottom: 1rem; }
     #addAbsenceForm { border: 1px solid #eee; padding: 15px; margin-top: 1.5rem; background-color: #fdfdfd; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbeitszeiterfassung</h1>

    <form id="workHoursForm">
      <div><label for="employeeSelect">Mitarbeiter:</label><select id="employeeSelect" name="employeeSelect" required><option value="">Bitte auswählen</option></select></div>
      <div><button type="button" id="workTimeBtn" disabled>Arbeitsbeginn buchen</button></div>
      <div id="bookingDetails" class="booking-details">
         <div class="booking-row"><label for="displayDate">Datum:</label><input type="text" id="displayDate" readonly></div>
         <div class="booking-row"><label for="displayStartTime">Arbeitsbeginn:</label><input type="text" id="displayStartTime" readonly></div>
         <div class="booking-row"><label for="displayEndTime">Arbeitsende:</label><input type="text" id="displayEndTime" readonly></div>
         <div id="summaryHours" class="hidden"><div class="booking-row"><label>Arbeitszeit Tag:</label><span id="dailyTotalHours">--</span></div><div class="booking-row"><label>Arbeitszeit Monat:</label><span id="monthlyTotalHours">--</span></div></div>
       </div>
    </form>
    <hr>
    <h2>Admin Login</h2>
    <form id="adminLoginForm"><div><label for="adminPassword">Passwort:</label><input type="password" id="adminPassword" name="adminPassword" required></div><button type="submit">Anmelden</button></form>
    <div id="adminTabs" class="hidden">
      <ul class="tabs">
        <li data-tab="workhours" class="active">Arbeitszeiten</li><li data-tab="employees">Mitarbeiter</li><li data-tab="absences">Abwesenheiten</li><li data-tab="reports">Auswertungen</li>
      </ul>
      <div id="tab-workhours" class="tab-content">
        <h2>Arbeitszeiten verwalten</h2>
        <div class="table-wrapper">
          <table id="workHoursTable"> <thead>
              <tr>
                <th>ID</th><th>Name</th><th>Datum</th><th>Arbeitszeit</th><th>Stunden</th><th>Bemerkungen</th><th>Aktionen</th>
              </tr>
            </thead>
            <tbody></tbody> </table>
        </div>
        <button id="adminDownloadCsv">CSV herunterladen</button> <button id="adminDeleteData" style="color: red;">Alle Daten löschen (Vorsicht!)</button> <hr>
        <div id="editWorkHoursSection" class="hidden">
          <h3>Datensatz bearbeiten</h3>
          <form id="editForm">
             <input type="hidden" id="editId" name="id">
             <div><label for="editName">Name:</label><input type="text" id="editName" name="name" required></div>
             <div><label for="editDate">Datum:</label><input type="date" id="editDate" name="date" required></div>
             <div><label for="editStartTime">Arbeitsbeginn:</label><input type="time" id="editStartTime" name="startTime" required></div>
             <div><label for="editEndTime">Arbeitsende:</label><input type="time" id="editEndTime" name="endTime" required></div>
             <div><label for="editComment">Bemerkungen:</label><input type="text" id="editComment" name="comment"></div>
             <button type="button" onclick="saveChanges()">Speichern</button>
             <button type="button" onclick="cancelEditWorkHours()">Abbrechen</button>
           </form>
        </div>
      </div>
      <div id="tab-employees" class="tab-content hidden">
        <h2>Mitarbeiterverwaltung</h2>
        <h3>Aktuelle Mitarbeiter</h3>
        <ul id="employeeList"></ul><hr>
        <div id="addEmployeeSection">
          <form id="addEmployeeForm"> <h3>Mitarbeiter hinzufügen</h3>
             <div><label for="employeeName">Name:</label><input type="text" id="employeeName" name="employeeName" required></div>
             <div><label for="mo_hours">Mo (Soll):</label><input type="number" id="mo_hours" name="mo_hours" step="0.1" value="0" min="0"></div>
             <div><label for="di_hours">Di (Soll):</label><input type="number" id="di_hours" name="di_hours" step="0.1" value="0" min="0"></div>
             <div><label for="mi_hours">Mi (Soll):</label><input type="number" id="mi_hours" name="mi_hours" step="0.1" value="0" min="0"></div>
             <div><label for="do_hours">Do (Soll):</label><input type="number" id="do_hours" name="do_hours" step="0.1" value="0" min="0"></div>
             <div><label for="fr_hours">Fr (Soll):</label><input type="number" id="fr_hours" name="fr_hours" step="0.1" value="0" min="0"></div>
             <button type="submit">Hinzufügen</button>
           </form>
        </div>
        <div id="editEmployeeSection" class="hidden">
          <form id="editEmployeeForm">
            <hr><h3>Mitarbeiter bearbeiten</h3>
             <input type="hidden" id="editEmployeeId" name="id">
             <div><label for="editEmployeeName">Name:</label><input type="text" id="editEmployeeName" name="name" required></div>
             <div><label for="editMoHours">Mo (Soll):</label><input type="number" id="editMoHours" name="mo_hours" step="0.1" value="0" min="0"></div>
             <div><label for="editDiHours">Di (Soll):</label><input type="number" id="editDiHours" name="di_hours" step="0.1" value="0" min="0"></div>
             <div><label for="editMiHours">Mi (Soll):</label><input type="number" id="editMiHours" name="mi_hours" step="0.1" value="0" min="0"></div>
             <div><label for="editDoHours">Do (Soll):</label><input type="number" id="editDoHours" name="do_hours" step="0.1" value="0" min="0"></div>
             <div><label for="editFrHours">Fr (Soll):</label><input type="number" id="editFrHours" name="fr_hours" step="0.1" value="0" min="0"></div>
             <button type="button" onclick="saveEmployeeChanges()">Speichern</button>
             <button type="button" onclick="cancelEditEmployee()">Abbrechen</button>
           </form>
        </div>
      </div>
      <div id="tab-absences" class="tab-content hidden">
          <h2>Abwesenheiten verwalten</h2>
          <div><label for="absenceEmployeeSelect">Mitarbeiter:</label><select id="absenceEmployeeSelect" name="absenceEmployeeSelect" required><option value="">Wählen...</option></select></div><hr> <h3>Erfasste Abwesenheiten</h3>
          <div class="table-wrapper"><table id="absencesTable"><thead><tr><th>Datum</th><th>Typ</th><th>Std.</th><th>Kommentar</th><th>Aktion</th></tr></thead><tbody><tr><td colspan="5">Mitarbeiter wählen.</td></tr></tbody></table></div><hr> <form id="addAbsenceForm"> <h3>Neue Abwesenheit</h3>
              <input type="hidden" id="addAbsenceEmployeeId" name="employeeId">
              <div><label for="addAbsenceDate">Datum:</label><input type="date" id="addAbsenceDate" name="date" required></div>
              <div><label for="addAbsenceType">Typ:</label><select id="addAbsenceType" name="absenceType" required><option value="">Wählen...</option><option value="VACATION">Urlaub</option><option value="SICK">Krank</option><option value="PUBLIC_HOLIDAY">Feiertag</option></select></div> <div><label for="addAbsenceComment">Kommentar:</label><input type="text" id="addAbsenceComment" name="comment"></div>
              <button type="submit" id="addAbsenceSubmitBtn" disabled>Speichern</button> <small id="absenceFormNote" style="display: block; margin-top: 5px;">Mitarbeiter wählen.</small> </form>
      </div>
      <div id="tab-reports" class="tab-content hidden">
        <h2>Auswertungen</h2>
        <form id="balanceForm"> <div><label for="balanceName">Mitarbeiter:</label><select id="balanceName" name="balanceName" required><option value="">Wählen...</option></select></div> <div><label for="balanceYear">Jahr:</label><input type="number" id="balanceYear" name="balanceYear" required></div>
          <div><label for="periodTypeSelect">Zeitraum:</label><select id="periodTypeSelect" name="periodType" required><option value="MONTH" selected>Monat</option><option value="QUARTER">Quartal</option><option value="YEAR">Jahr</option></select></div> <div id="monthSelectDiv"><label for="balanceMonth">Monat:</label><input type="number" id="balanceMonth" name="balanceMonth" required min="1" max="12"></div> <div id="quarterSelectDiv" class="hidden"><label for="balanceQuarter">Quartal:</label><select id="balanceQuarter" name="balanceQuarter" required><option value="1">Q1</option><option value="2">Q2</option><option value="3">Q3</option><option value="4">Q4</option></select></div> <button type="submit">Berechnen</button>
        </form><br>
        <button id="downloadPdfBtn" disabled>PDF</button> <div id="balanceResult" style="margin-top: 1rem;"></div> </div>
    </div>
  </div>
  <script>
    // Globale Variablen
    let currentWorkEntryId = null;
    // ==== DOM-Referenzen ====
    const employeeSelect = document.getElementById('employeeSelect');
    const workTimeBtn = document.getElementById('workTimeBtn');
    const displayDateInput = document.getElementById('displayDate');
    const displayStartTimeInput = document.getElementById('displayStartTime');
    const displayEndTimeInput = document.getElementById('displayEndTime');
    const summaryHoursDiv = document.getElementById('summaryHours');
    const dailyTotalHoursSpan = document.getElementById('dailyTotalHours');
    const monthlyTotalHoursSpan = document.getElementById('monthlyTotalHours');
    // Auswertungsformular
    const balanceForm = document.getElementById('balanceForm');
    const balanceNameSelect = document.getElementById('balanceName');
    const balanceYearInput = document.getElementById('balanceYear');
    const periodTypeSelect = document.getElementById('periodTypeSelect');
    const monthSelectDiv = document.getElementById('monthSelectDiv');
    const balanceMonthInput = document.getElementById('balanceMonth');
    const quarterSelectDiv = document.getElementById('quarterSelectDiv');
    const balanceQuarterSelect = document.getElementById('balanceQuarter');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const balanceResultDiv = document.getElementById('balanceResult');
    // Abwesenheits-Tab Elemente
    const absenceEmployeeSelect = document.getElementById('absenceEmployeeSelect');
    const absencesTableBody = document.querySelector('#absencesTable tbody'); // Korrigiert: querySelector
    const addAbsenceForm = document.getElementById('addAbsenceForm');
    const addAbsenceEmployeeIdInput = document.getElementById('addAbsenceEmployeeId');
    const addAbsenceDateInput = document.getElementById('addAbsenceDate');
    const addAbsenceTypeSelect = document.getElementById('addAbsenceType');
    const addAbsenceCommentInput = document.getElementById('addAbsenceComment');
    const addAbsenceSubmitBtn = document.getElementById('addAbsenceSubmitBtn');
    const absenceFormNote = document.getElementById('absenceFormNote');
    // Admin Tab Elemente (für Listener benötigt)
    const adminDownloadCsvBtn = document.getElementById('adminDownloadCsv');
    const adminDeleteDataBtn = document.getElementById('adminDeleteData');
    const addEmployeeFormElement = document.getElementById('addEmployeeForm'); // Explizite Referenz für Listener
    const adminLoginFormElement = document.getElementById('adminLoginForm'); // Explizite Referenz


    // ==== Initialisierung ====
    document.addEventListener('DOMContentLoaded', () => {
      resetWorkTimeForm();
      loadEmployeeOptions();
      setupEventListeners();
      const now = new Date();
      if(balanceYearInput) balanceYearInput.value = now.getFullYear(); // Prüfe ob Element existiert
      if(balanceMonthInput) balanceMonthInput.value = now.getMonth() + 1;
      if(periodTypeSelect) periodTypeSelect.value = 'MONTH';
      handlePeriodTypeChange();
    });

    // ==== Event Listener Setup ====
    function setupEventListeners() {
        // Event Listener nur hinzufügen, wenn die Elemente existieren
        // Dies verhindert Fehler, falls HTML unvollständig geladen wurde oder IDs falsch sind.

        if (employeeSelect) employeeSelect.addEventListener('change', handleEmployeeSelection); else console.error("Element not found: employeeSelect");
        if (workTimeBtn) workTimeBtn.addEventListener('click', handleWorkTimeToggle); else console.error("Element not found: workTimeBtn");
        if (adminLoginFormElement) adminLoginFormElement.addEventListener('submit', handleAdminLogin); else console.error("Element not found: adminLoginForm");

        document.querySelectorAll('.tabs li').forEach(tab => {
            if(tab) tab.addEventListener('click', handleTabSwitch); else console.error("Element not found: .tabs li");
        });

        if (adminDownloadCsvBtn) adminDownloadCsvBtn.addEventListener('click', downloadAdminCsv); else console.error("Element not found: adminDownloadCsv");
        if (adminDeleteDataBtn) adminDeleteDataBtn.addEventListener('click', deleteAllWorkHours); else console.error("Element not found: adminDeleteData");
        if (addEmployeeFormElement) addEmployeeFormElement.addEventListener('submit', handleAddEmployee); else console.error("Element not found: addEmployeeForm");
        if (balanceForm) balanceForm.addEventListener('submit', handleCalculateBalance); else console.error("Element not found: balanceForm");
        if (periodTypeSelect) periodTypeSelect.addEventListener('change', handlePeriodTypeChange); else console.error("Element not found: periodTypeSelect");
        if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', handleDownloadPdf); else console.error("Element not found: downloadPdfBtn");

        // Listener für Abwesenheiten (mit Prüfung)
        if (absenceEmployeeSelect) absenceEmployeeSelect.addEventListener('change', handleAbsenceEmployeeSelectChange); else console.error("Element not found: absenceEmployeeSelect");
        if (addAbsenceForm) addAbsenceForm.addEventListener('submit', handleAddAbsence); else console.error("Element not found: addAbsenceForm");
    }


    // ==== Funktionen Zeiterfassung (Benutzer) ====
    async function loadEmployeeOptions() {
      try {
        const response = await fetch('/employees');
        if (!response.ok) throw new Error(`Ladefehler (${response.status}).`);
        const employees = await response.json();

        // Funktion zum Befüllen von Select-Dropdowns (jetzt mit Prüfung)
        const populateSelect = (selectElement, useIdAsValue) => {
            if (!selectElement) {
                console.error("populateSelect: Select element is null!");
                return; // Frühzeitiger Ausstieg, wenn Element nicht gefunden wurde
            }
            selectElement.innerHTML = '<option value="">Bitte auswählen</option>';
            employees.forEach(emp => {
              const option = document.createElement('option');
              option.value = useIdAsValue ? emp.id : emp.name; // ID oder Name als Value
              option.textContent = emp.name;
              selectElement.appendChild(option);
            });
        };

        // Haupt-Dropdown (Value = Name)
        populateSelect(employeeSelect, false);

        // Admin Dropdowns (Value = ID)
        populateSelect(balanceNameSelect, true);
        populateSelect(absenceEmployeeSelect, true);

      } catch (err) {
        console.error("Fehler Laden MA-Optionen:", err);
        const errorMsg = '<option value="">Fehler</option>';
        // Setze Fehler nur, wenn Element existiert
        if(employeeSelect) employeeSelect.innerHTML = errorMsg;
        if(balanceNameSelect) balanceNameSelect.innerHTML = errorMsg;
        if(absenceEmployeeSelect) absenceEmployeeSelect.innerHTML = errorMsg;
        alert("❌ Mitarbeiterliste Ladefehler: " + err.message);
      }
    }
    // handleEmployeeSelection, checkNextBookingAction, handleWorkTimeToggle, displaySummaryHours, resetWorkTimeForm, resetBookingDetails
     function handleEmployeeSelection() { checkNextBookingAction(); }
     async function checkNextBookingAction() { const name = employeeSelect.value; resetBookingDetails(); workTimeBtn.disabled = true; currentWorkEntryId = null; if (!name) return; try { const response = await fetch(`/next-booking-details?name=${encodeURIComponent(name)}`); if (!response.ok) throw new Error(`Fehler ${response.status}.`); const data = await response.json(); if (data.nextBooking === 'arbeitsende') { workTimeBtn.textContent = 'Arbeitsende buchen'; workTimeBtn.style.backgroundColor = 'orange'; currentWorkEntryId = data.id; workTimeBtn.disabled = false; if (data.startDate) { try { const dateObj = new Date(data.startDate + 'T00:00:00Z'); displayDateInput.value = dateObj.toLocaleDateString('de-DE', { timeZone: 'UTC' }); } catch(e) { displayDateInput.value = data.startDate; } } displayStartTimeInput.value = data.startTime ? data.startTime + " Uhr" : ''; displayEndTimeInput.value = ''; } else { workTimeBtn.textContent = 'Arbeitsbeginn buchen'; workTimeBtn.style.backgroundColor = ''; workTimeBtn.disabled = false; } } catch (error) { console.error("Fehler '/next-booking-details':", error); alert("❌ Fehler Buchungsstatus: " + error.message); } }
     async function handleWorkTimeToggle() { const name = employeeSelect.value; if (!name) return; const action = workTimeBtn.textContent.includes('Arbeitsbeginn') ? 'start' : 'end'; const now = new Date(); const date = now.toISOString().split("T")[0]; const time = now.toTimeString().slice(0, 5); const displayDate = now.toLocaleDateString('de-DE'); workTimeBtn.disabled = true; if (action === 'start') { try { const response = await fetch("/log-start", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, date, startTime: time }) }); if (response.ok) { const result = await response.json(); alert("✅ Arbeitsbeginn gebucht."); displayDateInput.value = displayDate; displayStartTimeInput.value = time + " Uhr"; displayEndTimeInput.value = ''; summaryHoursDiv.classList.add('hidden'); currentWorkEntryId = result.id; } else { const result = await response.json().catch(() => ({ message: 'Unbekannter Fehler.' })); alert("❌ Fehler Arbeitsbeginn: " + (result.message || response.statusText)); } } catch (err) { console.error("Fehler Arbeitsbeginn:", err); alert("❌ Netzwerkfehler!"); } finally { workTimeBtn.disabled = false; checkNextBookingAction(); } } else { if (!currentWorkEntryId) { alert("Fehler: Keine ID für offenen Eintrag."); workTimeBtn.disabled = false; checkNextBookingAction(); return; } try { const response = await fetch(`/log-end/${currentWorkEntryId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ endTime: time, comment: "" }) }); if (response.ok) { alert("✅ Arbeitsende gebucht."); displayEndTimeInput.value = time + " Uhr"; currentWorkEntryId = null; displaySummaryHours(name, date); } else { const result = await response.json().catch(() => ({ message: 'Unbekannter Fehler.' })); alert("❌ Fehler Arbeitsende: " + (result.message || response.statusText)); } } catch (err) { console.error("Fehler Arbeitsende:", err); alert("❌ Netzwerkfehler!"); } finally { workTimeBtn.disabled = false; checkNextBookingAction(); } } }
     async function displaySummaryHours(employeeName, dayDate) { if (!employeeName || !dayDate) return; summaryHoursDiv.classList.add('hidden'); dailyTotalHoursSpan.textContent = 'lade...'; monthlyTotalHoursSpan.textContent = 'lade...'; try { let queryDate = dayDate; if (!/^\d{4}-\d{2}-\d{2}$/.test(dayDate)) { try { const dateParts = dayDate.split('.'); queryDate = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`; } catch(e){ console.error("Konnte Datum nicht parsen:", dayDate); queryDate = new Date().toISOString().split('T')[0]; } } const response = await fetch(`/summary-hours?name=${encodeURIComponent(employeeName)}&date=${queryDate}`); if (!response.ok) throw new Error(`Fehler ${response.status}.`); const summary = await response.json(); dailyTotalHoursSpan.textContent = `${summary.dailyHours ? summary.dailyHours.toFixed(2) : '0.00'} Std.`; monthlyTotalHoursSpan.textContent = `${summary.monthlyHours ? summary.monthlyHours.toFixed(2) : '0.00'} Std.`; summaryHoursDiv.classList.remove('hidden'); } catch (error) { console.error("Fehler Zusammenfassung:", error); dailyTotalHoursSpan.textContent = 'Fehler'; monthlyTotalHoursSpan.textContent = 'Fehler'; summaryHoursDiv.classList.remove('hidden'); } }
     function resetWorkTimeForm() { employeeSelect.value = ''; workTimeBtn.textContent = 'Arbeitsbeginn buchen'; workTimeBtn.style.backgroundColor = ''; workTimeBtn.disabled = true; resetBookingDetails(); }
     function resetBookingDetails() { displayDateInput.value = ''; displayStartTimeInput.value = ''; displayEndTimeInput.value = ''; summaryHoursDiv.classList.add('hidden'); dailyTotalHoursSpan.textContent = '--'; monthlyTotalHoursSpan.textContent = '--'; currentWorkEntryId = null; }

    // ==== Admin-Funktionen ====
    // handleAdminLogin, handleTabSwitch, loadEmployeeOptionsForReports, loadEmployeeOptionsForAbsences
    async function handleAdminLogin(e) { e.preventDefault(); const password = document.getElementById("adminPassword").value; try { const response = await fetch("/admin-login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ password }), credentials: "include" }); if (response.ok) { alert("✅ Admin angemeldet."); document.getElementById("adminPassword").value = ""; document.getElementById("adminTabs").classList.remove("hidden"); document.getElementById("adminLoginForm").classList.add("hidden"); loadAdminWorkHours(); } else { const result = await response.text(); alert("❌ Login fehlgeschlagen: " + response.status + " – " + result); } } catch (error) { console.error("❌ Netzwerkfehler Admin-Login:", error); alert("❌ Netzwerkfehler."); } }
    function handleTabSwitch(event) { const clickedTab = event.currentTarget; document.querySelectorAll(".tabs li").forEach(t => t.classList.remove("active")); document.querySelectorAll(".tab-content").forEach(tc => tc.classList.add("hidden")); clickedTab.classList.add("active"); const targetContentId = "tab-" + clickedTab.getAttribute("data-tab"); const targetContent = document.getElementById(targetContentId); if (targetContent) { targetContent.classList.remove("hidden"); if (targetContentId === 'tab-workhours') loadAdminWorkHours(); if (targetContentId === 'tab-employees') loadEmployees(); if (targetContentId === 'tab-absences') { loadEmployeeOptionsForAbsences(); if(absencesTableBody) absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>'; if(addAbsenceSubmitBtn) addAbsenceSubmitBtn.disabled = true; if(absenceFormNote) absenceFormNote.classList.remove('hidden'); if(addAbsenceForm) addAbsenceForm.reset(); } if (targetContentId === 'tab-reports') loadEmployeeOptionsForReports(); } }
    function loadEmployeeOptionsForReports() { console.log("Mitarbeiteroptionen für Auswertungen geprüft."); }
    function loadEmployeeOptionsForAbsences() { console.log("Mitarbeiteroptionen für Abwesenheiten geprüft."); }
    // loadAdminWorkHours, editEntry, cancelEditWorkHours, saveChanges, deleteEntry, downloadAdminCsv, deleteAllWorkHours
    async function loadAdminWorkHours() { const tbody = document.querySelector("#workHoursTable tbody"); if(!tbody) { console.error("Element not found: #workHoursTable tbody"); return; } tbody.innerHTML = "<tr><td colspan='7'>Lade Daten...</td></tr>"; try { const response = await fetch('/admin-work-hours', { credentials: "include" }); if (!response.ok) throw new Error(`Laden fehlgeschlagen (${response.status}).`); const data = await response.json(); tbody.innerHTML = ""; if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='7'>Keine Arbeitszeiten erfasst.</td></tr>"; return; } data.forEach(entry => { const row = document.createElement("tr"); const hours = parseFloat(entry.hours) || 0; let displayDate = 'N/A'; if (entry.date) { try { const dateObj = new Date(entry.date.split('T')[0] + 'T00:00:00Z'); displayDate = dateObj.toLocaleDateString("de-DE", { timeZone: 'UTC' }); } catch(e) { displayDate = entry.date; console.warn("Admin Datumsformat Fehler:", entry.date, e); } } row.innerHTML = `<td>${entry.id}</td><td>${entry.name || 'Unbekannt'}</td><td>${displayDate}</td><td>${entry.startTime || '--:--'} - ${entry.endTime || '--:--'}</td><td>${hours.toFixed(2)}</td><td>${entry.comment || ''}</td><td><button onclick='editEntry(${JSON.stringify(entry)})'>Bearbeiten</button> <button onclick="deleteEntry(${entry.id})">Löschen</button></td>`; tbody.appendChild(row); }); } catch (error) { console.error("Fehler Laden Admin-Arbeitszeiten:", error); tbody.innerHTML = `<tr><td colspan="7">❌ Fehler: ${error.message}</td></tr>`; } }
    function editEntry(entry) { document.getElementById("editId").value = entry.id; document.getElementById("editName").value = entry.name || ""; document.getElementById("editDate").value = entry.date ? entry.date.split("T")[0] : ""; document.getElementById("editStartTime").value = entry.startTime || ""; document.getElementById("editEndTime").value = entry.endTime || ""; document.getElementById("editComment").value = entry.comment || ""; document.getElementById("editWorkHoursSection").classList.remove("hidden"); document.getElementById("editWorkHoursSection").scrollIntoView({ behavior: "smooth" }); }
    function cancelEditWorkHours() { document.getElementById("editWorkHoursSection").classList.add("hidden"); document.getElementById("editForm").reset(); document.getElementById("editId").value = ""; }
    async function saveChanges() { const id = document.getElementById("editId").value; if (!id) return; const data = { id, name: document.getElementById("editName").value, date: document.getElementById("editDate").value, startTime: document.getElementById("editStartTime").value, endTime: document.getElementById("editEndTime").value, comment: document.getElementById("editComment").value }; if (!data.name || !data.date || !data.startTime || !data.endTime) { alert("Bitte alle erforderlichen Felder ausfüllen."); return; } try { const response = await fetch("/api/admin/update-hours", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data), credentials: "include" }); const result = await response.text(); if (response.ok) { alert("✅ Änderungen gespeichert."); cancelEditWorkHours(); loadAdminWorkHours(); } else { alert(`❌ Fehler Speichern (${response.status}): ${result}`); } } catch (error) { console.error("Fehler Speichern:", error); alert("❌ Netzwerkfehler."); } }
    async function deleteEntry(id) { if (!confirm(`Soll der Eintrag mit ID ${id} wirklich gelöscht werden?`)) return; try { const response = await fetch(`/api/admin/delete-hours/${id}`, { method: "DELETE", credentials: "include" }); const result = await response.text(); if (response.ok) { alert("✅ Eintrag gelöscht."); loadAdminWorkHours(); } else { alert(`❌ Fehler Löschen (${response.status}): ${result}`); } } catch (error) { console.error(`Fehler Löschen ${id}:`, error); alert("❌ Netzwerkfehler."); } }
    async function downloadAdminCsv() { window.open('/admin-download-csv', '_blank'); }
    async function deleteAllWorkHours() { if (!confirm('WARNUNG!\n\nAlle Arbeitszeiten, Monatsbilanzen UND Abwesenheiten unwiderruflich löschen?')) return; try { const response = await fetch('/adminDeleteData', { method: 'DELETE', credentials: 'include' }); const result = await response.text(); if (response.ok) { alert(`✅ ${result}`); loadAdminWorkHours(); if(balanceResultDiv) balanceResultDiv.innerHTML = ''; if(absencesTableBody) absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>'; } else { alert(`❌ Fehler Löschen (${response.status}): ${result}`); } } catch (error) { console.error('Fehler Löschen aller Daten:', error); alert('❌ Netzwerkfehler.'); } }

    // ==== Mitarbeiterverwaltung ====
    // loadEmployees, handleAddEmployee, editEmployee, cancelEditEmployee, saveEmployeeChanges, deleteEmployee
     async function loadEmployees() { const list = document.getElementById("employeeList"); if(!list) {console.error("Element not found: #employeeList"); return;} list.innerHTML = "<li>Lade MA...</li>"; try { const response = await fetch("/admin/employees", { credentials: "include" }); if (!response.ok) throw new Error(`Ladefehler (${response.status}).`); const data = await response.json(); list.innerHTML = ""; if (data.length > 0) { data.forEach(emp => { const li = document.createElement("li"); li.innerHTML = `<span>${emp.name} (Soll: Mo:${emp.mo_hours||0}, Di:${emp.di_hours||0}, Mi:${emp.mi_hours||0}, Do:${emp.do_hours||0}, Fr:${emp.fr_hours||0})</span> <div> <button onclick='editEmployee(${JSON.stringify(emp)})'>Bearbeiten</button> <button onclick="deleteEmployee(${emp.id}, '${emp.name}')">Löschen</button> </div>`; list.appendChild(li); }); } else { list.innerHTML = "<li>Keine MA angelegt.</li>"; } } catch (error) { console.error("Fehler Laden MA:", error); list.innerHTML = `<li>❌ Fehler: ${error.message}</li>`; } }
     async function handleAddEmployee(event) { event.preventDefault(); const form = event.target; const data = { name: form.employeeName.value.trim(), mo_hours: parseFloat(form.mo_hours.value) || 0, di_hours: parseFloat(form.di_hours.value) || 0, mi_hours: parseFloat(form.mi_hours.value) || 0, do_hours: parseFloat(form.do_hours.value) || 0, fr_hours: parseFloat(form.fr_hours.value) || 0 }; if (!data.name) { alert("Namen eingeben."); return; } try { const response = await fetch('/admin/employees', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), credentials: 'include' }); if (response.ok) { const result = await response.json(); alert(`✅ MA "${result.name}" hinzugefügt.`); form.reset(); loadEmployees(); loadEmployeeOptions(); } else { const errorText = await response.text().catch(() => response.statusText); alert(`❌ Fehler Hinzufügen (${response.status}): ${errorText}`); } } catch (error) { console.error('Fehler Hinzufügen MA:', error); alert('❌ Netzwerkfehler.'); } }
     function editEmployee(emp) { document.getElementById("editEmployeeId").value = emp.id; document.getElementById("editEmployeeName").value = emp.name; document.getElementById("editMoHours").value = emp.mo_hours || 0; document.getElementById("editDiHours").value = emp.di_hours || 0; document.getElementById("editMiHours").value = emp.mi_hours || 0; document.getElementById("editDoHours").value = emp.do_hours || 0; document.getElementById("editFrHours").value = emp.fr_hours || 0; document.getElementById("editEmployeeSection").classList.remove("hidden"); document.getElementById("addEmployeeSection").classList.add("hidden"); document.getElementById("editEmployeeSection").scrollIntoView({ behavior: "smooth" }); }
     function cancelEditEmployee() { document.getElementById("editEmployeeSection").classList.add("hidden"); document.getElementById("addEmployeeSection").classList.remove("hidden"); document.getElementById("editEmployeeForm").reset(); document.getElementById("editEmployeeId").value = ""; }
     async function saveEmployeeChanges() { const id = document.getElementById("editEmployeeId").value; if (!id) return; const data = { id, name: document.getElementById("editEmployeeName").value.trim(), mo_hours: parseFloat(document.getElementById("editMoHours").value) || 0, di_hours: parseFloat(document.getElementById("editDiHours").value) || 0, mi_hours: parseFloat(document.getElementById("editMiHours").value) || 0, do_hours: parseFloat(document.getElementById("editDoHours").value) || 0, fr_hours: parseFloat(document.getElementById("editFrHours").value) || 0 }; if (!data.name) { alert("Name darf nicht leer sein."); return; } try { const response = await fetch(`/admin/employees/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), credentials: 'include' }); const result = await response.text(); if (response.ok) { alert(`✅ MA-Daten aktualisiert.`); cancelEditEmployee(); loadEmployees(); loadEmployeeOptions(); } else { alert(`❌ Fehler Aktualisieren (${response.status}): ${result}`); } } catch (error) { console.error("Fehler Speichern MA:", error); alert("❌ Netzwerkfehler."); } }
     async function deleteEmployee(id, name) { if (!confirm(`MA "${name}" (ID: ${id}) und alle Daten löschen?`)) return; try { const response = await fetch(`/admin/employees/${id}`, { method: 'DELETE', credentials: 'include' }); const result = await response.text(); if (response.ok) { alert(`✅ MA "${name}" und Daten gelöscht.`); loadEmployees(); loadEmployeeOptions(); if(document.querySelector('#tab-workhours').classList.contains('active')) loadAdminWorkHours(); if(balanceResultDiv) balanceResultDiv.innerHTML = ''; if(absencesTableBody) absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>'; } else { alert(`❌ Fehler Löschen (${response.status}): ${result}`); } } catch (error) { console.error(`Fehler Löschen MA ${id}:`, error); alert("❌ Netzwerkfehler."); } }
    // === Funktionen für Abwesenheiten ===
    function handleAbsenceEmployeeSelectChange() {
        const selectedEmployeeId = absenceEmployeeSelect.value;
        const employeeName = absenceEmployeeSelect.options[absenceEmployeeSelect.selectedIndex]?.text || 'Unbekannt'; // Sicherer Zugriff

        // Prüfe, ob Elemente existieren, bevor darauf zugegriffen wird
        if (addAbsenceEmployeeIdInput) addAbsenceEmployeeIdInput.value = selectedEmployeeId;
        if (addAbsenceSubmitBtn) addAbsenceSubmitBtn.disabled = !selectedEmployeeId;
        if (absenceFormNote) absenceFormNote.classList.toggle('hidden', !!selectedEmployeeId);
        if (absencesTableBody) {
            if (selectedEmployeeId) {
                loadAbsences(selectedEmployeeId, employeeName);
            } else {
                absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>';
            }
        }
        if (addAbsenceForm) addAbsenceForm.reset();
        if (addAbsenceTypeSelect) addAbsenceTypeSelect.value = ""; // Typ explizit zurücksetzen
        if (addAbsenceEmployeeIdInput && selectedEmployeeId) addAbsenceEmployeeIdInput.value = selectedEmployeeId; // ID nach reset wieder setzen
    }

    async function loadAbsences(employeeId, employeeName) {
        if (!employeeId || !absencesTableBody) return; // Abbruch wenn ID oder Tabelle fehlt
        absencesTableBody.innerHTML = `<tr><td colspan="5">Lade Abwesenheiten für ${employeeName}...</td></tr>`;
        try {
            const response = await fetch(`/admin/absences?employeeId=${employeeId}`, { credentials: 'include' });
            if (!response.ok) throw new Error(`Fehler ${response.status}.`);
            const absences = await response.json();
            absencesTableBody.innerHTML = '';
            if (absences.length === 0) { absencesTableBody.innerHTML = `<tr><td colspan="5">Keine Abwesenheiten für ${employeeName} erfasst.</td></tr>`; return; }
            absences.forEach(absence => {
                const row = absencesTableBody.insertRow();
                let displayDate = absence.date; try { displayDate = new Date(absence.date + 'T00:00:00Z').toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' }); } catch(e) {}
                let typeText = absence.absence_type; switch(absence.absence_type) { case 'VACATION': typeText = 'Urlaub'; break; case 'SICK': typeText = 'Krank'; break; case 'PUBLIC_HOLIDAY': typeText = 'Feiertag'; break; }
                row.innerHTML = `<td>${displayDate}</td><td>${typeText}</td><td>${(absence.credited_hours || 0).toFixed(2)}</td><td>${absence.comment || ''}</td><td><button onclick="deleteAbsence(${absence.id}, ${employeeId}, '${employeeName}')" style="color:red;padding:5px 10px;">X</button></td>`; // Kleinerer Löschbutton
            });
        } catch (error) { console.error(`Fehler Laden Abw. MA ID ${employeeId}:`, error); absencesTableBody.innerHTML = `<tr><td colspan="5" style="color: red;">❌ Fehler: ${error.message}</td></tr>`; }
    }

    async function handleAddAbsence(event) {
        event.preventDefault();
        if(!addAbsenceEmployeeIdInput || !addAbsenceDateInput || !addAbsenceTypeSelect || !addAbsenceCommentInput || !absenceEmployeeSelect || !addAbsenceSubmitBtn) return; // Schutz

        const employeeId = addAbsenceEmployeeIdInput.value;
        const date = addAbsenceDateInput.value;
        const absenceType = addAbsenceTypeSelect.value;
        const comment = addAbsenceCommentInput.value;
        const employeeName = absenceEmployeeSelect.options[absenceEmployeeSelect.selectedIndex]?.text || 'Unbekannt';

        if (!employeeId || !date || !absenceType) { alert("Mitarbeiter, Datum und Typ angeben."); return; }
        addAbsenceSubmitBtn.disabled = true;
        try {
            const response = await fetch('/admin/absences', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ employeeId, date, absenceType, comment }), credentials: 'include' });
            const resultText = await response.text(); let resultJson = null; try { resultJson = JSON.parse(resultText); } catch(e) {}
            if (response.ok && resultJson) {
                let displayDateAlert = resultJson.date; try { displayDateAlert = new Date(resultJson.date+'T00:00:00Z').toLocaleDateString('de-DE',{timeZone:'UTC'}); } catch(e) {}
                alert(`✅ Abwesenheit (${resultJson.absence_type} am ${displayDateAlert}) gespeichert.`);
                addAbsenceForm.reset(); addAbsenceTypeSelect.value = ""; addAbsenceEmployeeIdInput.value = employeeId; // ID wieder setzen
                loadAbsences(employeeId, employeeName);
            } else { const errorMessage = resultJson?.message || resultText || `HTTP Status ${response.status}`; alert(`❌ Fehler Speichern: ${errorMessage}`); }
        } catch (error) { console.error("Netzwerk/JSON Fehler Hinzufügen Abw.:", error); alert("❌ Netzwerkfehler/Serverproblem."); }
        finally { if(addAbsenceEmployeeIdInput.value) { addAbsenceSubmitBtn.disabled = false; } }
    }

    async function deleteAbsence(absenceId, employeeId, employeeName) {
         if (!confirm(`Abwesenheitseintrag (ID: ${absenceId}) löschen?`)) return;
         try {
             const response = await fetch(`/admin/absences/${absenceId}`, { method: 'DELETE', credentials: 'include' });
             if (response.ok) { alert("✅ Abwesenheit gelöscht."); loadAbsences(employeeId, employeeName); }
             else { const errorText = await response.text().catch(() => `HTTP Status ${response.status}`); alert(`❌ Fehler Löschen: ${errorText}`); }
         } catch (error) { console.error(`Fehler Löschen Abw. ${absenceId}:`, error); alert("❌ Netzwerkfehler."); }
    }

    // === Auswertungen ===
    function handlePeriodTypeChange() {
        if(!periodTypeSelect || !monthSelectDiv || !quarterSelectDiv || !balanceMonthInput || !balanceQuarterSelect || !downloadPdfBtn || !balanceResultDiv) return; // Schutz
        const selectedType = periodTypeSelect.value;
        monthSelectDiv.classList.toggle('hidden', selectedType !== 'MONTH');
        quarterSelectDiv.classList.toggle('hidden', selectedType !== 'QUARTER');
        balanceMonthInput.required = (selectedType === 'MONTH');
        balanceQuarterSelect.required = (selectedType === 'QUARTER');
        downloadPdfBtn.disabled = false; // Immer aktivieren
        if (selectedType === 'MONTH') { downloadPdfBtn.title = "Monats-PDF"; }
        else if (selectedType === 'QUARTER') { downloadPdfBtn.title = "Quartals-PDF"; }
        else { downloadPdfBtn.title = "Jahres-PDF"; }
        balanceResultDiv.innerHTML = '';
    }

    async function handleCalculateBalance(e) {
        e.preventDefault();
        if(!balanceNameSelect || !balanceYearInput || !periodTypeSelect || !balanceMonthInput || !balanceQuarterSelect || !balanceResultDiv) return; // Schutz

        const employeeId = balanceNameSelect.value;
        const name = balanceNameSelect.options[balanceNameSelect.selectedIndex]?.text || 'Unbekannt';
        const year = balanceYearInput.value;
        const selectedType = periodTypeSelect.value;
        let month = null, quarter = null, valid = true, url = '';
        if (!employeeId) { alert("Bitte Mitarbeiter auswählen."); valid = false; }
        if (!year || isNaN(parseInt(year))) { alert("Gültiges Jahr eingeben."); valid = false; }
        if (selectedType === 'MONTH') { month = balanceMonthInput.value; if (!month || isNaN(parseInt(month)) || month < 1 || month > 12) { alert("Gültigen Monat (1-12) eingeben."); valid = false; } else { url = `/calculate-monthly-balance?name=${encodeURIComponent(name)}&year=${year}&month=${month}`; } }
        else if (selectedType === 'QUARTER') { quarter = balanceQuarterSelect.value; if (!quarter) { alert("Quartal auswählen."); valid = false; } else { url = `/calculate-period-balance?name=${encodeURIComponent(name)}&year=${year}&periodType=QUARTER&periodValue=${quarter}`; } }
        else { url = `/calculate-period-balance?name=${encodeURIComponent(name)}&year=${year}&periodType=YEAR`; }
        if (!valid) return;
        balanceResultDiv.innerHTML = "Berechnung läuft...";
        try {
            const response = await fetch(url, { credentials: "include" });
            if (!response.ok) { const errorText = await response.text().catch(() => `HTTP ${response.status}`); throw new Error(`Fehler ${response.status}: ${errorText}`); }
            const data = await response.json();
            let html = '';
             if (selectedType === 'MONTH') { html = `<h3>Monatsauswertung für ${data.employeeName || name} (${String(data.month).padStart(2,'0')}/${data.year})</h3>`; if (data.previousCarryOver !== undefined) { html += `<p>Übertrag Vormonat: <strong>${data.previousCarryOver.toFixed(2)} Std.</strong></p><p>Soll (Monat): <strong>${data.totalExpected.toFixed(2)} Std.</strong></p><p>Ist (Monat): <strong>${data.totalActual.toFixed(2)} Std.</strong> (Gearbeitet: ${data.workedHours?.toFixed(2) || '0.00'} Std., Abwesenheit: ${data.absenceHours?.toFixed(2) || '0.00'} Std.)</p><p>Differenz (Monat): <strong>${(data.totalActual - data.totalExpected).toFixed(2)} Std.</strong></p><hr><p>Neuer Übertrag: <strong>${data.newCarryOver.toFixed(2)} Std.</strong></p>`; } else if (data.message) { html += `<p>${data.message}</p>`; } else { html += `<p style="color:orange;">Keine Daten.</p>`; } }
             else { const periodLabel = data.periodIdentifier || (selectedType === 'QUARTER' ? `Q${quarter}` : 'Jahr'); const sd = new Date(data.periodStartDate + 'T00:00:00Z').toLocaleDateString('de-DE', { timeZone: 'UTC' }); const ed = new Date(data.periodEndDate + 'T00:00:00Z').toLocaleDateString('de-DE', { timeZone: 'UTC' }); html = `<h3>Auswertung ${periodLabel} für ${data.employeeName || name} (${data.year})</h3><p>Zeitraum: ${sd} - ${ed}</p>`; if (data.startingBalance !== undefined) { html += `<p>Übertrag Periodenbeginn: <strong>${data.startingBalance.toFixed(2)} Std.</strong></p><p>Soll (${periodLabel}): <strong>${data.totalExpectedPeriod.toFixed(2)} Std.</strong></p><p>Ist (${periodLabel}): <strong>${data.totalActualPeriod.toFixed(2)} Std.</strong> (Gearbeitet: ${data.workedHoursPeriod?.toFixed(2) || '0.00'} Std., Abwesenheit: ${data.absenceHoursPeriod?.toFixed(2) || '0.00'} Std.)</p><p>Differenz (${periodLabel}): <strong>${data.periodDifference.toFixed(2)} Std.</strong></p><hr><p>Neuer Übertrag Periodenende: <strong>${data.endingBalancePeriod.toFixed(2)} Std.</strong></p>`; } else if (data.message) { html += `<p>${data.message}</p>`; } else { html += `<p style="color:orange;">Keine Daten.</p>`; } }
            balanceResultDiv.innerHTML = html;
        } catch (error) { console.error(`Fehler ${selectedType}-Auswertung:`, error); balanceResultDiv.innerHTML = `<p style="color:red;">Fehler Berechnung: ${error.message}</p>`; }
    }
    // --- PDF DOWNLOAD (Jetzt für alle Zeiträume) ---
    function handleDownloadPdf() {
        if(!periodTypeSelect || !balanceNameSelect || !balanceYearInput || !balanceMonthInput || !balanceQuarterSelect) return; // Schutz

        const selectedType = periodTypeSelect.value;
        const employeeId = balanceNameSelect.value;
        const name = balanceNameSelect.options[balanceNameSelect.selectedIndex]?.text || ''; // Sicherer Zugriff
        const year = balanceYearInput.value;

        let pdfUrl = '';
        let valid = true;

        if (!employeeId || !name || name === 'Bitte auswählen' || !year || isNaN(parseInt(year))) {
            alert("Bitte wählen Sie einen Mitarbeiter aus und geben Sie ein gültiges Jahr ein.");
            return;
        }

        if (selectedType === 'MONTH') {
            const month = balanceMonthInput.value;
            if (!month || isNaN(parseInt(month)) || month < 1 || month > 12) { alert("Gültigen Monat (1-12) eingeben."); valid = false; }
            else { pdfUrl = `/api/pdf/create-monthly-pdf?name=${encodeURIComponent(name)}&year=${year}&month=${month}`; }
        } else if (selectedType === 'QUARTER') {
            const quarter = balanceQuarterSelect.value;
            if (!quarter) { alert("Quartal auswählen."); valid = false; }
            else { pdfUrl = `/api/pdf/create-period-pdf?name=${encodeURIComponent(name)}&year=${year}&periodType=QUARTER&periodValue=${quarter}`; }
        } else { // YEAR
             pdfUrl = `/api/pdf/create-period-pdf?name=${encodeURIComponent(name)}&year=${year}&periodType=YEAR`;
        }

        if (!valid || !pdfUrl) {
             console.error("PDF URL konnte nicht gebaut werden für Typ:", selectedType);
             alert("Ein Fehler ist aufgetreten. PDF URL konnte nicht erstellt werden.");
             return;
        };

        console.log("Öffne PDF URL:", pdfUrl);
        window.open(pdfUrl, '_blank');
    }
    // --- ENDE PDF DOWNLOAD ---

  </script>
</body>
</html>
