<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/Hand-in-Hand-Logo-192x192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/Hand-in-Hand-Logo-192x192.png" />
  <link rel="shortcut icon" href="/icons/Hand-in-Hand-Logo-192x192.png" />
  <link rel="manifest" href="/icons/manifest.json" />
  <title>Arbeitszeiterfassung</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    /* Internes CSS wird vom externen style.css überschrieben,
       daher hier keine Styles mehr nötig, wenn style.css genutzt wird */
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbeitszeiterfassung</h1>

    <form id="workHoursForm">
      <div>
        <label for="employeeSelect">Mitarbeiter:</label>
        <select id="employeeSelect" name="employeeSelect" required>
          <option value="">Bitte auswählen</option>
        </select>
      </div>

      <div>
        <button type="button" id="workTimeBtn">Arbeitsbeginn buchen</button>
      </div>

      <div id="dailyBookingDetails">
        <div>
            <label for="displayDate">Datum:</label>
            <input type="text" id="displayDate" name="displayDate" readonly>
        </div>
        <div>
            <label for="displayStartTime">Arbeitsbeginn:</label>
            <input type="text" id="displayStartTime" name="displayStartTime" readonly>
        </div>
        <div>
            <label for="displayEndTime">Arbeitsende:</label>
            <input type="text" id="displayEndTime" name="displayEndTime" readonly>
        </div>
      </div>
      <div id="summaryHours" class="hidden">
         <div>
             <label for="dailyTotalHours">Arbeitszeit Tag:</label>
             <span id="dailyTotalHours">--</span>
         </div>
          <div>
             <label for="monthlyTotalHours">Gesamtzeit Monat:</label>
             <span id="monthlyTotalHours">--</span>
         </div>
      </div>

      <input type="hidden" id="date" name="date" />
      <input type="hidden" id="startTime" name="startTime" />
      <input type="hidden" id="endTime" name="endTime" />
      <div class="hidden">
        <label for="comment">Bemerkungen:</label>
        <input type="text" id="comment" name="comment" disabled />
      </div>
    </form>

    <hr>
    <h2>Admin Login</h2>
    <form id="adminLoginForm">
      <div>
        <label for="adminPassword">Passwort:</label>
        <input type="password" id="adminPassword" name="adminPassword" required />
      </div>
      <button type="submit">Anmelden</button>
    </form>
    <div id="adminTabs" class="hidden">
      <ul class="tabs">
        <li data-tab="dashboard" class="hidden">Dashboard/Home</li>
        <li data-tab="workhours" class="active">Arbeitszeiten</li>
        <li data-tab="employees">Mitarbeiter</li>
        <li data-tab="monthly">Monatsauswertung</li>
      </ul>
      <div id="tab-dashboard" class="tab-content hidden">
        <h2>Dashboard/Home</h2>
        <p>Willkommen im Admin-Bereich.</p>
      </div>

      <div id="tab-workhours" class="tab-content">
        <h2>Arbeitszeiten verwalten</h2>
        <div class="table-wrapper">
          <table id="workHoursTable">
            <thead>
              <tr>
                <th>ID</th> <th>Name</th> <th>Datum</th> <th>Arbeitszeit</th>
                <th>Stunden</th> <th>Bemerkungen</th> <th>Aktionen</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <br>
        <button id="adminDownloadCsv">CSV herunterladen</button>
        <button id="adminDeleteData" style="color: red;">Alle Arbeitszeiten löschen (Vorsicht!)</button>
        <hr>
        <div id="editWorkHoursSection" class="hidden">
          <h3>Datensatz bearbeiten</h3>
          <form id="editForm">
            <input type="hidden" id="editId" name="id" />
            <div><label for="editName">Name:</label><input type="text" id="editName" name="name" required /></div>
            <div><label for="editDate">Datum:</label><input type="date" id="editDate" name="date" required /></div>
            <div><label for="editStartTime">Arbeitsbeginn:</label><input type="time" id="editStartTime" name="startTime" required /></div>
            <div><label for="editEndTime">Arbeitsende:</label><input type="time" id="editEndTime" name="endTime" required /></div>
            <div><label for="editComment">Bemerkungen:</label><input type="text" id="editComment" name="comment" /></div>
            <button type="button" onclick="saveChanges()">Änderungen Speichern</button>
            <button type="button" onclick="cancelEditWorkHours()">Abbrechen</button>
          </form>
        </div>
      </div>
      <div id="tab-employees" class="tab-content hidden">
        <h2>Mitarbeiterverwaltung</h2>
        <h3>Aktuelle Mitarbeiter</h3> <ul id="employeeList"></ul> <hr>
        <div id="addEmployeeSection">
          <form id="addEmployeeForm">
            <h3>Mitarbeiter hinzufügen</h3>
            <div><label for="employeeName">Name:</label><input type="text" id="employeeName" name="employeeName" required /></div>
            <div><label for="mo_hours">Mo (Soll):</label><input type="number" id="mo_hours" name="mo_hours" step="0.1" value="0" min="0" /></div>
            <div><label for="di_hours">Di (Soll):</label><input type="number" id="di_hours" name="di_hours" step="0.1" value="0" min="0" /></div>
            <div><label for="mi_hours">Mi (Soll):</label><input type="number" id="mi_hours" name="mi_hours" step="0.1" value="0" min="0" /></div>
            <div><label for="do_hours">Do (Soll):</label><input type="number" id="do_hours" name="do_hours" step="0.1" value="0" min="0" /></div>
            <div><label for="fr_hours">Fr (Soll):</label><input type="number" id="fr_hours" name="fr_hours" step="0.1" value="0" min="0" /></div>
            <button type="submit">Hinzufügen</button>
          </form>
        </div>
        <div id="editEmployeeSection" class="hidden">
          <form id="editEmployeeForm"> <hr> <h3>Mitarbeiter bearbeiten</h3> <input type="hidden" id="editEmployeeId" name="id" />
            <div><label for="editEmployeeName">Name:</label><input type="text" id="editEmployeeName" name="name" required /></div>
            <div><label for="editMoHours">Mo (Soll):</label><input type="number" id="editMoHours" name="mo_hours" step="0.1" value="0" min="0" /></div>
            <div><label for="editDiHours">Di (Soll):</label><input type="number" id="editDiHours" name="di_hours" step="0.1" value="0" min="0" /></div>
            <div><label for="editMiHours">Mi (Soll):</label><input type="number" id="editMiHours" name="mi_hours" step="0.1" value="0" min="0" /></div>
            <div><label for="editDoHours">Do (Soll):</label><input type="number" id="editDoHours" name="do_hours" step="0.1" value="0" min="0" /></div>
            <div><label for="editFrHours">Fr (Soll):</label><input type="number" id="editFrHours" name="fr_hours" step="0.1" value="0" min="0" /></div>
            <button type="button" onclick="saveEmployeeChanges()">Speichern</button>
            <button type="button" onclick="cancelEditEmployee()">Abbrechen</button>
          </form>
        </div>
      </div>
      <div id="tab-monthly" class="tab-content hidden">
        <h2>Monatsauswertung</h2>
        <form id="monthlyBalanceForm">
          <div><label for="balanceName">Mitarbeiter:</label><input type="text" id="balanceName" name="balanceName" required /></div>
          <div><label for="balanceYear">Jahr:</label><input type="number" id="balanceYear" name="balanceYear" required /></div>
          <div><label for="balanceMonth">Monat (1-12):</label><input type="number" id="balanceMonth" name="balanceMonth" required min="1" max="12" /></div>
          <button type="submit">Berechnen</button>
        </form> <br>
        <button id="downloadPdfBtn">PDF</button>
        <div id="monthlyBalanceResult" style="margin-top: 1rem;"></div>
      </div>
    </div>
  </div>
  <script>
    // Globale Variablen & DOM Referenzen
    let currentWorkEntryId = null;
    const employeeSelect = document.getElementById('employeeSelect');
    const workTimeBtn = document.getElementById('workTimeBtn');
    const displayDateInput = document.getElementById('displayDate');
    const displayStartTimeInput = document.getElementById('displayStartTime');
    const displayEndTimeInput = document.getElementById('displayEndTime');
    const summaryHoursDiv = document.getElementById('summaryHours');
    const dailyTotalHoursSpan = document.getElementById('dailyTotalHours');
    const monthlyTotalHoursSpan = document.getElementById('monthlyTotalHours');

    // Initialisierung
    document.addEventListener('DOMContentLoaded', () => {
      resetWorkTimeForm(); loadEmployeeOptions(); setupEventListeners();
    });

    // Event Listener
    function setupEventListeners() {
      employeeSelect.addEventListener('change', handleEmployeeSelection);
      workTimeBtn.addEventListener('click', handleWorkTimeToggle);
      // Admin Listener
      document.getElementById('adminLoginForm')?.addEventListener('submit', handleAdminLogin);
      document.querySelectorAll(".tabs li")?.forEach(tab => tab.addEventListener("click", handleTabSwitch));
      document.getElementById('adminDownloadCsv')?.addEventListener('click', downloadAdminCsv);
      document.getElementById('adminDeleteData')?.addEventListener('click', deleteAllWorkHours);
      document.getElementById('addEmployeeForm')?.addEventListener('submit', handleAddEmployee);
      document.getElementById('monthlyBalanceForm')?.addEventListener('submit', handleCalculateMonthlyBalance);
      document.getElementById('downloadPdfBtn')?.addEventListener('click', handleDownloadPdf);
    }

    // Hauptfunktionen Zeiterfassung
    function handleEmployeeSelection() { checkNextBookingAction(); }

    async function checkNextBookingAction() {
        const name = employeeSelect.value;
        displayDateInput.value = ''; displayStartTimeInput.value = ''; displayEndTimeInput.value = '';
        summaryHoursDiv.classList.add('hidden'); dailyTotalHoursSpan.textContent = '--'; monthlyTotalHoursSpan.textContent = '--';
        workTimeBtn.disabled = true; currentWorkEntryId = null;
        if (!name) { workTimeBtn.textContent = "Arbeitsbeginn buchen"; workTimeBtn.style.backgroundColor = ''; return; }
        try {
            const response = await fetch(`/next-booking-details?name=${encodeURIComponent(name)}`);
            if (!response.ok) throw new Error(`Status prüfen: ${response.status}`);
            const data = await response.json();
            if (data.nextBooking === 'arbeitsende') {
                workTimeBtn.textContent = 'Arbeitsende buchen'; workTimeBtn.style.backgroundColor = 'orange';
                currentWorkEntryId = data.id; workTimeBtn.disabled = false;
                if (data.startDate) {
                     try {
                         const dateParts = data.startDate.split('-');
                         const dateObj = new Date(Date.UTC(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])));
                         displayDateInput.value = dateObj.toLocaleDateString('de-DE', { timeZone: 'UTC' });
                     } catch(e) { displayDateInput.value = data.startDate; }
                }
                displayStartTimeInput.value = data.startTime ? data.startTime + " Uhr" : '';
                displayEndTimeInput.value = '';
            } else {
                workTimeBtn.textContent = 'Arbeitsbeginn buchen'; workTimeBtn.style.backgroundColor = ''; workTimeBtn.disabled = false;
            }
        } catch (error) {
            console.error("Fehler /next-booking-details:", error); alert(`❌ Fehler Statusprüfung: ${error.message}`);
            workTimeBtn.textContent = 'Fehler'; workTimeBtn.style.backgroundColor = 'red';
        }
    }

    // --- ANGEPASSTE Funktion: handleWorkTimeToggle (mit verbesserter Fehlerbehandlung für 409) ---
    async function handleWorkTimeToggle() {
        const name = employeeSelect.value; if (!name) return;
        const action = workTimeBtn.textContent.includes('Arbeitsbeginn') ? 'start' : 'end';
        const now = new Date();
        const date = now.toISOString().split("T")[0];
        const time = now.toTimeString().slice(0, 5);
        const displayDate = now.toLocaleDateString('de-DE');
        workTimeBtn.disabled = true;

        if (action === 'start') {
            try {
                const response = await fetch("/log-start", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, date, startTime: time }) });
                if (response.ok) {
                    const result = await response.json();
                    alert("✅ Arbeitsbeginn gebucht.");
                    displayDateInput.value = displayDate; displayStartTimeInput.value = time + " Uhr"; displayEndTimeInput.value = '';
                    summaryHoursDiv.classList.add('hidden'); currentWorkEntryId = result.id;
                    workTimeBtn.textContent = 'Arbeitsende buchen'; workTimeBtn.style.backgroundColor = 'orange';
                } else {
                    // --- ANGEPASSTE Fehlerbehandlung ---
                    const result = await response.json().catch(() => ({ message: 'Unbekannter Fehler oder keine JSON-Antwort.' }));
                    let alertMessage = "❌ Fehler beim Buchen: ";
                    if (response.status === 409) { // Spezifischer Fehler für Konflikt (Tag offen ODER Tag bereits abgeschlossen)
                        alertMessage = `⚠️ ${result.message || 'Buchung nicht möglich (Konflikt).'}`; // Zeigt die spezifische Meldung vom Server
                    } else {
                        alertMessage += (result.message || response.statusText);
                    }
                    alert(alertMessage);
                    // --- ENDE ANGEPASSTE Fehlerbehandlung ---
                }
            } catch (err) { console.error("Fehler /log-start:", err); alert("❌ Netzwerkfehler!");
            } finally { workTimeBtn.disabled = false; checkNextBookingAction(); } // Status neu prüfen
        } else { // action === 'end'
            if (!currentWorkEntryId) { alert("Fehler: Keine ID für offenen Eintrag."); workTimeBtn.disabled = false; return; }
            try {
                const response = await fetch(`/log-end/${currentWorkEntryId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ endTime: time, comment: "" }) });
                if (response.ok) {
                    alert("✅ Arbeitsende gebucht."); displayEndTimeInput.value = time + " Uhr";
                    workTimeBtn.textContent = 'Arbeitsbeginn buchen'; workTimeBtn.style.backgroundColor = '';
                    currentWorkEntryId = null; displaySummaryHours(name, date); // Zusammenfassung anzeigen
                } else {
                    const result = await response.json().catch(() => ({ message: 'Unbekannter Fehler.' }));
                    alert(`❌ Fehler Ende: ${result.message || response.statusText}`);
                }
            } catch (err) { console.error("Fehler /log-end:", err); alert("❌ Netzwerkfehler!");
            } finally { workTimeBtn.disabled = false; checkNextBookingAction(); } // Status neu prüfen
        }
    }

    async function displaySummaryHours(employeeName, dayDate) {
        if (!employeeName || !dayDate) return;
        summaryHoursDiv.classList.add('hidden'); dailyTotalHoursSpan.textContent = 'lade...'; monthlyTotalHoursSpan.textContent = 'lade...';
        try {
            const response = await fetch(`/summary-hours?name=${encodeURIComponent(employeeName)}&date=${dayDate}`);
            if (!response.ok) throw new Error(`Zusammenfassung laden: ${response.status}`);
            const summary = await response.json();
            dailyTotalHoursSpan.textContent = `${summary.dailyHours !== null ? summary.dailyHours.toFixed(2) : '0.00'} Std.`;
            monthlyTotalHoursSpan.textContent = `${summary.monthlyHours !== null ? summary.monthlyHours.toFixed(2) : '0.00'} Std.`;
            summaryHoursDiv.classList.remove('hidden');
        } catch (error) {
             console.error("Fehler Anzeige Zusammenfassung:", error);
             dailyTotalHoursSpan.textContent = 'Fehler'; monthlyTotalHoursSpan.textContent = 'Fehler';
             summaryHoursDiv.classList.remove('hidden');
        }
    }

    function resetWorkTimeForm() {
        employeeSelect.value = ''; workTimeBtn.textContent = 'Arbeitsbeginn buchen'; workTimeBtn.style.backgroundColor = '';
        workTimeBtn.disabled = true; currentWorkEntryId = null;
        displayDateInput.value = ''; displayStartTimeInput.value = ''; displayEndTimeInput.value = '';
        summaryHoursDiv.classList.add('hidden'); dailyTotalHoursSpan.textContent = '--'; monthlyTotalHoursSpan.textContent = '--';
        document.getElementById('comment').value = ''; document.getElementById('comment').disabled = true;
    }

    async function loadEmployeeOptions() {
        try {
            const response = await fetch('/employees'); if (!response.ok) throw new Error(`Liste laden: ${response.status}`);
            const employees = await response.json(); employeeSelect.innerHTML = '<option value="">Bitte auswählen</option>';
            employees.forEach(emp => { const option = document.createElement('option'); option.value = emp.name; option.textContent = emp.name; employeeSelect.appendChild(option); });
        } catch (error) { console.error("Fehler Laden Mitarbeiteroptionen:", error); employeeSelect.innerHTML = '<option value="">Fehler</option>'; alert(`❌ Fehler Mitarbeiterliste: ${error.message}`); }
    }
    // --- Admin Funktionen (jetzt wieder vollständig) ---
    async function handleAdminLogin(e) {
      e.preventDefault();
      const password = document.getElementById("adminPassword").value;
      try {
        const response = await fetch("/admin-login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password }),
          credentials: "include"
        });
        if (response.ok) {
          alert("✅ Admin erfolgreich angemeldet.");
          document.getElementById("adminPassword").value = ""; // Feld leeren
          document.getElementById("adminTabs").classList.remove("hidden");
          document.getElementById("adminLoginForm").classList.add("hidden");
          // Initiales Laden der Admin-Daten
          loadAdminWorkHours();
          loadEmployees();
          // Geänderten Standard-Tab anzeigen (workhours statt dashboard)
          const workHoursTab = document.querySelector(".tabs li[data-tab='workhours']");
          if (workHoursTab) {
            handleTabSwitch({ currentTarget: workHoursTab });
          }
        } else {
          const result = await response.text();
          alert("❌ Login fehlgeschlagen: " + response.status + " – " + result);
        }
      } catch (error) {
        console.error("❌ Netzwerkfehler beim Admin-Login:", error);
        alert("❌ Netzwerkfehler oder Server nicht erreichbar.");
      }
    }

    function handleTabSwitch(event) {
      const clickedTab = event.currentTarget || event.target;
      // Sicherstellen, dass es ein gültiger Tab ist und nicht der versteckte Dashboard-Tab
      if (!clickedTab || !clickedTab.getAttribute("data-tab") || clickedTab.classList.contains("hidden"))
        return;
      document.querySelectorAll(".tabs li").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(tc => tc.classList.add("hidden"));
      clickedTab.classList.add("active");
      const targetContentId = "tab-" + clickedTab.getAttribute("data-tab");
      const targetContent = document.getElementById(targetContentId);
      if (targetContent) {
        targetContent.classList.remove("hidden");
        if (targetContentId === 'tab-workhours') loadAdminWorkHours();
        if (targetContentId === 'tab-employees') loadEmployees();
      } else {
        console.error("Tab content not found for ID:", targetContentId);
      }
    }

     async function loadAdminWorkHours() {
        try {
            const response = await fetch('/admin-work-hours', { credentials: "include" });
            if (!response.ok) throw new Error(`Admin-Zeiten nicht geladen (${response.status}).`);
            const data = await response.json();
            const tbody = document.querySelector("#workHoursTable tbody");
            tbody.innerHTML = "";
            if (data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='7'>Keine Daten vorhanden.</td></tr>";
                return;
            }
            data.forEach(entry => {
                const row = document.createElement("tr");
                const hours = parseFloat(entry.hours) || 0;
                let displayDate = 'N/A';
                 if (entry.date) {
                    try {
                         const dateParts = entry.date.split('-');
                         const dateObj = new Date(Date.UTC(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])));
                         displayDate = dateObj.toLocaleDateString("de-DE", { timeZone: 'UTC' });
                    } catch(e) { displayDate = entry.date; }
                 }
                row.innerHTML = `
                    <td>${entry.id}</td>
                    <td>${entry.name || 'Unbekannt'}</td>
                    <td>${displayDate}</td>
                    <td>${entry.startTime || 'n.a.'} - ${entry.endTime || 'n.a.'}</td>
                    <td>${hours.toFixed(2)}</td>
                    <td>${entry.comment || ''}</td>
                    <td>
                        <button onclick='editEntry(${JSON.stringify(entry)})'>Bearbeiten</button>
                        <button onclick="deleteEntry(${entry.id})">Löschen</button>
                    </td>`;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error("Fehler beim Laden der Admin-Arbeitszeiten:", error);
            document.querySelector("#workHoursTable tbody").innerHTML = `<tr><td colspan="7">❌ Fehler: ${error.message}</td></tr>`;
             alert("❌ " + error.message); // Fehler auch als Alert anzeigen
        }
    }

    function editEntry(entry) {
      // Füllt das Bearbeitungsformular für Arbeitszeiten
      document.getElementById("editId").value = entry.id;
      document.getElementById("editName").value = entry.name || "";
      // Datum kommt als YYYY-MM-DD (oder mit T...) vom Server, für Input type="date" ist YYYY-MM-DD nötig
      document.getElementById("editDate").value = entry.date ? entry.date.split("T")[0] : "";
      // Zeiten kommen als HH:MI vom Server
      document.getElementById("editStartTime").value = entry.startTime || "";
      document.getElementById("editEndTime").value = entry.endTime || "";
      document.getElementById("editComment").value = entry.comment || "";
      document.getElementById("editWorkHoursSection").classList.remove("hidden");
      document.getElementById("editWorkHoursSection").scrollIntoView({ behavior: "smooth" });
    }

    function cancelEditWorkHours() {
      document.getElementById("editWorkHoursSection").classList.add("hidden");
      document.getElementById("editForm").reset();
      document.getElementById("editId").value = "";
    }

    async function saveChanges() {
      const id = document.getElementById("editId").value;
      if (!id) return;
      const data = {
        id: id,
        name: document.getElementById("editName").value,
        date: document.getElementById("editDate").value,
        startTime: document.getElementById("editStartTime").value,
        endTime: document.getElementById("editEndTime").value,
        comment: document.getElementById("editComment").value
      };
      if (!data.name || !data.date || !data.startTime || !data.endTime) {
        alert("Bitte füllen Sie alle erforderlichen Felder aus (Name, Datum, Start, Ende).");
        return;
      }
      try {
        const response = await fetch("/api/admin/update-hours", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
          credentials: "include"
        });
        const result = await response.text();
        if (response.ok) {
          alert("✅ Änderungen erfolgreich gespeichert.");
          cancelEditWorkHours();
          loadAdminWorkHours(); // Tabelle neu laden
        } else {
          alert(`❌ Fehler beim Speichern (${response.status}): ${result}`);
        }
      } catch (error) {
        console.error("Fehler beim Speichern der Änderungen:", error);
        alert("❌ Netzwerkfehler beim Speichern: " + error.message);
      }
    }

    async function deleteEntry(id) {
      if (!confirm(`Möchten Sie den Eintrag mit ID ${id} wirklich löschen?`)) return;
      try {
        const response = await fetch(`/api/admin/delete-hours/${id}`, {
          method: "DELETE",
          credentials: "include"
        });
        const result = await response.text();
        if (response.ok) {
          alert("✅ Eintrag erfolgreich gelöscht.");
          loadAdminWorkHours(); // Tabelle neu laden
        } else {
          alert(`❌ Fehler beim Löschen (${response.status}): ${result}`);
        }
      } catch (error) {
        console.error(`Fehler beim Löschen des Eintrags ${id}:`, error);
        alert("❌ Netzwerkfehler beim Löschen: " + error.message);
      }
    }

    async function downloadAdminCsv() {
      window.open('/admin-download-csv', '_blank');
    }

    async function deleteAllWorkHours() {
      if (!confirm('WARNUNG!\nSind Sie sicher, dass Sie ALLE Arbeitszeiteinträge unwiderruflich löschen möchten?'))
        return;
      try {
        const response = await fetch('/adminDeleteData', {
          method: 'DELETE',
          credentials: 'include'
        });
        const result = await response.text();
        if (response.ok) {
          alert('✅ Alle Arbeitszeiten wurden gelöscht.');
          loadAdminWorkHours(); // Tabelle neu laden
        } else {
          alert(`❌ Fehler beim Löschen (${response.status}): ${result}`);
        }
      } catch (error) {
        console.error('Fehler beim Löschen aller Daten:', error);
        alert('❌ Netzwerkfehler beim Löschen aller Daten: ' + error.message);
      }
    }

    async function loadEmployees() {
        try {
            const response = await fetch("/admin/employees", { credentials: "include" });
            if (!response.ok) throw new Error(`Mitarbeiter nicht geladen (${response.status}).`);
            const data = await response.json();
            const list = document.getElementById("employeeList");
            list.innerHTML = "";
            if (data.length > 0) {
                data.forEach(emp => {
                    const li = document.createElement("li");
                    // Sicherstellen, dass die emp Daten korrekt an die Funktionen übergeben werden
                    const empJson = JSON.stringify(emp).replace(/"/g, '&quot;'); // Maskieren für HTML Attribut
                    li.innerHTML = `<span>${emp.name} (Mo: ${emp.mo_hours||0}, Di: ${emp.di_hours||0}, Mi: ${emp.mi_hours||0}, Do: ${emp.do_hours||0}, Fr: ${emp.fr_hours||0})</span>
                                    <div>
                                        <button onclick='editEmployee(${empJson})'>Bearbeiten</button>
                                        <button onclick="deleteEmployee(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')">Löschen</button> {/* Namen mit ' maskieren */}
                                    </div>`;
                    list.appendChild(li);
                });
            } else { list.innerHTML = "<li>Keine Mitarbeiter gefunden.</li>"; }
        } catch (error) {
            console.error("Fehler Laden Mitarbeiter:", error);
            document.getElementById("employeeList").innerHTML = `<li>❌ Fehler: ${error.message}</li>`;
            alert("❌ " + error.message);
        }
    }

    async function handleAddEmployee(event) {
      event.preventDefault();
      const form = event.target;
      const data = {
        name: form.employeeName.value,
        mo_hours: parseFloat(form.mo_hours.value) || 0,
        di_hours: parseFloat(form.di_hours.value) || 0,
        mi_hours: parseFloat(form.mi_hours.value) || 0,
        do_hours: parseFloat(form.do_hours.value) || 0,
        fr_hours: parseFloat(form.fr_hours.value) || 0
      };
      if (!data.name) {
        alert("Bitte geben Sie einen Mitarbeiternamen ein.");
        return;
      }
      try {
        const response = await fetch('/admin/employees', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'include'
        });
        if (response.ok) {
          const result = await response.json();
          alert(`✅ Mitarbeiter "${result.name}" hinzugefügt.`);
          form.reset();
          loadEmployees(); // Liste aktualisieren
          loadEmployeeOptions(); // Dropdown aktualisieren
        } else {
          const errorText = await response.text().catch(() => response.statusText);
          alert(`❌ Fehler beim Hinzufügen (${response.status}): ${errorText}`);
        }
      } catch (error) {
        console.error('Fehler beim Hinzufügen des Mitarbeiters:', error);
        alert('❌ Netzwerkfehler beim Hinzufügen: ' + error.message);
      }
    }

    function editEmployee(emp) {
      // Stellt sicher, dass emp ein Objekt ist
      if (typeof emp !== 'object' || emp === null) {
          console.error("Ungültige Mitarbeiterdaten für Bearbeitung:", emp);
          alert("Fehler: Ungültige Mitarbeiterdaten.");
          return;
      }
      document.getElementById("editEmployeeId").value = emp.id;
      document.getElementById("editEmployeeName").value = emp.name;
      document.getElementById("editMoHours").value = emp.mo_hours || 0;
      document.getElementById("editDiHours").value = emp.di_hours || 0;
      document.getElementById("editMiHours").value = emp.mi_hours || 0;
      document.getElementById("editDoHours").value = emp.do_hours || 0;
      document.getElementById("editFrHours").value = emp.fr_hours || 0;
      document.getElementById("editEmployeeSection").classList.remove("hidden");
      document.getElementById("addEmployeeSection").classList.add("hidden");
      document.getElementById("editEmployeeSection").scrollIntoView({ behavior: "smooth" });
    }

    function cancelEditEmployee() {
      document.getElementById("editEmployeeSection").classList.add("hidden");
      document.getElementById("editEmployeeForm").reset();
      document.getElementById("editEmployeeId").value = "";
      document.getElementById("addEmployeeSection").classList.remove("hidden");
    }

    async function saveEmployeeChanges() {
      const id = document.getElementById("editEmployeeId").value;
      const data = {
        id: id,
        name: document.getElementById("editEmployeeName").value,
        mo_hours: parseFloat(document.getElementById("editMoHours").value) || 0,
        di_hours: parseFloat(document.getElementById("editDiHours").value) || 0,
        mi_hours: parseFloat(document.getElementById("editMiHours").value) || 0,
        do_hours: parseFloat(document.getElementById("editDoHours").value) || 0,
        fr_hours: parseFloat(document.getElementById("editFrHours").value) || 0
      };
      if (!data.name) return alert("Mitarbeitername darf nicht leer sein.");
      try {
        const response = await fetch(`/admin/employees/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
          credentials: "include"
        });
        const result = await response.text();
        if (response.ok) {
          alert("✅ Mitarbeiter erfolgreich gespeichert.");
          cancelEditEmployee();
          loadEmployees(); // Liste aktualisieren
          loadEmployeeOptions(); // Dropdown aktualisieren
        } else {
          alert(`❌ Fehler beim Speichern (${response.status}): ${result}`);
        }
      } catch (error) {
        console.error("Fehler beim Speichern des Mitarbeiters:", error);
        alert("❌ Netzwerkfehler beim Speichern: " + error.message);
      }
    }

    async function deleteEmployee(id, name) {
      if (!confirm(`Möchten Sie den Mitarbeiter "${name}" (ID: ${id}) wirklich löschen?\nZugehörige Arbeitszeiten bleiben bestehen, sind aber evtl. nicht mehr korrekt zugeordnet.`))
        return;
      try {
        const response = await fetch(`/admin/employees/${id}`, {
          method: "DELETE",
          credentials: "include"
        });
        const result = await response.text();
        if (response.ok) {
          alert("✅ Mitarbeiter erfolgreich gelöscht.");
          cancelEditEmployee(); // Schließt Bearbeitungsformular, falls offen
          loadEmployees(); // Liste aktualisieren
          loadEmployeeOptions(); // Dropdown aktualisieren
        } else {
          alert(`❌ Fehler beim Löschen (${response.status}): ${result}`);
        }
      } catch (error) {
        console.error(`Fehler beim Löschen des Mitarbeiters ${id}:`, error);
        alert("❌ Netzwerkfehler beim Löschen: " + error.message);
      }
    }

    async function handleCalculateMonthlyBalance(event) {
      event.preventDefault();
      const name = document.getElementById("balanceName").value;
      const year = document.getElementById("balanceYear").value;
      const month = document.getElementById("balanceMonth").value;
      const resultElement = document.getElementById("monthlyBalanceResult");
      resultElement.innerHTML = '<p>Berechne...</p>';
      if (!name || !year || !month) {
        resultElement.innerHTML = '<p style="color: orange;">Bitte Mitarbeitername, Jahr und Monat angeben.</p>';
        return;
      }
      try {
        const response = await fetch(
          `/calculate-monthly-balance?name=${encodeURIComponent(name)}&year=${year}&month=${month}`,
          { credentials: "include" }
        );
        if (!response.ok) {
          const errorText = await response.text() || response.statusText;
          resultElement.innerHTML = `<p style="color: red;">❌ Fehler bei Monatsauswertung: ${errorText}</p>`;
          return;
        }
        const result = await response.json();
        resultElement.innerHTML = '';
        if (result.message) {
          resultElement.innerHTML += `<p style="color: green; font-weight: bold;">${result.message}</p>`;
        }
        resultElement.innerHTML += `<p><strong>Mitarbeiter:</strong> ${result.employeeName || 'N/A'}</p>`;
        resultElement.innerHTML += `<p><strong>Zeitraum:</strong> ${String(result.month || '??').padStart(2,'0')}/${result.year || '????'}</p><hr style="margin: 0.5rem 0;">`;
        let summaryTable = `<table><tbody>
                <tr><td>Übertrag Vormonat:</td><td>${(result.previousCarryOver !== undefined ? result.previousCarryOver.toFixed(2) : 'N/A')} Std.</td></tr>
                <tr><td>Monatsdiff. (Ist-Soll):</td><td>${(result.monthlyDifference !== undefined ? result.monthlyDifference.toFixed(2) : 'N/A')} Std.</td></tr>
                <tr><td><strong>Neuer Übertrag:</strong></td><td><strong>${(result.newCarryOver !== undefined ? result.newCarryOver.toFixed(2) : 'N/A')} Std.</strong></td></tr>
                </tbody></table><br>`;
        resultElement.innerHTML += summaryTable;
      } catch (err) {
        console.error("Client-Fehler beim Berechnen des Monatsabschlusses:", err);
        resultElement.innerHTML = `<p style="color: red;">❌ Client-Fehler bei Monatsauswertung: ${err.message}</p>`;
      }
    }

    async function handleDownloadPdf() {
      const name = document.getElementById("balanceName").value;
      const year = document.getElementById("balanceYear").value;
      const month = document.getElementById("balanceMonth").value;
      if (!name || !year || !month) {
        alert("Bitte füllen Sie Mitarbeitername, Jahr und Monat aus, bevor Sie das PDF herunterladen.");
        return;
      }
      window.open(`/create-monthly-pdf?name=${encodeURIComponent(name)}&year=${year}&month=${month}`, '_blank');
    }

  </script>
</body>
</html>
