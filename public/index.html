<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbeitszeiterfassung</title>
  <style>
    /* Basisstile */
    body { font-family: sans-serif; line-height: 1.6; color: #333; background-color: #f4f4f4; }
    .container { max-width: 950px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
    h1, h2, h3 { color: #333; margin-bottom: 0.8em; }
    h1 { text-align: center; }
    hr { border: 0; height: 1px; background: #ddd; margin: 2rem 0; }

    /* Formulare und Eingaben */
    label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
    input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="time"], input[type="month"], select {
        width: calc(100% - 20px); /* Berücksichtigt Padding */
        padding: 10px;
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* Stellt sicher, dass Padding die Breite nicht erhöht */
        font-size: 1rem;
    }
    input[readonly] { background-color: #e9e9e9; cursor: default; }
    button {
        padding: 10px 20px;
        cursor: pointer;
        margin-top: 5px;
        margin-right: 5px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        font-size: 1rem;
        transition: background-color 0.2s ease;
    }
    button:hover { background-color: #0056b3; }
    button:disabled { cursor: not-allowed; background-color: #ccc; border-color: #bbb; }
    button[style*="color: red"] { background-color: #dc3545; }
    button[style*="color: red"]:hover { background-color: #c82333; }

    /* Tab-Navigation */
    .tabs { list-style: none; padding: 0; margin: 0 0 1rem 0; display: flex; flex-wrap: wrap; border-bottom: 1px solid #ccc; }
    .tabs li { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; margin-right: 5px; margin-bottom: -1px; background: #f1f1f1; border-radius: 4px 4px 0 0; transition: background-color 0.2s ease; }
    .tabs li:hover { background: #e0e0e0; }
    .tabs li.active { background: #fff; font-weight: bold; border-bottom: 1px solid #fff; }
    .tab-content { border: 1px solid #ccc; padding: 20px; background: #fff; border-radius: 0 0 4px 4px; border-top: none; margin-bottom: 2rem; }

    /* Tabellen */
    .table-wrapper { overflow-x: auto; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: middle; }
    th { background-color: #f8f8f8; font-weight: bold; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #f1f1f1; }

    /* Spezifische Sektionen */
    .booking-details { margin-top: 1rem; background-color: #f9f9f9; padding: 15px; border-radius: 4px; }
    .booking-row { margin-bottom: 0.7rem; display: flex; align-items: center; }
    .booking-row label { width: 120px; /* Feste Breite für Labels */ margin-right: 10px; font-weight: normal; }
    .booking-row input[type="text"] { flex-grow: 1; } /* Input nimmt restlichen Platz */
    #summaryHours { margin-top: 1rem; border-top: 1px dashed #ccc; padding-top: 1rem; }
    #summaryHours span { font-weight: bold; margin-left: 5px;}

    #adminLoginForm { margin-top: 1rem; }
    #workHoursFilterSection { margin-bottom: 1rem; padding: 15px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; flex-wrap: wrap; gap: 15px; }
    #workHoursFilterSection label { margin-right: 5px; font-weight: bold; }
    #workHoursFilterSection select, #workHoursFilterSection input[type="month"] { width: auto; /* Automatische Breite */ margin-right: 0; }

    #editWorkHoursSection, #editEmployeeSection { border: 1px solid #eee; padding: 20px; margin-top: 1.5rem; background-color: #fdfdfd; border-radius: 4px; }
    #addEmployeeForm, #addAbsenceForm, #generateHolidaysForm { border: 1px solid #eee; padding: 20px; margin-top: 1.5rem; background-color: #fdfdfd; border-radius: 4px; }
    #generateHolidaysForm { background-color: #f0f8ff; } /* Leicht blauer Hintergrund */
    #generateHolidaysForm input[type="number"] { width: 100px; display: inline-block; vertical-align: middle; margin-right: 10px;}

    /* Nachrichten und Hilfsklassen */
    .hidden { display: none; }
    .success-message { color: green; font-weight: bold; margin-top: 10px; }
    .error-message { color: red; font-weight: bold; margin-top: 10px; }
    .working-message { color: blue; font-weight: bold; margin-top: 10px; }
    .positive-diff { color: green; }
    .negative-diff { color: red; }
    small { display: block; margin-top: 5px; color: #666; }

    /* Responsive Anpassungen */
    @media (max-width: 768px) {
        .container { padding: 15px; }
        .tabs li { padding: 8px 12px; font-size: 0.9rem; }
        button { padding: 8px 15px; font-size: 0.9rem; }
        input, select { font-size: 0.9rem; padding: 8px; }
        th, td { padding: 8px; }
        #workHoursFilterSection { flex-direction: column; align-items: stretch; }
        #workHoursFilterSection select, #workHoursFilterSection input[type="month"] { width: 100%; margin-bottom: 10px; }
        .booking-row { flex-direction: column; align-items: flex-start; }
        .booking-row label { width: auto; margin-bottom: 3px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbeitszeiterfassung</h1>

    <form id="workHoursForm">
      <div>
          <label for="employeeSelect">Mitarbeiter:</label>
          <select id="employeeSelect" name="employeeSelect" required>
              <option value="">Bitte auswählen</option>
              </select>
        </div>
      <div><button type="button" id="workTimeBtn" disabled>Aktion wird geladen...</button></div>

      <div id="bookingDetails" class="booking-details hidden">
         <div class="booking-row">
             <label for="displayDate">Datum:</label>
             <input type="text" id="displayDate" readonly>
            </div>
         <div class="booking-row">
             <label for="displayStartTime">Arbeitsbeginn:</label>
             <input type="text" id="displayStartTime" readonly>
            </div>
         <div class="booking-row">
             <label for="displayEndTime">Arbeitsende:</label>
             <input type="text" id="displayEndTime" readonly>
            </div>
         <div id="summaryHours" class="hidden">
             <div class="booking-row">
                 <label>Arbeitszeit (Tag):</label>
                 <span id="dailyTotalHours">--</span>
                </div>
             <div class="booking-row">
                 <label>Arbeitszeit (Monat):</label>
                 <span id="monthlyTotalHours">--</span>
                </div>
            </div>
       </div>
    </form>
    <hr>
    <h2>Admin Login</h2>
    <form id="adminLoginForm">
      <div>
          <label for="adminPassword">Passwort:</label>
          <input type="password" id="adminPassword" name="adminPassword" required>
        </div>
      <button type="submit">Anmelden</button>
    </form>

    <div id="adminTabs" class="hidden">
      <ul class="tabs">
        <li data-tab="workhours" class="active">Arbeitszeiten</li>
        <li data-tab="employees">Mitarbeiter</li>
        <li data-tab="absences">Abwesenheiten</li>
        <li data-tab="reports">Auswertungen</li>
      </ul>

      <div id="tab-workhours" class="tab-content">
        <h2>Arbeitszeiten verwalten</h2>

        <div id="workHoursFilterSection">
          <label for="filterEmployeeSelect">Mitarbeiter:</label>
          <select id="filterEmployeeSelect" name="filterEmployeeSelect">
            <option value="">Alle Mitarbeiter</option>
            </select>
          <label for="filterMonthInput">Monat:</label>
          <input type="month" id="filterMonthInput" name="filterMonthInput">
          <button type="button" id="applyWorkHoursFilter">Filter anwenden</button>
        </div>

        <div class="table-wrapper">
          <table id="workHoursTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Datum</th>
                <th>Zeitraum</th>
                <th>Std.</th>
                <th>Bemerkungen</th>
                <th>Aktionen</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7">Bitte Filter auswählen und anwenden.</td></tr>
              </tbody>
          </table>
        </div>
        <button id="adminDownloadCsv">Gefilterte Daten als CSV herunterladen</button>
        <button id="adminDeleteData" style="color: red;">Alle Arbeits-/Bilanz-/Abwesenheitsdaten löschen (VORSICHT!)</button>
        <hr>

        <div id="editWorkHoursSection" class="hidden">
          <h3>Arbeitszeiteintrag bearbeiten</h3>
          <form id="editForm">
             <input type="hidden" id="editId" name="id">
             <div><label for="editName">Name:</label><input type="text" id="editName" name="name" required readonly></div>
             <div><label for="editDate">Datum:</label><input type="date" id="editDate" name="date" required></div>
             <div><label for="editStartTime">Arbeitsbeginn:</label><input type="time" id="editStartTime" name="startTime" required step="60"></div> <div><label for="editEndTime">Arbeitsende:</label><input type="time" id="editEndTime" name="endTime" required step="60"></div>
             <div><label for="editComment">Bemerkungen:</label><input type="text" id="editComment" name="comment"></div>
             <button type="button" onclick="saveChanges()">Speichern</button>
             <button type="button" onclick="cancelEditWorkHours()" style="background-color: #6c757d;">Abbrechen</button>
           </form>
        </div>
      </div>

      <div id="tab-employees" class="tab-content hidden">
        <h2>Mitarbeiterverwaltung</h2>
        <h3>Aktuelle Mitarbeiter</h3>
         <div class="table-wrapper">
            <table id="employeeTable">
             <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Soll Mo</th>
                        <th>Soll Di</th>
                        <th>Soll Mi</th>
                        <th>Soll Do</th>
                        <th>Soll Fr</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
             <tbody id="employeeList">
                     <tr><td colspan="8">Lade Mitarbeiter...</td></tr>
                     </tbody>
            </table>
         </div>
         <hr>
        <div id="addEmployeeSection">
           <form id="addEmployeeForm">
             <h3>Neuen Mitarbeiter hinzufügen</h3>
             <div><label for="employeeName">Name:</label><input type="text" id="employeeName" name="employeeName" required></div>
             <div><label for="mo_hours">Mo (Soll Std.):</label><input type="number" id="mo_hours" name="mo_hours" step="0.01" value="0" min="0" max="24"></div>
             <div><label for="di_hours">Di (Soll Std.):</label><input type="number" id="di_hours" name="di_hours" step="0.01" value="0" min="0" max="24"></div>
             <div><label for="mi_hours">Mi (Soll Std.):</label><input type="number" id="mi_hours" name="mi_hours" step="0.01" value="0" min="0" max="24"></div>
             <div><label for="do_hours">Do (Soll Std.):</label><input type="number" id="do_hours" name="do_hours" step="0.01" value="0" min="0" max="24"></div>
             <div><label for="fr_hours">Fr (Soll Std.):</label><input type="number" id="fr_hours" name="fr_hours" step="0.01" value="0" min="0" max="24"></div>
             <button type="submit">Hinzufügen</button>
           </form>
        </div>
        <div id="editEmployeeSection" class="hidden">
          <form id="editEmployeeForm">
            <hr><h3>Mitarbeiter bearbeiten</h3>
             <input type="hidden" id="editEmployeeId" name="id">
             <div><label for="editEmployeeName">Name:</label><input type="text" id="editEmployeeName" name="name" required></div>
             <div><label for="editMoHours">Mo (Soll Std.):</label><input type="number" id="editMoHours" name="mo_hours" step="0.01" value="0" min="0" max="24"></div>
             <div><label for="editDiHours">Di (Soll Std.):</label><input type="number" id="editDiHours" name="di_hours" step="0.01" value="0" min="0" max="24"></div>
             <div><label for="editMiHours">Mi (Soll Std.):</label><input type="number" id="editMiHours" name="mi_hours" step="0.01" value="0" min="0" max="24"></div>
             <div><label for="editDoHours">Do (Soll Std.):</label><input type="number" id="editDoHours" name="do_hours" step="0.01" value="0" min="0" max="24"></div>
             <div><label for="editFrHours">Fr (Soll Std.):</label><input type="number" id="editFrHours" name="fr_hours" step="0.01" value="0" min="0" max="24"></div>
             <button type="button" onclick="saveEmployeeChanges()">Speichern</button>
             <button type="button" onclick="cancelEditEmployee()" style="background-color: #6c757d;">Abbrechen</button>
           </form>
        </div>
      </div>
      <div id="tab-absences" class="tab-content hidden">
          <h2>Abwesenheiten verwalten</h2>

          <div>
              <label for="absenceEmployeeSelect">Mitarbeiter:</label>
              <select id="absenceEmployeeSelect" name="absenceEmployeeSelect" required>
                  <option value="">Bitte auswählen...</option>
                  </select>
            </div>
          <hr>
          <h3>Erfasste Abwesenheiten für ausgewählten Mitarbeiter</h3>
          <div class="table-wrapper">
              <table id="absencesTable">
                  <thead>
                      <tr>
                          <th>Datum</th>
                          <th>Typ</th>
                          <th>Gutschrift Std.</th>
                          <th>Kommentar</th>
                          <th>Aktion</th>
                        </tr>
                    </thead>
                  <tbody>
                      <tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>
                      </tbody>
                </table>
            </div>

          <hr>

          <form id="addAbsenceForm">
             <h3>Neue Abwesenheit hinzufügen</h3>
             <input type="hidden" id="addAbsenceEmployeeId" name="employeeId"> <div>
                  <label for="addAbsenceDate">Datum:</label>
                  <input type="date" id="addAbsenceDate" name="date" required>
                </div>
              <div>
                  <label for="addAbsenceType">Typ:</label>
                  <select id="addAbsenceType" name="absenceType" required>
                      <option value="">Bitte auswählen...</option>
                      <option value="VACATION">Urlaub</option>
                      <option value="SICK">Krank</option>
                      <option value="PUBLIC_HOLIDAY">Gesetzl. Feiertag (NRW)</option>
                      </select>
                </div>
                <div>
                    <label for="addAbsenceComment">Kommentar (optional):</label>
                    <input type="text" id="addAbsenceComment" name="comment">
                </div>
              <button type="submit" id="addAbsenceSubmitBtn" disabled>Speichern</button>
              <small id="absenceFormNote" style="display: block; margin-top: 5px;">Bitte zuerst oben einen Mitarbeiter auswählen.</small>
           </form>

           <hr>

           <form id="generateHolidaysForm">
                <h3>Feiertage automatisch generieren (NRW)</h3>
                <div>
                     <label for="generateHolidaysYear">Jahr:</label>
                     <input type="number" id="generateHolidaysYear" name="generateHolidaysYear" min="2020" max="2035" required> <button type="button" id="generateHolidaysBtn">Generieren</button>
                 </div>
                 <div id="generateHolidaysResult"></div> <small>Erstellt automatisch Feiertagseinträge für alle Mitarbeiter für das gewählte Jahr, sofern sie an dem Tag Soll-Stunden haben und der Tag auf Mo-Fr fällt. Bestehende Einträge für diese Tage werden nicht überschrieben.</small>
            </form>
            </div>

            <div id="tab-reports" class="tab-content hidden">
                <h2>Auswertungen</h2>
                <form id="balanceForm">
                  <div>
                      <label for="balanceName">Mitarbeiter:</label>
                      <select id="balanceName" name="balanceName" required>
                          <option value="">Bitte auswählen...</option>
                          </select>
                    </div>
                  <div>
                      <label for="balanceYear">Jahr:</label>
                      <input type="number" id="balanceYear" name="balanceYear" required min="2020" max="2035">
                    </div>
                  <div>
                      <label for="periodTypeSelect">Zeitraum:</label>
                      <select id="periodTypeSelect" name="periodType" required>
                          <option value="MONTH" selected>Monat</option>
                          <option value="QUARTER">Quartal</option>
                          <option value="YEAR">Gesamtjahr</option>
                        </select>
                    </div>
                  <div id="monthSelectDiv">
                      <label for="balanceMonth">Monat:</label>
                      <input type="number" id="balanceMonth" name="balanceMonth" required min="1" max="12">
                    </div>
                  <div id="quarterSelectDiv" class="hidden">
                      <label for="balanceQuarter">Quartal:</label>
                      <select id="balanceQuarter" name="balanceQuarter" required>
                          <option value="1">Q1 (Jan-Mrz)</option>
                          <option value="2">Q2 (Apr-Jun)</option>
                          <option value="3">Q3 (Jul-Sep)</option>
                          <option value="4">Q4 (Okt-Dez)</option>
                        </select>
                    </div>
                  <button type="submit">Berechnen</button>
                </form>
                <br>
                <button id="downloadPdfBtn" disabled>PDF Herunterladen</button>
                <div id="balanceResult" style="margin-top: 1rem; padding: 15px; background-color: #f9f9f9; border-radius: 4px;">
                    </div>
            </div> </div> </div> <script>
    // Globale Variablen
    let currentWorkEntryId = null; // Hält die ID des aktuell offenen Arbeitszeit-Eintrags
    let currentBalanceData = null; // Hält die Daten der letzten Berechnung für PDF
              // ==== DOM-Referenzen ====
    // Benutzerseite
    const employeeSelect = document.getElementById('employeeSelect');
    const workTimeBtn = document.getElementById('workTimeBtn');
    const displayDateInput = document.getElementById('displayDate');
    const displayStartTimeInput = document.getElementById('displayStartTime');
    const displayEndTimeInput = document.getElementById('displayEndTime');
    const bookingDetailsDiv = document.getElementById('bookingDetails'); // Korrigiert
    const summaryHoursDiv = document.getElementById('summaryHours');
    const dailyTotalHoursSpan = document.getElementById('dailyTotalHours');
    const monthlyTotalHoursSpan = document.getElementById('monthlyTotalHours');

    // Admin Login
    const adminLoginFormElement = document.getElementById('adminLoginForm');

    // Admin Tabs & Content
    const adminTabsContainer = document.getElementById('adminTabs');
    const workHoursTabContent = document.getElementById('tab-workhours');
    const employeesTabContent = document.getElementById('tab-employees');
    const absencesTabContent = document.getElementById('tab-absences');
    const reportsTabContent = document.getElementById('tab-reports');

    // Arbeitszeiten Tab Elemente
    const filterEmployeeSelect = document.getElementById('filterEmployeeSelect');
    const filterMonthInput = document.getElementById('filterMonthInput');
    const applyWorkHoursFilterBtn = document.getElementById('applyWorkHoursFilter');
    const workHoursTableBody = document.querySelector('#workHoursTable tbody');
    const adminDownloadCsvBtn = document.getElementById('adminDownloadCsv');
    const adminDeleteDataBtn = document.getElementById('adminDeleteData');
    const editWorkHoursSection = document.getElementById('editWorkHoursSection');
    const editWorkHoursForm = document.getElementById('editForm');

    // Mitarbeiter Tab Elemente
    const employeeListBody = document.querySelector('#employeeTable tbody');
    const addEmployeeFormElement = document.getElementById('addEmployeeForm');
    const editEmployeeSection = document.getElementById('editEmployeeSection');
    const editEmployeeFormElement = document.getElementById('editEmployeeForm');
    const addEmployeeSection = document.getElementById('addEmployeeSection');

    // Abwesenheiten Tab Elemente
    const absenceEmployeeSelect = document.getElementById('absenceEmployeeSelect');
    const absencesTableBody = document.querySelector('#absencesTable tbody');
    const addAbsenceForm = document.getElementById('addAbsenceForm');
    const addAbsenceEmployeeIdInput = document.getElementById('addAbsenceEmployeeId');
    const addAbsenceDateInput = document.getElementById('addAbsenceDate');
    const addAbsenceTypeSelect = document.getElementById('addAbsenceType');
    const addAbsenceCommentInput = document.getElementById('addAbsenceComment');
    const addAbsenceSubmitBtn = document.getElementById('addAbsenceSubmitBtn');
    const absenceFormNote = document.getElementById('absenceFormNote');

    // Feiertagsgenerierung Elemente
    const generateHolidaysForm = document.getElementById('generateHolidaysForm');
    const generateHolidaysYearInput = document.getElementById('generateHolidaysYear');
    const generateHolidaysBtn = document.getElementById('generateHolidaysBtn');
    const generateHolidaysResultDiv = document.getElementById('generateHolidaysResult');

    // Auswertungsformular Elemente
    const balanceForm = document.getElementById('balanceForm');
    const balanceNameSelect = document.getElementById('balanceName');
    const balanceYearInput = document.getElementById('balanceYear');
    const periodTypeSelect = document.getElementById('periodTypeSelect');
    const monthSelectDiv = document.getElementById('monthSelectDiv');
    const balanceMonthInput = document.getElementById('balanceMonth');
    const quarterSelectDiv = document.getElementById('quarterSelectDiv');
    const balanceQuarterSelect = document.getElementById('balanceQuarter');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const balanceResultDiv = document.getElementById('balanceResult');

    // ==== Initialisierung ====
    document.addEventListener('DOMContentLoaded', () => {
      resetWorkTimeForm();
      loadEmployeeOptions(); // Füllt Haupt-Dropdown und Admin-Dropdowns gleichzeitig
      // populateEmployeeFilterOptions(); // Wird jetzt von loadEmployeeOptions miterledigt
      setupEventListeners();
      const now = new Date();
      // Setze Standardwerte für Auswertungen und Feiertagsgenerierung
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;
      if(balanceYearInput) balanceYearInput.value = currentYear;
      if(balanceMonthInput) balanceMonthInput.value = currentMonth;
      if(periodTypeSelect) periodTypeSelect.value = 'MONTH';
      handlePeriodTypeChange(); // Stellt sicher, dass die korrekten Felder angezeigt werden
      if(generateHolidaysYearInput) generateHolidaysYearInput.value = currentYear;
      if(filterMonthInput) { // Standardfilter auf aktuellen Monat setzen
         filterMonthInput.value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
      }
    });

    // ==== Event Listener Setup ====
    function setupEventListeners() {
        // Benutzerseite
        if (employeeSelect) employeeSelect.addEventListener('change', handleEmployeeSelection); else console.error("Element not found: employeeSelect");
        if (workTimeBtn) workTimeBtn.addEventListener('click', handleWorkTimeToggle); else console.error("Element not found: workTimeBtn");

        // Admin
        if (adminLoginFormElement) adminLoginFormElement.addEventListener('submit', handleAdminLogin); else console.error("Element not found: adminLoginForm");

        // Tabs
        document.querySelectorAll('.tabs li').forEach(tab => {
            if(tab) tab.addEventListener('click', handleTabSwitch); else console.error("Element not found: .tabs li");
        });

        // Arbeitszeiten Tab
        if (applyWorkHoursFilterBtn) applyWorkHoursFilterBtn.addEventListener('click', loadAdminWorkHours); else console.error("Element not found: applyWorkHoursFilter");
        if (adminDownloadCsvBtn) adminDownloadCsvBtn.addEventListener('click', downloadAdminCsv); else console.error("Element not found: adminDownloadCsv");
        if (adminDeleteDataBtn) adminDeleteDataBtn.addEventListener('click', deleteAllWorkHours); else console.error("Element not found: adminDeleteData");
        // Formular im Edit-Bereich wird über Buttons getriggert (onclick)

        // Mitarbeiter Tab
        if (addEmployeeFormElement) addEmployeeFormElement.addEventListener('submit', handleAddEmployee); else console.error("Element not found: addEmployeeForm");
        // Edit-Formular wird über Buttons getriggert (onclick)

        // Abwesenheiten Tab
        if (absenceEmployeeSelect) absenceEmployeeSelect.addEventListener('change', handleAbsenceEmployeeSelectChange); else console.error("Element not found: absenceEmployeeSelect");
        if (addAbsenceForm) addAbsenceForm.addEventListener('submit', handleAddAbsence); else console.error("Element not found: addAbsenceForm");
        if (generateHolidaysBtn) generateHolidaysBtn.addEventListener('click', handleGenerateHolidays); else console.error("Element not found: generateHolidaysBtn");

        // Auswertungen Tab
        if (balanceForm) balanceForm.addEventListener('submit', handleCalculateBalance); else console.error("Element not found: balanceForm");
        if (periodTypeSelect) periodTypeSelect.addEventListener('change', handlePeriodTypeChange); else console.error("Element not found: periodTypeSelect");
        if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', handleDownloadPdf); else console.error("Element not found: downloadPdfBtn");
    }
              // ==== Allgemeine Hilfsfunktionen ====
    async function fetchEmployees() {
        try {
            const response = await fetch('/employees'); // Öffentlicher Endpunkt
            if (!response.ok) throw new Error(`Laden der Mitarbeiterliste fehlgeschlagen (${response.status}).`);
            return await response.json();
        } catch (err) {
            console.error("Fehler beim Laden der Mitarbeiterliste:", err);
            alert("❌ Fehler: Mitarbeiterliste konnte nicht geladen werden. " + err.message);
            return []; // Leeres Array zurückgeben, um Folgefehler zu vermeiden
        }
    }

    // Füllt ein <select> Element mit Optionen aus der Mitarbeiterliste
    function populateSelectWithOptions(selectElement, employees, useIdAsValue = false, defaultOptionText = "Bitte auswählen", includeAllOption = false, allOptionValue = "") {
        if (!selectElement) {
            console.error("populateSelectWithOptions: Ungültiges Select-Element übergeben!");
            return;
        }
        // Vorherige Optionen löschen, außer dem Standard-Platzhalter
        selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; // Verwende leeren String als Standardwert

        // Option "Alle Mitarbeiter" hinzufügen, falls gewünscht
        if(includeAllOption) {
             const allOption = document.createElement('option');
             allOption.value = allOptionValue || "all"; // Wert für "Alle"
             allOption.textContent = "Alle Mitarbeiter";
             selectElement.appendChild(allOption);
        }

        // Mitarbeiter-Optionen hinzufügen
        employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = useIdAsValue ? emp.id : emp.name; // Wert ist ID oder Name
            option.textContent = emp.name; // Text ist immer Name
            selectElement.appendChild(option);
        });
    }

    // Lädt Mitarbeiter und befüllt ALLE relevanten Dropdowns
    async function loadEmployeeOptions() {
        const employees = await fetchEmployees();

        // Haupt-Dropdown (Benutzer)
        populateSelectWithOptions(employeeSelect, employees, false, "Bitte auswählen"); // Wert = Name

        // Admin-Filter-Dropdown (Arbeitszeiten)
        populateSelectWithOptions(filterEmployeeSelect, employees, true, "Alle Mitarbeiter", false, ""); // Wert = ID, Standardwert leer

        // Admin-Dropdown (Abwesenheiten)
        populateSelectWithOptions(absenceEmployeeSelect, employees, true, "Bitte auswählen..."); // Wert = ID

        // Admin-Dropdown (Auswertungen)
        // populateSelectWithOptions(balanceNameSelect, employees, true, "Bitte auswählen..."); // Wert = ID
        // Korrektur: In Auswertungen wird der Name als Value gebraucht für die calculate Funktion
         populateSelectWithOptions(balanceNameSelect, employees, false, "Bitte auswählen..."); // Wert = Name


        if (employees.length === 0) {
            console.warn("Keine Mitarbeiter gefunden oder Fehler beim Laden.");
            // Optional: Fehlermeldung in Dropdowns anzeigen
             const errorMsg = '<option value="">Fehler/Keine MA</option>';
             if(employeeSelect) employeeSelect.innerHTML = errorMsg;
             if(filterEmployeeSelect) filterEmployeeSelect.innerHTML = errorMsg;
             if(absenceEmployeeSelect) absenceEmployeeSelect.innerHTML = errorMsg;
             if(balanceNameSelect) balanceNameSelect.innerHTML = errorMsg;
        }
    }

     // Wrapper - wird nicht mehr direkt gebraucht, da loadEmployeeOptions alles macht
     // async function populateEmployeeFilterOptions() { loadEmployeeOptions(); }

    // ==== Funktionen Zeiterfassung (Benutzer) ====
     function handleEmployeeSelection() {
         // Wenn ein Mitarbeiter ausgewählt wird, prüfe den Buchungsstatus
         checkNextBookingAction();
         // Verstecke vorherige Buchungsdetails
         if(bookingDetailsDiv) bookingDetailsDiv.classList.add('hidden');
     }

     async function checkNextBookingAction() {
         const name = employeeSelect.value;
         resetBookingDetails(); // Setzt Button und Details zurück
         workTimeBtn.disabled = true; // Button deaktivieren bis Status klar ist
         currentWorkEntryId = null; // Reset der ID

         if (!name) { // Kein Mitarbeiter ausgewählt
             workTimeBtn.textContent = 'Bitte Mitarbeiter wählen';
             return;
         }

         workTimeBtn.textContent = 'Status wird geprüft...';

         try {
             const response = await fetch(`/next-booking-details?name=${encodeURIComponent(name)}`);
             if (!response.ok) throw new Error(`Fehler ${response.status} beim Abrufen des Buchungsstatus.`);
             const data = await response.json();

             if (data.nextBooking === 'arbeitsende') {
                 // Letzter Eintrag ist offen -> Arbeitsende anbieten
                 workTimeBtn.textContent = 'Arbeitsende buchen';
                 workTimeBtn.style.backgroundColor = 'orange';
                 currentWorkEntryId = data.id; // ID des offenen Eintrags speichern
                 workTimeBtn.disabled = false;

                 // Zeige Details des offenen Eintrags an
                 if(bookingDetailsDiv) bookingDetailsDiv.classList.remove('hidden');
                 if (data.startDate) {
                    // Versuche Datum zu formatieren
                     try {
                        // Annahme: data.startDate ist YYYY-MM-DD
                        const dateObj = new Date(data.startDate + 'T00:00:00Z'); // Als UTC interpretieren
                        displayDateInput.value = dateObj.toLocaleDateString('de-DE', { timeZone: 'UTC' });
                     } catch(e) { displayDateInput.value = data.startDate; } // Fallback
                 }
                 displayStartTimeInput.value = data.startTime ? data.startTime + " Uhr" : 'Unbekannt';
                 displayEndTimeInput.value = '---'; // Noch kein Ende gebucht
                 if(summaryHoursDiv) summaryHoursDiv.classList.add('hidden'); // Keine Zusammenfassung anzeigen

             } else {
                 // Kein offener Eintrag -> Arbeitsbeginn anbieten
                 workTimeBtn.textContent = 'Arbeitsbeginn buchen';
                 workTimeBtn.style.backgroundColor = ''; // Standardfarbe
                 workTimeBtn.disabled = false;
                 // Optional: Zeige letzte Buchung oder heutige Zusammenfassung? Hier: Nichts anzeigen
                 const today = new Date().toISOString().split('T')[0];
                 // displaySummaryHours(name, today); // Zeige heutige Stunden (optional)
             }
         } catch (error) {
             console.error("Fehler beim Prüfen des nächsten Buchungsschritts:", error);
             alert("❌ Fehler beim Abrufen des Buchungsstatus: " + error.message);
             workTimeBtn.textContent = 'Fehler beim Laden';
         }
     }

     async function handleWorkTimeToggle() {
         const name = employeeSelect.value;
         if (!name) return; // Sollte nicht passieren, da Button deaktiviert ist

         const action = workTimeBtn.textContent.includes('Arbeitsbeginn') ? 'start' : 'end';
         const now = new Date();
         const date = now.toISOString().split("T")[0]; // YYYY-MM-DD
         const time = now.toTimeString().slice(0, 5); // HH:MM
         const displayDate = now.toLocaleDateString('de-DE'); // Für Anzeige

         workTimeBtn.disabled = true; // Button während der Aktion deaktivieren
         workTimeBtn.textContent = 'Buchung wird verarbeitet...';

         if (action === 'start') {
             try {
                 const response = await fetch("/log-start", {
                     method: "POST",
                     headers: { "Content-Type": "application/json" },
                     body: JSON.stringify({ name, date, startTime: time })
                 });

                 const result = await response.json(); // Versuche immer JSON zu parsen

                 if (response.ok) {
                     alert("✅ Arbeitsbeginn erfolgreich gebucht.");
                     currentWorkEntryId = result.id; // ID des neuen Eintrags speichern
                     // Zeige Details der neuen Buchung (ohne Endzeit)
                     if(bookingDetailsDiv) bookingDetailsDiv.classList.remove('hidden');
                     displayDateInput.value = displayDate;
                     displayStartTimeInput.value = time + " Uhr";
                     displayEndTimeInput.value = '---';
                     if(summaryHoursDiv) summaryHoursDiv.classList.add('hidden');
                 } else {
                     // Zeige Fehlermeldung vom Server an
                     throw new Error(result.message || `Serverfehler ${response.status}`);
                 }
             } catch (err) {
                 console.error("Fehler beim Buchen des Arbeitsbeginns:", err);
                 alert("❌ Fehler beim Buchen des Arbeitsbeginns: " + err.message);
             } finally {
                 checkNextBookingAction(); // Aktualisiere Button und Status
             }
         } else { // action === 'end'
             if (!currentWorkEntryId) {
                 alert("Fehler: Konnte die ID des offenen Eintrags nicht finden. Bitte Seite neu laden.");
                 checkNextBookingAction(); // Status neu prüfen
                 return;
             }
             try {
                 const comment = ""; // Kommentarfeld nicht im UI, daher leer
                 const response = await fetch(`/log-end/${currentWorkEntryId}`, {
                     method: "PUT",
                     headers: { "Content-Type": "application/json" },
                     body: JSON.stringify({ endTime: time, comment: comment || null })
                 });

                 const result = await response.json(); // Versuche immer JSON zu parsen

                 if (response.ok) {
                     alert("✅ Arbeitsende erfolgreich gebucht.");
                     displayEndTimeInput.value = time + " Uhr"; // Endzeit anzeigen
                     currentWorkEntryId = null; // Eintrag ist abgeschlossen

                     // Berechne Datum für Zusammenfassung (könnte Vortag sein bei Nachtschicht)
                     let summaryDate = date;
                     if(displayDateInput.value) {
                         try {
                            // Versuche Datum aus Anzeige zu parsen (DD.MM.YYYY)
                            const dateParts = displayDateInput.value.split('.');
                            if(dateParts.length === 3) {
                                 summaryDate = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                            }
                         } catch (e) { console.warn("Konnte Datum aus Anzeige nicht für Zusammenfassung parsen", e); }
                     }
                     displaySummaryHours(name, summaryDate); // Stunden anzeigen

                 } else {
                     throw new Error(result.message || `Serverfehler ${response.status}`);
                 }
             } catch (err) {
                 console.error("Fehler beim Buchen des Arbeitsendes:", err);
                 alert("❌ Fehler beim Buchen des Arbeitsendes: " + err.message);
             } finally {
                checkNextBookingAction(); // Aktualisiere Button und Status
             }
         }
     }

     async function displaySummaryHours(employeeName, dayDate) {
         if (!employeeName || !dayDate || !summaryHoursDiv || !dailyTotalHoursSpan || !monthlyTotalHoursSpan) return;

         // Datum für die Anfrage sicherstellen (YYYY-MM-DD)
         let queryDate = dayDate;
         if (!/^\d{4}-\d{2}-\d{2}$/.test(dayDate)) {
             try {
                 const dateParts = dayDate.split('.'); // Annahme DD.MM.YYYY
                 if (dateParts.length === 3) {
                     queryDate = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                 } else { throw new Error("Ungültiges Datumsformat für Zusammenfassung"); }
             } catch(e){
                 console.error("Konnte Datum nicht für Summary-Anfrage parsen:", dayDate, e);
                 queryDate = new Date().toISOString().split('T')[0]; // Fallback auf heute
             }
         }

         summaryHoursDiv.classList.remove('hidden');
         dailyTotalHoursSpan.textContent = 'lade...';
         monthlyTotalHoursSpan.textContent = 'lade...';

         try {
             const response = await fetch(`/summary-hours?name=${encodeURIComponent(employeeName)}&date=${queryDate}`);
             if (!response.ok) throw new Error(`Fehler ${response.status} beim Laden der Stundenübersicht.`);

             const summary = await response.json();
             dailyTotalHoursSpan.textContent = `${summary.dailyHours ? summary.dailyHours.toFixed(2) : '0.00'} Std.`;
             monthlyTotalHoursSpan.textContent = `${summary.monthlyHours ? summary.monthlyHours.toFixed(2) : '0.00'} Std.`;

         } catch (error) {
             console.error("Fehler beim Anzeigen der Stundenzusammenfassung:", error);
             dailyTotalHoursSpan.textContent = 'Fehler';
             monthlyTotalHoursSpan.textContent = 'Fehler';
         }
     }

     function resetWorkTimeForm() {
         if(employeeSelect) employeeSelect.value = ''; // Dropdown zurücksetzen
         if(workTimeBtn) {
             workTimeBtn.textContent = 'Bitte Mitarbeiter wählen';
             workTimeBtn.style.backgroundColor = '';
             workTimeBtn.disabled = true;
         }
         resetBookingDetails();
         if(bookingDetailsDiv) bookingDetailsDiv.classList.add('hidden'); // Details ausblenden
     }

     function resetBookingDetails() {
         if(displayDateInput) displayDateInput.value = '';
         if(displayStartTimeInput) displayStartTimeInput.value = '';
         if(displayEndTimeInput) displayEndTimeInput.value = '';
         if(summaryHoursDiv) summaryHoursDiv.classList.add('hidden');
         if(dailyTotalHoursSpan) dailyTotalHoursSpan.textContent = '--';
         if(monthlyTotalHoursSpan) monthlyTotalHoursSpan.textContent = '--';
         currentWorkEntryId = null; // Wichtig: ID zurücksetzen
     }
              // ==== Admin-Funktionen ====
    async function handleAdminLogin(e) {
         e.preventDefault(); // Standard-Formularabsendung verhindern
         const passwordInput = document.getElementById("adminPassword");
         if (!passwordInput || !adminLoginFormElement || !adminTabsContainer) return;
         const password = passwordInput.value;
         if (!password) {
             alert("Bitte Passwort eingeben.");
             return;
         }

         const loginButton = adminLoginFormElement.querySelector('button[type="submit"]');
         loginButton.disabled = true;
         loginButton.textContent = 'Anmeldung läuft...';

         try {
             const response = await fetch("/admin-login", {
                 method: "POST",
                 headers: { "Content-Type": "application/json" },
                 body: JSON.stringify({ password }),
                 credentials: "include" // Wichtig: Sendet Cookies für die Session
             });

             const responseText = await response.text(); // Text-Antwort lesen

             if (response.ok) {
                 alert("✅ Admin erfolgreich angemeldet.");
                 passwordInput.value = ""; // Passwortfeld leeren
                 adminTabsContainer.classList.remove("hidden"); // Admin-Bereich anzeigen
                 adminLoginFormElement.classList.add("hidden"); // Login-Formular ausblenden
                 // Ersten Tab (Arbeitszeiten) standardmäßig aktivieren und Daten laden
                 handleTabSwitch({ currentTarget: document.querySelector('.tabs li[data-tab="workhours"]') });
             } else {
                 // Zeige die Fehlermeldung vom Server an
                 alert(`❌ Login fehlgeschlagen (${response.status}): ${responseText}`);
             }
         } catch (error) {
             console.error("Netzwerkfehler beim Admin-Login:", error);
             alert("❌ Netzwerkfehler beim Login. Bitte Server prüfen.");
         } finally {
             loginButton.disabled = false;
             loginButton.textContent = 'Anmelden';
         }
     }

    function handleTabSwitch(event) {
        if (!event || !event.currentTarget) return; // Sicherstellen, dass das Event-Objekt gültig ist

        const clickedTab = event.currentTarget;
        const targetTabName = clickedTab.getAttribute("data-tab");
        if(!targetTabName) return;

        // Alle Tabs deselektieren und alle Inhalte ausblenden
        document.querySelectorAll(".tabs li").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(tc => tc.classList.add("hidden"));

        // Angeklickten Tab aktivieren und zugehörigen Inhalt anzeigen
        clickedTab.classList.add("active");
        const targetContentId = "tab-" + targetTabName;
        const targetContent = document.getElementById(targetContentId);

        if (targetContent) {
            targetContent.classList.remove("hidden");

            // Spezifische Aktionen beim Wechseln zu einem Tab
            switch (targetTabName) {
                case 'workhours':
                    // Wenn Filter-Dropdown leer ist (oder nur Default hat), neu laden
                    if (!filterEmployeeSelect.options || filterEmployeeSelect.options.length <= 1) {
                         loadEmployeeOptions(); // Lädt alle Dropdowns neu
                    }
                    // Wenn Tabelle leer ist oder Initialmeldung enthält, Filter anfordern
                    if (!workHoursTableBody.firstChild || workHoursTableBody.innerHTML.includes('Filter auswählen')) {
                         workHoursTableBody.innerHTML = '<tr><td colspan="7">Bitte Filter auswählen und anwenden.</td></tr>';
                         // Optional: loadAdminWorkHours() direkt aufrufen, wenn ein Standardfilter gesetzt ist?
                    }
                    cancelEditWorkHours(); // Editierbereich ausblenden/zurücksetzen
                    break;
                case 'employees':
                    loadEmployees(); // Mitarbeiterliste immer neu laden
                    cancelEditEmployee(); // Editierbereich ausblenden/zurücksetzen
                    break;
                case 'absences':
                    // Wenn Abwesenheits-Dropdown leer ist, neu laden
                    if (!absenceEmployeeSelect.options || absenceEmployeeSelect.options.length <= 1) {
                         loadEmployeeOptions();
                    }
                    // Tabelle und Formular zurücksetzen
                    if(absencesTableBody) absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>';
                    if(addAbsenceForm) addAbsenceForm.reset();
                    if(addAbsenceSubmitBtn) addAbsenceSubmitBtn.disabled = true;
                    if(absenceFormNote) absenceFormNote.style.display = 'block'; // Hinweis anzeigen
                    if(addAbsenceEmployeeIdInput) addAbsenceEmployeeIdInput.value = "";
                    // Reset für Feiertagsgenerierung
                    if(generateHolidaysResultDiv) generateHolidaysResultDiv.innerHTML = "";
                    if(generateHolidaysYearInput) generateHolidaysYearInput.value = new Date().getFullYear();
                    break;
                case 'reports':
                     // Wenn Auswertungs-Dropdown leer ist, neu laden
                    if (!balanceNameSelect.options || balanceNameSelect.options.length <= 1) {
                         loadEmployeeOptions();
                    }
                    if(balanceResultDiv) balanceResultDiv.innerHTML = ''; // Ergebnisbereich leeren
                    if(downloadPdfBtn) downloadPdfBtn.disabled = true; // PDF Button deaktivieren
                    handlePeriodTypeChange(); // Korrekte Felder anzeigen (Monat/Quartal)
                    currentBalanceData = null; // Reset der Daten für PDF
                    break;
            }
        } else {
             console.error(`Tab-Inhalt für ID '${targetContentId}' nicht gefunden.`);
        }
    }

    // === Arbeitszeiten-Tab Funktionen ===
    async function loadAdminWorkHours() {
        if (!workHoursTableBody || !filterEmployeeSelect || !filterMonthInput || !applyWorkHoursFilterBtn) {
            console.error("Filterelemente oder Tabelle für Arbeitszeiten nicht gefunden");
             if(workHoursTableBody) workHoursTableBody.innerHTML = `<tr><td colspan='7' class='error-message'>Fehler: UI-Elemente fehlen.</td></tr>`;
             return;
        }
        const employeeId = filterEmployeeSelect.value; // Kann leer sein für "Alle"
        const monthValue = filterMonthInput.value; // YYYY-MM

        applyWorkHoursFilterBtn.disabled = true;
        applyWorkHoursFilterBtn.textContent = 'Lade...';
        workHoursTableBody.innerHTML = "<tr><td colspan='7'>Lade Daten...</td></tr>";

        let year = '', month = '';
        if (monthValue) {
            const parts = monthValue.split('-');
            if (parts.length === 2 && parts[0].length === 4 && parts[1].length === 2) {
                year = parts[0];
                month = parts[1];
            } else if (monthValue !== '') {
                 // Ungültiges Format, aber nicht leer
                 workHoursTableBody.innerHTML = "<tr><td colspan='7' style='color:orange;'>Ungültiges Monatsformat. Bitte YYYY-MM verwenden.</td></tr>";
                 applyWorkHoursFilterBtn.disabled = false;
                 applyWorkHoursFilterBtn.textContent = 'Filter anwenden';
                 return;
            }
        }
        // Wenn Monat leer ist, werden alle Zeiten geladen (potenziell viele!)

        // URL mit Query-Parametern bauen
        let fetchUrl = '/admin-work-hours?';
        const params = [];
        if (employeeId) params.push(`employeeId=${encodeURIComponent(employeeId)}`);
        if (year && month) {
             params.push(`year=${encodeURIComponent(year)}`);
             params.push(`month=${encodeURIComponent(month)}`);
        }
        fetchUrl += params.join('&');

        try {
            const response = await fetch(fetchUrl, { credentials: "include" }); // Wichtig für Admin-Session

            if (!response.ok) {
                let errorData = { message: `Serverfehler (${response.status})` };
                try { errorData = await response.json(); } // Versuche JSON-Fehler zu lesen
                catch (e) { try { errorData.message = await response.text(); } catch (e2) {} } // Fallback auf Text-Fehler
                throw new Error(errorData.message || `Laden der Arbeitszeiten fehlgeschlagen`);
            }

            const data = await response.json();
            workHoursTableBody.innerHTML = ""; // Tabelle leeren

            if (data.length === 0) {
                workHoursTableBody.innerHTML = "<tr><td colspan='7'>Keine Arbeitszeiten für die gewählten Filter gefunden.</td></tr>";
            } else {
                data.forEach(entry => {
                    const row = workHoursTableBody.insertRow();
                    const hours = parseFloat(entry.hours) || 0;
                    let displayDate = 'N/A';
                    if (entry.date) { // entry.date sollte YYYY-MM-DD sein
                         try {
                            const dateObj = new Date(entry.date + 'T00:00:00Z'); // Als UTC interpretieren
                            displayDate = dateObj.toLocaleDateString("de-DE", { timeZone: 'UTC' });
                         } catch(e) { displayDate = entry.date; console.warn("Admin Datumskonvertierungsfehler:", entry.date, e); }
                    }

                    row.insertCell().textContent = entry.id;
                    row.insertCell().textContent = entry.name || 'Unbekannt'; // Name aus Join
                    row.insertCell().textContent = displayDate;
                    row.insertCell().textContent = `${entry.startTime || '--:--'} - ${entry.endTime || '--:--'}`;
                    row.insertCell().textContent = hours.toFixed(2);
                    row.insertCell().textContent = entry.comment || '';

                    // Aktions-Buttons
                    const actionCell = row.insertCell();
                    const editButton = document.createElement('button');
                    editButton.textContent = '✎'; // Bearbeiten-Icon
                    editButton.title = 'Bearbeiten';
                    editButton.style.padding = '4px 8px';
                    editButton.style.marginRight = '5px';
                    editButton.onclick = () => editEntry(entry);
                    actionCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = '🗑️'; // Löschen-Icon
                    deleteButton.title = 'Löschen';
                    deleteButton.style.padding = '4px 8px';
                    deleteButton.style.backgroundColor = '#dc3545'; // Roter Hintergrund
                    deleteButton.onclick = () => deleteEntry(entry.id);
                    actionCell.appendChild(deleteButton);
                });
            }
        } catch (error) {
            console.error("Fehler beim Laden der Admin-Arbeitszeiten:", error);
            workHoursTableBody.innerHTML = `<tr><td colspan="7" class="error-message">❌ Fehler: ${error.message}</td></tr>`;
        } finally {
             applyWorkHoursFilterBtn.disabled = false;
             applyWorkHoursFilterBtn.textContent = 'Filter anwenden';
        }
    }

    function editEntry(entry) {
        if(!editWorkHoursForm || !editWorkHoursSection) return;

        // Formular mit Daten füllen
        editWorkHoursForm.elements['id'].value = entry.id;
        editWorkHoursForm.elements['editName'].value = entry.name || "";
        editWorkHoursForm.elements['date'].value = entry.date ? entry.date.split("T")[0] : ""; // Sollte schon YYYY-MM-DD sein
        editWorkHoursForm.elements['startTime'].value = entry.startTime || "";
        editWorkHoursForm.elements['endTime'].value = entry.endTime || "";
        editWorkHoursForm.elements['comment'].value = entry.comment || "";

        // Bereich anzeigen und hinscrollen
        editWorkHoursSection.classList.remove("hidden");
        editWorkHoursSection.scrollIntoView({ behavior: "smooth" });
    }

    function cancelEditWorkHours() {
        if (editWorkHoursSection) editWorkHoursSection.classList.add("hidden");
        if (editWorkHoursForm) editWorkHoursForm.reset();
        // Sicherstellen, dass die ID geleert wird
        if (editWorkHoursForm && editWorkHoursForm.elements['id']) editWorkHoursForm.elements['id'].value = "";
    }

    async function saveChanges() {
        if (!editWorkHoursForm || !editWorkHoursForm.elements['id']) return;
        const id = editWorkHoursForm.elements['id'].value;
        if (!id) return; // Keine ID, nichts zu speichern

        // Daten aus dem Formular sammeln
        const data = {
            id: parseInt(id),
            date: editWorkHoursForm.elements['date'].value,
            startTime: editWorkHoursForm.elements['startTime'].value,
            endTime: editWorkHoursForm.elements['endTime'].value,
            comment: editWorkHoursForm.elements['comment'].value
        };

        // Einfache Validierung
        if (!data.date || !data.startTime || !data.endTime) {
            alert("Bitte Datum, Startzeit und Endzeit ausfüllen.");
            return;
        }

        const saveButton = editWorkHoursForm.querySelector('button[onclick="saveChanges()"]');
        saveButton.disabled = true;
        saveButton.textContent = 'Speichern...';


        try {
            const response = await fetch("/api/admin/update-hours", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                credentials: "include" // Wichtig für Admin-Session
            });

            const resultText = await response.text(); // Antwort lesen

            if (response.ok) {
                alert("✅ Änderungen erfolgreich gespeichert.");
                cancelEditWorkHours(); // Formular ausblenden/zurücksetzen
                loadAdminWorkHours(); // Tabelle neu laden, um Änderungen zu sehen
            } else {
                 // Versuche, eine spezifischere Fehlermeldung zu extrahieren
                 let errorMessage = resultText;
                 try { const errorJson = JSON.parse(resultText); errorMessage = errorJson.message || resultText; } catch(e) { /* War wohl doch nur Text */ }
                 alert(`❌ Fehler beim Speichern (${response.status}): ${errorMessage}`);
            }
        } catch (error) {
            console.error("Netzwerkfehler beim Speichern der Änderungen:", error);
            alert("❌ Netzwerkfehler beim Speichern.");
        } finally {
             saveButton.disabled = false;
             saveButton.textContent = 'Speichern';
        }
    }

    async function deleteEntry(id) {
        if (!confirm(`Sind Sie sicher, dass Sie den Arbeitszeiteintrag mit ID ${id} unwiderruflich löschen möchten?`)) return;

        try {
            const response = await fetch(`/api/admin/delete-hours/${id}`, {
                method: "DELETE",
                credentials: "include" // Wichtig für Admin-Session
            });
            const result = await response.text(); // Antwort lesen

            if (response.ok) {
                alert("✅ Eintrag erfolgreich gelöscht.");
                loadAdminWorkHours(); // Tabelle neu laden
                 cancelEditWorkHours(); // Falls der gelöschte Eintrag gerade bearbeitet wurde
            } else {
                 alert(`❌ Fehler beim Löschen (${response.status}): ${result}`);
            }
        } catch (error) {
            console.error(`Netzwerkfehler beim Löschen von Eintrag ${id}:`, error);
            alert("❌ Netzwerkfehler beim Löschen.");
        }
    }

     async function downloadAdminCsv() {
         // Sammle Filterwerte
         const employeeId = filterEmployeeSelect.value;
         const monthValue = filterMonthInput.value;
         let year = '', month = '';
         if (monthValue) {
             const parts = monthValue.split('-');
             if (parts.length === 2) { year = parts[0]; month = parts[1]; }
         }

         // Baue URL für Download mit Filtern
         let downloadUrl = '/admin-download-csv?';
         const params = [];
         if (employeeId) params.push(`employeeId=${encodeURIComponent(employeeId)}`);
         if (year && month) {
             params.push(`year=${encodeURIComponent(year)}`);
             params.push(`month=${encodeURIComponent(month)}`);
         }
         downloadUrl += params.join('&');

         console.log("Starte CSV-Download für URL:", downloadUrl);
         // Öffne die URL in einem neuen Tab/Fenster, der Server sendet dann die CSV-Datei
         window.open(downloadUrl, '_blank');
     }

    async function deleteAllWorkHours() {
        if (!confirm('WARNUNG!\n\nSind Sie absolut sicher, dass Sie ALLE Arbeitszeiten, Monatsbilanzen UND Abwesenheiten unwiderruflich löschen möchten?\n\nDIESE AKTION KANN NICHT RÜCKGÄNGIG GEMACHT WERDEN!')) return;

        const confirmation = prompt("Bitte geben Sie 'LÖSCHEN' ein, um fortzufahren:");
        if (confirmation !== 'LÖSCHEN') {
            alert("Löschvorgang abgebrochen.");
            return;
        }

        try {
            const response = await fetch('/adminDeleteData', {
                method: 'DELETE',
                credentials: 'include' // Wichtig für Admin-Session
            });
            const result = await response.text(); // Antwort lesen

            if (response.ok) {
                alert(`✅ ${result}`);
                // UI zurücksetzen
                if(workHoursTableBody) workHoursTableBody.innerHTML = '<tr><td colspan="7">Alle Daten gelöscht. Bitte Filter erneut anwenden.</td></tr>';
                if(balanceResultDiv) balanceResultDiv.innerHTML = '';
                if(absencesTableBody) absencesTableBody.innerHTML = '<tr><td colspan="5">Alle Daten gelöscht. Bitte Mitarbeiter auswählen.</td></tr>';
                loadEmployees(); // Mitarbeiterliste neu laden (obwohl MA nicht gelöscht wurden)
            } else {
                 alert(`❌ Fehler beim Löschen aller Daten (${response.status}): ${result}`);
            }
        } catch (error) {
            console.error('Netzwerkfehler beim Löschen aller Daten:', error);
            alert('❌ Netzwerkfehler beim Löschen aller Daten.');
        }
    }
              // ==== Mitarbeiterverwaltung ====
    async function loadEmployees() {
        if(!employeeListBody) {
            console.error("Element nicht gefunden: #employeeList (tbody der Mitarbeitertabelle)");
            return;
        }
        employeeListBody.innerHTML = "<tr><td colspan='8'>Lade Mitarbeiterliste...</td></tr>";

        try {
            const response = await fetch("/admin/employees", { credentials: "include" }); // Admin-Endpunkt
            if (!response.ok) throw new Error(`Fehler beim Laden der Mitarbeiter (${response.status}).`);

            const data = await response.json();
            employeeListBody.innerHTML = ""; // Tabelle leeren

            if (data.length > 0) {
                data.forEach(emp => {
                    const row = employeeListBody.insertRow();
                    row.insertCell().textContent = emp.id;
                    row.insertCell().textContent = emp.name;
                    // Soll-Stunden formatieren
                    row.insertCell().textContent = (emp.mo_hours || 0).toFixed(2);
                    row.insertCell().textContent = (emp.di_hours || 0).toFixed(2);
                    row.insertCell().textContent = (emp.mi_hours || 0).toFixed(2);
                    row.insertCell().textContent = (emp.do_hours || 0).toFixed(2);
                    row.insertCell().textContent = (emp.fr_hours || 0).toFixed(2);

                    // Aktions-Buttons
                    const actionCell = row.insertCell();
                    const editButton = document.createElement('button');
                    editButton.textContent = '✎'; // Bearbeiten-Icon
                    editButton.title = 'Bearbeiten';
                    editButton.style.padding = '4px 8px';
                    editButton.style.marginRight = '5px';
                    editButton.onclick = () => editEmployee(emp); // Übergibt das Mitarbeiterobjekt
                    actionCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = '🗑️'; // Löschen-Icon
                    deleteButton.title = 'Löschen';
                    deleteButton.style.padding = '4px 8px';
                    deleteButton.style.backgroundColor = '#dc3545';
                    deleteButton.onclick = () => deleteEmployee(emp.id, emp.name); // Übergibt ID und Name für Bestätigung
                    actionCell.appendChild(deleteButton);
                });
            } else {
                 employeeListBody.innerHTML = "<tr><td colspan='8'>Keine Mitarbeiter angelegt.</td></tr>";
            }
        } catch (error) {
            console.error("Fehler beim Laden der Mitarbeiterliste (Admin):", error);
            employeeListBody.innerHTML = `<tr><td colspan='8' class="error-message">❌ Fehler: ${error.message}</td></tr>`;
        }
    }

    async function handleAddEmployee(event) {
        event.preventDefault(); // Standard Formularabsendung verhindern
        if (!addEmployeeFormElement) return;

        const form = event.target;
        const data = {
            name: form.employeeName.value.trim(),
            mo_hours: parseFloat(form.mo_hours.value) || 0,
            di_hours: parseFloat(form.di_hours.value) || 0,
            mi_hours: parseFloat(form.mi_hours.value) || 0,
            do_hours: parseFloat(form.do_hours.value) || 0,
            fr_hours: parseFloat(form.fr_hours.value) || 0
        };

        if (!data.name) {
            alert("Bitte einen Namen für den Mitarbeiter eingeben.");
            return;
        }
        // Optional: Validierung der Stundenwerte (z.B. nicht negativ)
        if (Object.values(data).some(val => typeof val === 'number' && val < 0)) {
             alert("Stundenwerte dürfen nicht negativ sein.");
             return;
        }


        const addButton = form.querySelector('button[type="submit"]');
        addButton.disabled = true;
        addButton.textContent = 'Wird hinzugefügt...';

        try {
            const response = await fetch('/admin/employees', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include' // Wichtig für Admin-Session
            });

            const result = await response.json(); // Versuche JSON zu parsen

            if (response.ok) { // Status 201 Created
                alert(`✅ Mitarbeiter "${result.name}" erfolgreich hinzugefügt.`);
                form.reset(); // Formular leeren
                loadEmployees(); // Mitarbeiterliste neu laden
                loadEmployeeOptions(); // Alle Dropdowns aktualisieren
            } else {
                // Zeige Fehlermeldung vom Server (z.B. bei doppeltem Namen - Status 409)
                throw new Error(result.message || `Serverfehler ${response.status}`);
            }
        } catch (error) {
            console.error('Fehler beim Hinzufügen des Mitarbeiters:', error);
             // Versuche Text zu lesen, falls JSON parsen fehlschlug
             if(error instanceof SyntaxError && error.message.includes("valid JSON")) {
                 // Wahrscheinlich Text-Antwort vom Server bei Fehler
                 try {
                     const textError = await response.text();
                     alert(`❌ Fehler beim Hinzufügen (${response.status}): ${textError}`);
                 } catch {
                     alert(`❌ Fehler beim Hinzufügen (${response.status}). Serverantwort nicht lesbar.`);
                 }
             } else {
                alert(`❌ Fehler beim Hinzufügen: ${error.message}`);
             }
        } finally {
            addButton.disabled = false;
            addButton.textContent = 'Hinzufügen';
        }
    }

    function editEmployee(emp) {
        if (!editEmployeeFormElement || !editEmployeeSection || !addEmployeeSection) return;

        // Formular mit aktuellen Daten füllen
        editEmployeeFormElement.elements['id'].value = emp.id;
        editEmployeeFormElement.elements['name'].value = emp.name;
        editEmployeeFormElement.elements['mo_hours'].value = emp.mo_hours || 0;
        editEmployeeFormElement.elements['di_hours'].value = emp.di_hours || 0;
        editEmployeeFormElement.elements['mi_hours'].value = emp.mi_hours || 0;
        editEmployeeFormElement.elements['do_hours'].value = emp.do_hours || 0;
        editEmployeeFormElement.elements['fr_hours'].value = emp.fr_hours || 0;

        // Bereiche anzeigen/ausblenden
        editEmployeeSection.classList.remove("hidden");
        addEmployeeSection.classList.add("hidden"); // Formular zum Hinzufügen ausblenden
        editEmployeeSection.scrollIntoView({ behavior: "smooth" }); // Hinscrollen
    }

    function cancelEditEmployee() {
        if(editEmployeeSection) editEmployeeSection.classList.add("hidden"); // Editierbereich ausblenden
        if(addEmployeeSection) addEmployeeSection.classList.remove("hidden"); // Hinzufügen-Bereich wieder anzeigen
        if(editEmployeeFormElement) editEmployeeFormElement.reset(); // Editierformular zurücksetzen
        // ID sicherheitshalber löschen
        if(editEmployeeFormElement && editEmployeeFormElement.elements['id']) editEmployeeFormElement.elements['id'].value = "";
    }

    async function saveEmployeeChanges() {
        if (!editEmployeeFormElement || !editEmployeeFormElement.elements['id']) return;
        const id = editEmployeeFormElement.elements['id'].value;
        if (!id) return; // Keine ID, kein Speichern

        // Daten aus dem Editierformular sammeln
        const data = {
            id: parseInt(id),
            name: editEmployeeFormElement.elements['name'].value.trim(),
            mo_hours: parseFloat(editEmployeeFormElement.elements['mo_hours'].value) || 0,
            di_hours: parseFloat(editEmployeeFormElement.elements['di_hours'].value) || 0,
            mi_hours: parseFloat(editEmployeeFormElement.elements['mi_hours'].value) || 0,
            do_hours: parseFloat(editEmployeeFormElement.elements['do_hours'].value) || 0,
            fr_hours: parseFloat(editEmployeeFormElement.elements['fr_hours'].value) || 0
        };

        if (!data.name) {
            alert("Name darf nicht leer sein.");
            return;
        }
         if (Object.values(data).some(val => typeof val === 'number' && val < 0)) {
             alert("Stundenwerte dürfen nicht negativ sein.");
             return;
         }


        const saveButton = editEmployeeFormElement.querySelector('button[onclick="saveEmployeeChanges()"]');
        saveButton.disabled = true;
        saveButton.textContent = 'Speichern...';

        try {
            const response = await fetch(`/admin/employees/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include' // Wichtig für Admin-Session
            });

            const result = await response.text(); // Antwort lesen

            if (response.ok) {
                alert(`✅ Mitarbeiterdaten erfolgreich aktualisiert.`);
                cancelEditEmployee(); // Editierbereich schließen
                loadEmployees(); // Mitarbeiterliste neu laden
                loadEmployeeOptions(); // Alle Dropdowns aktualisieren (falls Name geändert)
            } else {
                // Zeige Fehlermeldung vom Server (z.B. Status 409 bei Namenskonflikt)
                 alert(`❌ Fehler beim Aktualisieren (${response.status}): ${result}`);
            }
        } catch (error) {
            console.error("Netzwerkfehler beim Speichern der Mitarbeiteränderungen:", error);
            alert("❌ Netzwerkfehler beim Aktualisieren.");
        } finally {
             saveButton.disabled = false;
             saveButton.textContent = 'Speichern';
        }
    }

    async function deleteEmployee(id, name) {
        if (!confirm(`ACHTUNG!\n\nSind Sie sicher, dass Sie den Mitarbeiter "${name}" (ID: ${id}) und ALLE seine zugehörigen Daten (Arbeitszeiten, Bilanzen, Abwesenheiten) unwiderruflich löschen möchten?\n\nDIESE AKTION KANN NICHT RÜCKGÄNGIG GEMACHT WERDEN!`)) return;

        try {
            const response = await fetch(`/admin/employees/${id}`, {
                method: 'DELETE',
                credentials: 'include' // Wichtig für Admin-Session
            });
            const result = await response.text(); // Antwort lesen

            if (response.ok) {
                alert(`✅ Mitarbeiter "${name}" und alle zugehörigen Daten erfolgreich gelöscht.`);
                loadEmployees(); // Mitarbeiterliste neu laden
                loadEmployeeOptions(); // Alle Dropdowns aktualisieren

                // UI zurücksetzen, falls der gelöschte MA irgendwo ausgewählt war
                if(filterEmployeeSelect && filterEmployeeSelect.value === String(id)) {
                    filterEmployeeSelect.value = ""; // Filter zurücksetzen
                    if(workHoursTableBody) workHoursTableBody.innerHTML = '<tr><td colspan="7">Gelöschter Mitarbeiter war ausgewählt. Bitte Filter anwenden.</td></tr>';
                }
                if(absenceEmployeeSelect && absenceEmployeeSelect.value === String(id)) {
                    absenceEmployeeSelect.value = "";
                    if(absencesTableBody) absencesTableBody.innerHTML = '<tr><td colspan="5">Gelöschter Mitarbeiter war ausgewählt. Bitte Mitarbeiter auswählen.</td></tr>';
                }
                 if(balanceNameSelect && balanceNameSelect.options[balanceNameSelect.selectedIndex]?.text === name) { // Vergleiche Text, da Value hier Name ist
                    balanceNameSelect.value = "";
                     if(balanceResultDiv) balanceResultDiv.innerHTML = '';
                     if(downloadPdfBtn) downloadPdfBtn.disabled = true;
                     currentBalanceData = null;
                 }
                 cancelEditEmployee(); // Sicherstellen, dass Editierformular geschlossen ist
                 cancelEditWorkHours(); // Und das auch

            } else {
                 alert(`❌ Fehler beim Löschen (${response.status}): ${result}`);
            }
        } catch (error) {
            console.error(`Netzwerkfehler beim Löschen von Mitarbeiter ${id}:`, error);
            alert("❌ Netzwerkfehler beim Löschen des Mitarbeiters.");
        }
    }
              // === Funktionen für Abwesenheiten ===
    function handleAbsenceEmployeeSelectChange() {
        const selectedEmployeeId = absenceEmployeeSelect.value;
        const selectedEmployeeName = absenceEmployeeSelect.options[absenceEmployeeSelect.selectedIndex]?.textContent || 'Unbekannt';

        // ID im Formular setzen oder leeren
        if (addAbsenceEmployeeIdInput) addAbsenceEmployeeIdInput.value = selectedEmployeeId;
        // Submit-Button aktivieren/deaktivieren
        if (addAbsenceSubmitBtn) addAbsenceSubmitBtn.disabled = !selectedEmployeeId;
        // Hinweistext anzeigen/ausblenden
        if (absenceFormNote) absenceFormNote.style.display = selectedEmployeeId ? 'none' : 'block';

        // Abwesenheitstabelle laden oder leeren
        if (absencesTableBody) {
            if (selectedEmployeeId) {
                loadAbsences(selectedEmployeeId, selectedEmployeeName); // Lade Daten für ausgewählten MA
            } else {
                 absencesTableBody.innerHTML = '<tr><td colspan="5">Bitte Mitarbeiter auswählen.</td></tr>'; // Leere Tabelle
            }
        }

        // Formular zurücksetzen, wenn Auswahl geändert wird
        if (addAbsenceForm) addAbsenceForm.reset();
         // ID nach Reset wieder setzen, falls MA ausgewählt wurde
         if (addAbsenceEmployeeIdInput && selectedEmployeeId) addAbsenceEmployeeIdInput.value = selectedEmployeeId;

    }

    async function loadAbsences(employeeId, employeeName) {
        if (!employeeId || !absencesTableBody) return;

        absencesTableBody.innerHTML = `<tr><td colspan="5">Lade Abwesenheiten für ${employeeName}...</td></tr>`;

        try {
            const response = await fetch(`/admin/absences?employeeId=${employeeId}`, { credentials: 'include' });
            if (!response.ok) throw new Error(`Fehler ${response.status} beim Laden der Abwesenheiten.`);

            const absences = await response.json();
            absencesTableBody.innerHTML = ''; // Tabelle leeren

            if (absences.length === 0) {
                absencesTableBody.innerHTML = `<tr><td colspan="5">Keine Abwesenheiten für ${employeeName} erfasst.</td></tr>`;
            } else {
                absences.forEach(absence => {
                    const row = absencesTableBody.insertRow();
                    let displayDate = absence.date; // Sollte YYYY-MM-DD sein
                    try {
                         displayDate = new Date(absence.date + 'T00:00:00Z').toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' });
                    } catch(e) { console.warn("Fehler Datumskonvertierung Abwesenheit:", absence.date, e); }

                    // Typ übersetzen
                    let typeText = absence.absence_type;
                    switch(absence.absence_type) {
                        case 'VACATION': typeText = 'Urlaub'; break;
                        case 'SICK': typeText = 'Krank'; break;
                        case 'PUBLIC_HOLIDAY': typeText = 'Feiertag'; break;
                        default: typeText = absence.absence_type; // Falls neue Typen hinzukommen
                    }

                    row.insertCell().textContent = displayDate;
                    row.insertCell().textContent = typeText;
                    row.insertCell().textContent = (absence.credited_hours || 0).toFixed(2);
                    row.insertCell().textContent = absence.comment || '';

                    // Aktion (Löschen)
                    const actionCell = row.insertCell();
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '🗑️'; // Löschen-Icon
                    deleteButton.title = 'Abwesenheit löschen';
                    deleteButton.style.color = 'red'; // Überschreibt evtl. globale Button-Styles
                    deleteButton.style.backgroundColor = 'transparent';
                    deleteButton.style.border = 'none';
                    deleteButton.style.padding = '2px 6px';
                    deleteButton.style.cursor = 'pointer';
                    deleteButton.onclick = () => deleteAbsence(absence.id, employeeId, employeeName); // ID und MA-Infos übergeben
                    actionCell.appendChild(deleteButton);
                });
            }
        } catch (error) {
            console.error(`Fehler beim Laden der Abwesenheiten für Mitarbeiter ID ${employeeId}:`, error);
            absencesTableBody.innerHTML = `<tr><td colspan="5" class="error-message">❌ Fehler: ${error.message}</td></tr>`;
        }
    }

    async function handleAddAbsence(event) {
        event.preventDefault();
        if(!addAbsenceEmployeeIdInput || !addAbsenceDateInput || !addAbsenceTypeSelect || !addAbsenceSubmitBtn) return;

        const employeeId = addAbsenceEmployeeIdInput.value;
        const date = addAbsenceDateInput.value;
        const absenceType = addAbsenceTypeSelect.value;
        const comment = addAbsenceCommentInput.value.trim();
        const employeeName = absenceEmployeeSelect.options[absenceEmployeeSelect.selectedIndex]?.textContent || 'Unbekannt'; // Für Erfolgsmeldung

        // Validierung
        if (!employeeId || !date || !absenceType) {
            alert("Bitte Mitarbeiter, Datum und Abwesenheitstyp auswählen/eingeben.");
            return;
        }

        addAbsenceSubmitBtn.disabled = true;
        addAbsenceSubmitBtn.textContent = 'Speichern...';

        try {
            const response = await fetch('/admin/absences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employeeId, date, absenceType, comment }),
                credentials: 'include' // Wichtig für Admin-Session
            });

             // Versuche immer JSON zu parsen, da auch Fehler als JSON kommen könnten
             const result = await response.json();

            if (response.ok) { // Status 201 Created
                 let displayDateAlert = result.date;
                 try { displayDateAlert = new Date(result.date+'T00:00:00Z').toLocaleDateString('de-DE',{timeZone:'UTC'}); } catch(e) {}
                 let typeText = result.absence_type;
                 switch(result.absence_type) { case 'VACATION': typeText = 'Urlaub'; break; case 'SICK': typeText = 'Krank'; break; case 'PUBLIC_HOLIDAY': typeText = 'Feiertag'; break; }

                 alert(`✅ Abwesenheit (${typeText} am ${displayDateAlert}) für ${employeeName} gespeichert.`);
                 addAbsenceForm.reset(); // Formular leeren
                 addAbsenceEmployeeIdInput.value = employeeId; // MA ID wieder setzen
                 loadAbsences(employeeId, employeeName); // Liste neu laden
            } else {
                // Zeige spezifische Fehlermeldung vom Server an
                throw new Error(result.message || `Serverfehler ${response.status}`);
            }
        } catch (error) {
             console.error("Fehler beim Hinzufügen der Abwesenheit:", error);
              // Fallback für nicht-JSON Fehlerantworten
             if(error instanceof SyntaxError && error.message.includes("valid JSON")) {
                 try {
                     const textError = await response.text(); // Versuche Text zu lesen
                     alert(`❌ Fehler beim Speichern (${response?.status || 'Netzwerk'}): ${textError}`);
                 } catch {
                      alert(`❌ Fehler beim Speichern (${response?.status || 'Netzwerk'}). Serverantwort nicht lesbar.`);
                 }
             } else {
                 alert(`❌ Fehler beim Speichern: ${error.message}`);
             }
        } finally {
             // Button wieder aktivieren, wenn ein Mitarbeiter ausgewählt ist
             addAbsenceSubmitBtn.disabled = !addAbsenceEmployeeIdInput.value;
             addAbsenceSubmitBtn.textContent = 'Speichern';
        }
    }

    async function deleteAbsence(absenceId, employeeId, employeeName) {
        if (!confirm(`Sind Sie sicher, dass Sie den Abwesenheitseintrag (ID: ${absenceId}) für ${employeeName} löschen möchten?`)) return;

        try {
            const response = await fetch(`/admin/absences/${absenceId}`, {
                method: 'DELETE',
                credentials: 'include' // Wichtig für Admin-Session
            });
            const resultText = await response.text(); // Antwort lesen

            if (response.ok) {
                alert("✅ Abwesenheitseintrag erfolgreich gelöscht.");
                loadAbsences(employeeId, employeeName); // Liste neu laden
            } else {
                 alert(`❌ Fehler beim Löschen (${response.status}): ${resultText}`);
            }
        } catch (error) {
            console.error(`Netzwerkfehler beim Löschen von Abwesenheit ${absenceId}:`, error);
            alert("❌ Netzwerkfehler beim Löschen der Abwesenheit.");
        }
    }

    // *** KORRIGIERTE Funktion zum Auslösen der Feiertagsgenerierung ***
    async function handleGenerateHolidays() {
        // Stelle sicher, dass alle benötigten Elemente vorhanden sind
        if (!generateHolidaysYearInput || !generateHolidaysBtn || !generateHolidaysResultDiv) {
            console.error("Fehler: Wichtige Elemente für die Feiertagsgenerierung wurden nicht gefunden (Input, Button oder Result-Div).");
            alert("Ein interner Fehler ist aufgetreten (UI-Elemente fehlen). Bitte Seite neu laden.");
            return;
        }

        const year = generateHolidaysYearInput.value;
        const currentYear = new Date().getFullYear();

        // --- Frontend Validierung ---
        const minYear = currentYear - 5; // Erlaubter Bereich anpassen falls nötig
        const maxYear = currentYear + 5;
        if (!year || isNaN(parseInt(year)) || year < minYear || year > maxYear) {
            alert(`Bitte geben Sie ein gültiges Jahr zwischen ${minYear} und ${maxYear} ein.`);
            generateHolidaysResultDiv.textContent = 'Ungültiges Jahr.';
            generateHolidaysResultDiv.className = 'error-message';
            return;
        }

        if (!confirm(`Sollen die gesetzlichen Feiertage für das Jahr ${year} für alle Mitarbeiter automatisch eingetragen werden? Nur Tage, an denen Soll-Stunden existieren, werden berücksichtigt. Bestehende Einträge (auch für andere Abwesenheiten an diesen Tagen) werden NICHT überschrieben.`)) {
            return; // Benutzer hat Abbrechen gewählt
        }

        // --- UI Feedback und Deaktivierung ---
        generateHolidaysResultDiv.textContent = `Generiere Feiertage für ${year}... Bitte warten.`;
        generateHolidaysResultDiv.className = 'working-message'; // Zeigt "Wird bearbeitet..." Stil
        generateHolidaysBtn.disabled = true; // Button während der Anfrage deaktivieren

        try {
            // --- Fetch-Anfrage an den Server ---
            const response = await fetch('/admin/generate-holidays', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // CSRF-Token hinzufügen, falls implementiert
                },
                body: JSON.stringify({ year: parseInt(year) }),
                credentials: 'include' // WICHTIG: Sendet Cookies (für Session-Authentifizierung) mit
            });

            // *** KORREKTUR START: Prüfe response.ok VOR dem JSON-Parsing ***
            if (response.ok) {
                // Server hat erfolgreich geantwortet (Status 2xx)
                const resultData = await response.json(); // Jetzt sicher JSON parsen
                generateHolidaysResultDiv.textContent = `✅ ${resultData.message || 'Erfolgreich.'} (${resultData.generated} erstellt, ${resultData.skipped} übersprungen für ${resultData.employees} Mitarbeiter).`;
                generateHolidaysResultDiv.className = 'success-message';

                // Optional: Lade Abwesenheiten neu, wenn gerade ein Mitarbeiter im Tab ausgewählt ist
                if (absenceEmployeeSelect && absenceEmployeeSelect.value) {
                    const employeeName = absenceEmployeeSelect.options[absenceEmployeeSelect.selectedIndex]?.textContent || 'Ausgewählter MA';
                    loadAbsences(absenceEmployeeSelect.value, employeeName); // Funktion zum Neuladen der Abwesenheitsliste
                }
            } else {
                // Server hat mit einem Fehler geantwortet (z.B. 403 Forbidden, 400 Bad Request, 500 Internal Server Error)
                const errorText = await response.text(); // Lese die Fehlermeldung als Text
                console.error(`Fehler vom Server (${response.status}) bei Feiertagsgenerierung: ${errorText}`);
                generateHolidaysResultDiv.textContent = `❌ Fehler ${response.status}: ${errorText || 'Unbekannter Serverfehler.'}`;
                generateHolidaysResultDiv.className = 'error-message';
                // Spezifische Meldung für 403, falls der Text passt (Verbesserte Fehlermeldung für Benutzer)
                if (response.status === 403 && errorText.toLowerCase().includes('zugriff verweigert')) {
                    generateHolidaysResultDiv.textContent = `❌ Fehler ${response.status}: Zugriff verweigert. Bitte als Admin anmelden. Ihre Sitzung ist möglicherweise abgelaufen.`;
                }
            }
            // *** KORREKTUR ENDE ***

        } catch (error) {
            // Fehler bei der Netzwerkkommunikation selbst (z.B. Server nicht erreichbar) oder beim Parsen (sollte durch response.ok Check seltener sein)
            console.error("Fehler bei Feiertagsgenerierung (Fetch oder Parsing):", error);
            generateHolidaysResultDiv.textContent = '❌ Netzwerkfehler oder Server antwortet nicht/inkorrekt.';
            generateHolidaysResultDiv.className = 'error-message';

        } finally {
            // Button immer wieder aktivieren, egal ob Erfolg oder Fehler
            generateHolidaysBtn.disabled = false;
        }
    }
    // *** ENDE KORRIGIERTE Funktion ***
              // === Auswertungen ===
    function handlePeriodTypeChange() {
        if(!periodTypeSelect || !monthSelectDiv || !quarterSelectDiv || !balanceMonthInput || !balanceQuarterSelect || !downloadPdfBtn || !balanceResultDiv) return;

        const selectedType = periodTypeSelect.value;

        // Sichtbarkeit der Monats-/Quartalsauswahl steuern
        monthSelectDiv.classList.toggle('hidden', selectedType !== 'MONTH');
        quarterSelectDiv.classList.toggle('hidden', selectedType !== 'QUARTER');

        // 'required'-Attribut dynamisch setzen/entfernen
        balanceMonthInput.required = (selectedType === 'MONTH');
        balanceQuarterSelect.required = (selectedType === 'QUARTER');

        // PDF-Button Text/Tooltip anpassen und (de)aktivieren
        let pdfButtonTitle = "PDF Herunterladen";
        if (selectedType === 'MONTH') pdfButtonTitle = "Monatsübersicht als PDF";
        else if (selectedType === 'QUARTER') pdfButtonTitle = "Quartalsübersicht als PDF";
        else pdfButtonTitle = "Jahresübersicht als PDF";
        downloadPdfBtn.title = pdfButtonTitle;
        downloadPdfBtn.disabled = true; // Wird erst nach erfolgreicher Berechnung aktiviert

        // Ergebnisbereich leeren und Daten zurücksetzen
        balanceResultDiv.innerHTML = '';
        currentBalanceData = null;
    }

    async function handleCalculateBalance(e) {
        e.preventDefault(); // Standard Formularabsendung verhindern
        if(!balanceNameSelect || !balanceYearInput || !periodTypeSelect || !balanceMonthInput || !balanceQuarterSelect || !balanceResultDiv || !downloadPdfBtn) return;

        // Werte auslesen
        const employeeName = balanceNameSelect.value; // Hier wird der Name als Value verwendet
        const year = balanceYearInput.value;
        const selectedType = periodTypeSelect.value;
        let month = null, quarter = null, url = '';
        let valid = true; // Validierungsflag

        // Eingaben validieren
        if (!employeeName) { alert("Bitte einen Mitarbeiter auswählen."); valid = false; }
        if (!year || isNaN(parseInt(year)) || year.length !== 4) { alert("Bitte ein gültiges Jahr (YYYY) eingeben."); valid = false; }

        // URL basierend auf Periodentyp bauen
        if (selectedType === 'MONTH') {
            month = balanceMonthInput.value;
            if (!month || isNaN(parseInt(month)) || month < 1 || month > 12) {
                alert("Bitte einen gültigen Monat (1-12) eingeben."); valid = false;
            } else {
                 // Name wird für diesen Endpunkt benötigt
                 url = `/calculate-monthly-balance?name=${encodeURIComponent(employeeName)}&year=${year}&month=${month}`;
            }
        } else if (selectedType === 'QUARTER') {
            quarter = balanceQuarterSelect.value;
            if (!quarter) { // Sollte durch required nicht passieren, aber sicher ist sicher
                alert("Bitte ein Quartal auswählen."); valid = false;
            } else {
                 // Name wird für diesen Endpunkt benötigt
                 url = `/calculate-period-balance?name=${encodeURIComponent(employeeName)}&year=${year}&periodType=QUARTER&periodValue=${quarter}`;
            }
        } else { // YEAR
             // Name wird für diesen Endpunkt benötigt
             url = `/calculate-period-balance?name=${encodeURIComponent(employeeName)}&year=${year}&periodType=YEAR`;
        }

        if (!valid || !url) return; // Abbruch bei Validierungsfehler oder fehlender URL

        // UI Feedback
        balanceResultDiv.innerHTML = "Berechne Auswertung...";
        balanceResultDiv.className = 'working-message'; // Stil für "In Arbeit"
        downloadPdfBtn.disabled = true; // PDF Button deaktivieren
        currentBalanceData = null; // Alte Daten löschen

        try {
            const response = await fetch(url, { credentials: "include" }); // Wichtig für Admin-Session
            const responseText = await response.text(); // Antwort immer als Text lesen

            if (!response.ok) {
                 // Versuche, JSON-Fehler zu parsen, sonst Text anzeigen
                 let errorMsg = `Fehler ${response.status}`;
                 try { errorMsg = JSON.parse(responseText).message || responseText; } catch(e) { /* War Text */ }
                 throw new Error(errorMsg);
            }

            // Erfolgreiche Antwort, jetzt als JSON parsen
            const data = JSON.parse(responseText);
            currentBalanceData = data; // Daten für PDF speichern
            let html = '';

            // HTML für die Anzeige generieren
            if (selectedType === 'MONTH') {
                html = `<h3>Monatsauswertung für ${data.employeeName || employeeName} (${String(data.month).padStart(2,'0')}/${data.year})</h3>`;
                if (data.totalExpected !== undefined) { // Prüfen ob gültige Daten zurückkamen
                    html += `<p>Übertrag Vormonat: <strong>${data.previousCarryOver.toFixed(2)} Std.</strong></p>`;
                    html += `<p>Soll-Stunden (Monat): <strong>${data.totalExpected.toFixed(2)} Std.</strong></p>`;
                    html += `<p>Ist-Stunden (Monat): <strong>${data.totalActual.toFixed(2)} Std.</strong> `
                         + `(Gearbeitet: ${data.workedHours?.toFixed(2) || '0.00'} Std. + Abwesenheit: ${data.absenceHours?.toFixed(2) || '0.00'} Std.)</p>`;
                    html += `<p>Differenz (Monat): <strong class="${data.totalDifference >= 0 ? 'positive-diff' : 'negative-diff'}">${data.totalDifference.toFixed(2)} Std.</strong></p>`;
                    html += `<hr style="border-color:#ccc; margin: 10px 0;">`;
                    html += `<p><strong>Neuer Übertrag (Saldo Ende Monat): <strong>${data.newCarryOver.toFixed(2)} Std.</strong></p>`;
                    downloadPdfBtn.disabled = false; // PDF Button aktivieren
                    balanceResultDiv.className = ''; // Standard-Stil
                } else {
                     html += `<p class="error-message">${data.message || 'Keine Daten für diesen Monat gefunden.'}</p>`;
                     balanceResultDiv.className = 'error-message';
                }
            } else { // QUARTER or YEAR
                const periodLabel = data.periodIdentifier || (selectedType === 'QUARTER' ? `Q${quarter}` : 'Jahr');
                // Formatierte Start/End-Daten
                 const sd = data.periodStartDate ? new Date(data.periodStartDate + 'T00:00:00Z').toLocaleDateString('de-DE', { timeZone: 'UTC' }) : 'N/A';
                 const ed = data.periodEndDate ? new Date(data.periodEndDate + 'T00:00:00Z').toLocaleDateString('de-DE', { timeZone: 'UTC' }) : 'N/A';

                html = `<h3>Auswertung ${periodLabel} für ${data.employeeName || employeeName} (${data.year})</h3>`;
                html += `<p>Zeitraum: ${sd} - ${ed}</p>`;
                 if (data.totalExpectedPeriod !== undefined) { // Prüfen ob gültige Daten zurückkamen
                    html += `<p>Übertrag Periodenbeginn: <strong>${data.startingBalance.toFixed(2)} Std.</strong></p>`;
                    html += `<p>Soll-Stunden (${periodLabel}): <strong>${data.totalExpectedPeriod.toFixed(2)} Std.</strong></p>`;
                    html += `<p>Ist-Stunden (${periodLabel}): <strong>${data.totalActualPeriod.toFixed(2)} Std.</strong> `
                         + `(Gearbeitet: ${data.workedHoursPeriod?.toFixed(2) || '0.00'} Std. + Abwesenheit: ${data.absenceHoursPeriod?.toFixed(2) || '0.00'} Std.)</p>`;
                    html += `<p>Differenz (${periodLabel}): <strong class="${data.periodDifference >= 0 ? 'positive-diff' : 'negative-diff'}">${data.periodDifference.toFixed(2)} Std.</strong></p>`;
                     html += `<hr style="border-color:#ccc; margin: 10px 0;">`;
                    html += `<p><strong>Neuer Übertrag (Saldo Periodenende): <strong>${data.endingBalancePeriod.toFixed(2)} Std.</strong></p>`;
                    downloadPdfBtn.disabled = false; // PDF Button aktivieren
                    balanceResultDiv.className = ''; // Standard-Stil
                 } else {
                     html += `<p class="error-message">${data.message || 'Keine Daten für diesen Zeitraum gefunden.'}</p>`;
                      balanceResultDiv.className = 'error-message';
                 }
            }
            balanceResultDiv.innerHTML = html; // Ergebnis anzeigen

        } catch (error) {
            console.error(`Fehler bei der ${selectedType}-Auswertung:`, error);
            balanceResultDiv.innerHTML = `<p class="error-message">Fehler bei der Berechnung: ${error.message}</p>`;
            balanceResultDiv.className = 'error-message';
            downloadPdfBtn.disabled = true; // PDF Button deaktiviert lassen
            currentBalanceData = null;
        }
    }

    function handleDownloadPdf() {
        if (!currentBalanceData) {
            alert("Bitte zuerst eine Auswertung berechnen, bevor das PDF heruntergeladen werden kann.");
            return;
        }
        if (!periodTypeSelect || !balanceNameSelect || !balanceYearInput || !balanceMonthInput || !balanceQuarterSelect) {
             console.error("PDF Download: Formular-Elemente nicht gefunden.");
             return;
        }

        const selectedType = periodTypeSelect.value;
        // const employeeId = balanceNameSelect.value; // ID wird nicht mehr direkt gebraucht
        const name = currentBalanceData.employeeName || balanceNameSelect.value; // Name aus Ergebnis oder Dropdown nehmen
        const year = currentBalanceData.year || balanceYearInput.value;
        let pdfUrl = '', valid = true;

        if (!name || name === 'Bitte auswählen' || !year) {
            alert("Fehler: Mitarbeitername oder Jahr für PDF-Generierung nicht verfügbar.");
            return;
        }

        // URL für den PDF-Endpunkt bauen
        if (selectedType === 'MONTH') {
            const month = currentBalanceData.month || balanceMonthInput.value;
            if (!month || isNaN(parseInt(month)) || month < 1 || month > 12) {
                alert("Fehler: Ungültiger Monat für PDF."); valid = false;
            } else {
                pdfUrl = `/api/pdf/create-monthly-pdf?name=${encodeURIComponent(name)}&year=${year}&month=${month}`;
            }
        } else if (selectedType === 'QUARTER') {
             const quarter = currentBalanceData.periodValue || balanceQuarterSelect.value;
            if (!quarter || isNaN(parseInt(quarter)) || quarter < 1 || quarter > 4) {
                alert("Fehler: Ungültiges Quartal für PDF."); valid = false;
            } else {
                pdfUrl = `/api/pdf/create-period-pdf?name=${encodeURIComponent(name)}&year=${year}&periodType=QUARTER&periodValue=${quarter}`;
            }
        } else { // YEAR
             pdfUrl = `/api/pdf/create-period-pdf?name=${encodeURIComponent(name)}&year=${year}&periodType=YEAR`;
        }

        if (!valid || !pdfUrl) {
            console.error("PDF URL konnte nicht erstellt werden. Typ:", selectedType, "Valid:", valid);
            alert("Fehler beim Erstellen der PDF-Download-URL.");
            return;
        }

        console.log("Öffne PDF Download URL:", pdfUrl);
        // Öffne die URL in einem neuen Tab - der Server liefert dann das PDF als Download
        window.open(pdfUrl, '_blank');
    }
    // --- ENDE Auswertungen ---

  </script>
</body>
</html>
