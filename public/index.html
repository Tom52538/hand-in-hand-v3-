<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbeitszeiterfassung</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Inline-Stile für schnelle Demo-Anzeige */
    .hidden { display: none; }
    .booking-row { margin-bottom: 0.5rem; }
    .table-wrapper { overflow-x: auto; }
    .container {
      max-width: 900px; margin: 20px auto; padding: 20px;
      background-color: #f9f9f9; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 { color: #333; }
    button { padding: 10px 15px; cursor: pointer; }
    button:disabled { cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td {
      border: 1px solid #ccc; padding: 8px;
      text-align: left; vertical-align: middle;
    }
    input[readonly] { background-color: #e9e9e9; cursor: default; }
    .tabs {
      list-style: none; padding: 0; margin: 0 0 1rem 0;
      display: flex; flex-wrap: wrap; border-bottom: 1px solid #ccc;
    }
    .tabs li {
      padding: 10px 20px; cursor: pointer;
      border: 1px solid #ccc; border-bottom: none;
      margin-right: 5px; margin-bottom: -1px;
      background: #f1f1f1; border-radius: 4px 4px 0 0;
    }
    .tabs li.active {
      background: #fff; font-weight: bold;
      border-bottom: 1px solid #fff;
    }
    .tab-content {
      border: 1px solid #ccc; padding: 20px; background: #fff;
      border-radius: 0 0 4px 4px; border-top: none; margin-bottom: 2rem;
    }
    /* Styles für Radio-Buttons nebeneinander */
    .period-type-selector label { margin-right: 15px; }
    .period-type-selector input[type="radio"] { margin-right: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbeitszeiterfassung</h1>

    <form id="workHoursForm">
      <div>
        <label for="employeeSelect">Mitarbeiter:</label>
        <select id="employeeSelect" name="employeeSelect" required>
          <option value="">Bitte auswählen</option>
        </select>
      </div>
      <div>
        <button type="button" id="workTimeBtn" disabled>Arbeitsbeginn buchen</button>
      </div>


      <div id="bookingDetails" class="booking-details">
        <div class="booking-row">
          <label for="displayDate">Datum:</label>
          <input type="text" id="displayDate" readonly>
        </div>
        <div class="booking-row">
          <label for="displayStartTime">Arbeitsbeginn:</label>
          <input type="text" id="displayStartTime" readonly>
        </div>
        <div class="booking-row">
          <label for="displayEndTime">Arbeitsende:</label>
          <input type="text" id="displayEndTime" readonly>
        </div>
        <div id="summaryHours" class="hidden">
          <div class="booking-row">
            <label>Arbeitszeit Tag:</label>
            <span id="dailyTotalHours">--</span>
          </div>
          <div class="booking-row">
            <label>Arbeitszeit Monat:</label>
            <span id="monthlyTotalHours">--</span>
          </div>
        </div>
      </div>
    </form>

    <hr>
    <h2>Admin Login</h2>
    <form id="adminLoginForm">
      <div>
        <label for="adminPassword">Passwort:</label>
        <input type="password" id="adminPassword" name="adminPassword" required>
      </div>
      <button type="submit">Anmelden</button>
    </form>

    <div id="adminTabs" class="hidden">
      <ul class="tabs">
        <li data-tab="workhours" class="active">Arbeitszeiten</li>
        <li data-tab="employees">Mitarbeiter</li>
        <li data-tab="reports">Auswertungen</li> </ul>

      <div id="tab-workhours" class="tab-content">
        <h2>Arbeitszeiten verwalten</h2>
        <div class="table-wrapper">
          <table id="workHoursTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Datum</th>
                <th>Arbeitszeit</th>
                <th>Stunden</th>
                <th>Bemerkungen</th>
                <th>Aktionen</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <br>
        <button id="adminDownloadCsv">CSV herunterladen</button>
        <button id="adminDeleteData" style="color: red;">Alle Arbeitszeiten löschen (Vorsicht!)</button>
        <hr>
        <div id="editWorkHoursSection" class="hidden">
          <h3>Datensatz bearbeiten</h3>
          <form id="editForm">
            <input type="hidden" id="editId" name="id">
            <div>
              <label for="editName">Name:</label>
              <input type="text" id="editName" name="name" required>
            </div>
            <div>
              <label for="editDate">Datum:</label>
              <input type="date" id="editDate" name="date" required>
            </div>
            <div>
              <label for="editStartTime">Arbeitsbeginn:</label>
              <input type="time" id="editStartTime" name="startTime" required>
            </div>
            <div>
              <label for="editEndTime">Arbeitsende:</label>
              <input type="time" id="editEndTime" name="endTime" required>
            </div>
            <div>
              <label for="editComment">Bemerkungen:</label>
              <input type="text" id="editComment" name="comment">
            </div>
            <button type="button" onclick="saveChanges()">Änderungen Speichern</button>
            <button type="button" onclick="cancelEditWorkHours()">Abbrechen</button>
          </form>
        </div>
      </div>

      <div id="tab-employees" class="tab-content hidden">
        <h2>Mitarbeiterverwaltung</h2>
        <h3>Aktuelle Mitarbeiter</h3>
        <ul id="employeeList"></ul>
        <hr>
        <div id="addEmployeeSection">
          <form id="addEmployeeForm">
            <h3>Mitarbeiter hinzufügen</h3>
            <div>
              <label for="employeeName">Name:</label>
              <input type="text" id="employeeName" name="employeeName" required>
            </div>
            <div>
              <label for="mo_hours">Montag (Soll-Std.):</label>
              <input type="number" id="mo_hours" name="mo_hours" step="0.1" value="0" min="0">
            </div>
            <div>
              <label for="di_hours">Dienstag (Soll-Std.):</label>
              <input type="number" id="di_hours" name="di_hours" step="0.1" value="0" min="0">
            </div>
            <div>
              <label for="mi_hours">Mittwoch (Soll-Std.):</label>
              <input type="number" id="mi_hours" name="mi_hours" step="0.1" value="0" min="0">
            </div>
            <div>
              <label for="do_hours">Donnerstag (Soll-Std.):</label>
              <input type="number" id="do_hours" name="do_hours" step="0.1" value="0" min="0">
            </div>
            <div>
              <label for="fr_hours">Freitag (Soll-Std.):</label>
              <input type="number" id="fr_hours" name="fr_hours" step="0.1" value="0" min="0">
            </div>
            <button type="submit">Mitarbeiter hinzufügen</button>
          </form>
        </div>
        <div id="editEmployeeSection" class="hidden">
          <form id="editEmployeeForm">
            <hr>
            <h3>Mitarbeiter bearbeiten</h3>
            <input type="hidden" id="editEmployeeId" name="id">
            <div>
              <label for="editEmployeeName">Name:</label>
              <input type="text" id="editEmployeeName" name="name" required>
            </div>
            <div>
              <label for="editMoHours">Montag (Soll-Std.):</label>
              <input type="number" id="editMoHours" name="mo_hours" step="0.1" value="0" min="0">
            </div>
            <div>
              <label for="editDiHours">Dienstag (Soll-Std.):</label>
              <input type="number" id="editDiHours" name="di_hours" step="0.1" value="0" min="0">
            </div>
            <div>
              <label for="editMiHours">Mittwoch (Soll-Std.):</label>
              <input type="number" id="editMiHours" name="mi_hours" step="0.1" value="0" min="0">
            </div>
            <div>
              <label for="editDoHours">Donnerstag (Soll-Std.):</label>
              <input type="number" id="editDoHours" name="do_hours" step="0.1" value="0" min="0">
            </div>
            <div>
              <label for="editFrHours">Freitag (Soll-Std.):</label>
              <input type="number" id="editFrHours" name="fr_hours" step="0.1" value="0" min="0">
            </div>
            <button type="button" onclick="saveEmployeeChanges()">Änderungen Speichern</button>
            <button type="button" onclick="cancelEditEmployee()">Abbrechen</button>
          </form>
        </div>
      </div>

      <div id="tab-reports" class="tab-content hidden"> <h2>Auswertungen</h2> <form id="balanceForm"> <div>
            <label for="balanceName">Mitarbeitername:</label>
            <select id="balanceName" name="balanceName" required>
              <option value="">Bitte auswählen</option>
            </select>
          </div>
          <div>
            <label for="balanceYear">Jahr:</label>
            <input type="number" id="balanceYear" name="balanceYear" required>
          </div>
          <div class="period-type-selector">
              <label>Zeitraum:</label>
              <input type="radio" id="periodTypeMonth" name="periodType" value="MONTH" checked>
              <label for="periodTypeMonth">Monat</label>
              <input type="radio" id="periodTypeQuarter" name="periodType" value="QUARTER">
              <label for="periodTypeQuarter">Quartal</label>
              <input type="radio" id="periodTypeYear" name="periodType" value="YEAR">
              <label for="periodTypeYear">Jahr</label>
          </div>
          <div id="monthSelectDiv">
              <label for="balanceMonth">Monat (1-12):</label>
              <input type="number" id="balanceMonth" name="balanceMonth" required min="1" max="12">
          </div>
          <div id="quarterSelectDiv" class="hidden">
              <label for="balanceQuarter">Quartal:</label>
              <select id="balanceQuarter" name="balanceQuarter" required>
                <option value="1">Q1 (Jan-Mrz)</option>
                <option value="2">Q2 (Apr-Jun)</option>
                <option value="3">Q3 (Jul-Sep)</option>
                <option value="4">Q4 (Okt-Dez)</option>
              </select>
          </div>
          <button type="submit">Auswertung berechnen</button> </form>
        <br>
        <button id="downloadPdfBtn" disabled>PDF herunterladen</button>
        <div id="balanceResult" style="margin-top: 1rem;"></div> </div> </div> </div> <script>
    // ==== Globale Variablen ====
    let currentWorkEntryId = null;
    // ==== DOM-Referenzen ====
    const employeeSelect = document.getElementById('employeeSelect');
    const workTimeBtn = document.getElementById('workTimeBtn');
    const displayDateInput = document.getElementById('displayDate');
    const displayStartTimeInput = document.getElementById('displayStartTime');
    const displayEndTimeInput = document.getElementById('displayEndTime');
    const summaryHoursDiv = document.getElementById('summaryHours');
    const dailyTotalHoursSpan = document.getElementById('dailyTotalHours');
    const monthlyTotalHoursSpan = document.getElementById('monthlyTotalHours');
    // NEU: DOM Referenzen für Auswertungsformular
    const balanceForm = document.getElementById('balanceForm');
    const balanceNameSelect = document.getElementById('balanceName');
    const balanceYearInput = document.getElementById('balanceYear');
    const periodTypeRadios = document.querySelectorAll('input[name="periodType"]');
    const monthSelectDiv = document.getElementById('monthSelectDiv');
    const balanceMonthInput = document.getElementById('balanceMonth');
    const quarterSelectDiv = document.getElementById('quarterSelectDiv');
    const balanceQuarterSelect = document.getElementById('balanceQuarter');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const balanceResultDiv = document.getElementById('balanceResult');


    // ==== Initialisierung ====
    document.addEventListener('DOMContentLoaded', () => {
      resetWorkTimeForm();
      loadEmployeeOptions();
      setupEventListeners();
      // Setzt das aktuelle Jahr und den aktuellen Monat in die Auswertungsfelder
      const now = new Date();
      balanceYearInput.value = now.getFullYear();
      balanceMonthInput.value = now.getMonth() + 1; // Monate sind 0-basiert
      handlePeriodTypeChange(); // Initialen Zustand (Monat) herstellen
    });

    function setupEventListeners() {
      employeeSelect.addEventListener('change', handleEmployeeSelection);
      workTimeBtn.addEventListener('click', handleWorkTimeToggle);
      document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
      document.querySelectorAll('.tabs li').forEach(tab => {
        tab.addEventListener('click', handleTabSwitch);
      });
      document.getElementById('adminDownloadCsv').addEventListener('click', downloadAdminCsv);
      document.getElementById('adminDeleteData').addEventListener('click', deleteAllWorkHours);
      document.getElementById('addEmployeeForm').addEventListener('submit', handleAddEmployee);
      // NEU: Listener für das geänderte Auswertungsformular
      balanceForm.addEventListener('submit', handleCalculateBalance);
      // NEU: Listener für die Auswahl des Zeitraum-Typs
      periodTypeRadios.forEach(radio => {
          radio.addEventListener('change', handlePeriodTypeChange);
      });
      downloadPdfBtn.addEventListener('click', handleDownloadPdf); // Listener bleibt gleich, Funktion wird angepasst
    }

    // ==== Funktionen Zeiterfassung (Benutzer - unverändert) ====
    async function loadEmployeeOptions() {
      try {
        const response = await fetch('/employees');
        if (!response.ok) {
          throw new Error(`Mitarbeiterliste konnte nicht geladen werden (Status: ${response.status}).`);
        }
        const employees = await response.json();
        // Mitarbeiter-Dropdown (Hauptformular) befüllen
        employeeSelect.innerHTML = '<option value="">Bitte auswählen</option>';
        employees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.name;
          option.textContent = emp.name;
          employeeSelect.appendChild(option);
        });
        // Mitarbeiter-Dropdown (Auswertungsformular) befüllen
        const balanceSelect = balanceNameSelect; // Verwende Referenz
        if (balanceSelect) {
          balanceSelect.innerHTML = '<option value="">Bitte auswählen</option>';
          employees.forEach(emp => {
            const opt = document.createElement('option');
            opt.value = emp.name;
            opt.textContent = emp.name;
            balanceSelect.appendChild(opt);
          });
        }
      } catch (err) {
        console.error("Fehler beim Laden der Mitarbeiteroptionen:", err);
        employeeSelect.innerHTML = '<option value="">Fehler</option>';
        if(balanceNameSelect) balanceNameSelect.innerHTML = '<option value="">Fehler</option>';
        alert("❌ Mitarbeiterliste Ladefehler: " + err.message);
      }
    }

    function handleEmployeeSelection() {
      checkNextBookingAction();
    }

    async function checkNextBookingAction() {
      const name = employeeSelect.value;
      resetBookingDetails();
      workTimeBtn.disabled = true;
      currentWorkEntryId = null;
      if (!name) return;

      try {
        const response = await fetch(`/next-booking-details?name=${encodeURIComponent(name)}`);
        if (!response.ok) throw new Error(`Fehler ${response.status} beim Prüfen des Buchungsstatus.`);
        const data = await response.json();

        if (data.nextBooking === 'arbeitsende') {
          workTimeBtn.textContent = 'Arbeitsende buchen';
          workTimeBtn.style.backgroundColor = 'orange';
          currentWorkEntryId = data.id;
          workTimeBtn.disabled = false;
          if (data.startDate) {
            try {
              const dateObj = new Date(data.startDate + 'T00:00:00Z');
              displayDateInput.value = dateObj.toLocaleDateString('de-DE', { timeZone: 'UTC' });
            } catch(e) {
              displayDateInput.value = data.startDate; // Fallback
            }
          }
          displayStartTimeInput.value = data.startTime ? data.startTime + " Uhr" : '';
          displayEndTimeInput.value = '';
        } else {
          workTimeBtn.textContent = 'Arbeitsbeginn buchen';
          workTimeBtn.style.backgroundColor = '';
          workTimeBtn.disabled = false;
        }
      } catch (error) {
        console.error("Fehler bei '/next-booking-details':", error);
        alert("❌ Fehler beim Prüfen des Buchungsstatus: " + error.message);
      }
    }

    async function handleWorkTimeToggle() {
      const name = employeeSelect.value;
      if (!name) return;
      const action = workTimeBtn.textContent.includes('Arbeitsbeginn') ? 'start' : 'end';
      const now = new Date();
      const date = now.toISOString().split("T")[0]; // YYYY-MM-DD für DB
      const time = now.toTimeString().slice(0, 5); // HH:MM
      const displayDate = now.toLocaleDateString('de-DE'); // Für Anzeige

      workTimeBtn.disabled = true;

      if (action === 'start') {
        try {
          const response = await fetch("/log-start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, date, startTime: time })
          });
          if (response.ok) {
            const result = await response.json();
            alert("✅ Arbeitsbeginn erfolgreich gebucht.");
            displayDateInput.value = displayDate;
            displayStartTimeInput.value = time + " Uhr";
            displayEndTimeInput.value = '';
            summaryHoursDiv.classList.add('hidden');
            currentWorkEntryId = result.id;
            // checkNextBookingAction wird im finally aufgerufen
          } else {
            const result = await response.json().catch(() => ({ message: 'Unbekannter Fehler oder keine JSON-Antwort.' }));
            alert("❌ Fehler beim Buchen des Arbeitsbeginns: " + (result.message || response.statusText));
          }
        } catch (err) {
          console.error("Fehler beim Buchen des Arbeitsbeginns:", err);
          alert("❌ Netzwerkfehler!");
        } finally {
          workTimeBtn.disabled = false; // Button wieder aktivieren
          checkNextBookingAction(); // Status neu prüfen
        }
      } else { // "Arbeitsende buchen"
        if (!currentWorkEntryId) {
          alert("Fehler: Keine ID für den offenen Eintrag gefunden. Bitte Seite neu laden oder Admin kontaktieren.");
          workTimeBtn.disabled = false;
          checkNextBookingAction(); // Status neu prüfen
          return;
        }
        try {
          const response = await fetch(`/log-end/${currentWorkEntryId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ endTime: time, comment: "" }) // Kommentarfeld optional hinzufügen
          });
          if (response.ok) {
            alert("✅ Arbeitsende erfolgreich gebucht.");
            displayEndTimeInput.value = time + " Uhr";
            currentWorkEntryId = null; // Reset ID
            displaySummaryHours(name, date); // Zusammenfassung anzeigen
            // checkNextBookingAction wird im finally aufgerufen
          } else {
            const result = await response.json().catch(() => ({ message: 'Unbekannter Fehler oder keine JSON-Antwort.' }));
            alert("❌ Fehler beim Buchen des Arbeitsendes: " + (result.message || response.statusText));
          }
        } catch (err) {
          console.error("Fehler beim Buchen des Arbeitsendes:", err);
          alert("❌ Netzwerkfehler!");
        } finally {
          workTimeBtn.disabled = false; // Button wieder aktivieren
          checkNextBookingAction(); // Status neu prüfen
        }
      }
    }

    async function displaySummaryHours(employeeName, dayDate) {
      if (!employeeName || !dayDate) return;
      summaryHoursDiv.classList.add('hidden');
      dailyTotalHoursSpan.textContent = 'lade...';
      monthlyTotalHoursSpan.textContent = 'lade...';
      try {
        // Datum im YYYY-MM-DD Format für den Request sicherstellen
        let queryDate = dayDate;
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dayDate)) {
            try { // Versuch, aus einem lokalen Format zu konvertieren (DD.MM.YYYY)
                const dateParts = dayDate.split('.');
                queryDate = `${dateParts[2]}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
            } catch(e){
                console.error("Konnte Datum nicht ins YYYY-MM-DD Format bringen:", dayDate);
                queryDate = new Date().toISOString().split('T')[0]; // Fallback auf heute
            }
        }

        const response = await fetch(`/summary-hours?name=${encodeURIComponent(employeeName)}&date=${queryDate}`);
        if (!response.ok) throw new Error(`Fehler ${response.status} beim Laden der Zusammenfassung.`);
        const summary = await response.json();
        dailyTotalHoursSpan.textContent = `${summary.dailyHours ? summary.dailyHours.toFixed(2) : '0.00'} Std.`;
        monthlyTotalHoursSpan.textContent = `${summary.monthlyHours ? summary.monthlyHours.toFixed(2) : '0.00'} Std.`;
        summaryHoursDiv.classList.remove('hidden');
      } catch (error) {
        console.error("Fehler beim Anzeigen der Zusammenfassung:", error);
        dailyTotalHoursSpan.textContent = 'Fehler';
        monthlyTotalHoursSpan.textContent = 'Fehler';
        summaryHoursDiv.classList.remove('hidden'); // Auch bei Fehler anzeigen
      }
    }

    function resetWorkTimeForm() {
      employeeSelect.value = '';
      workTimeBtn.textContent = 'Arbeitsbeginn buchen';
      workTimeBtn.style.backgroundColor = '';
      workTimeBtn.disabled = true;
      resetBookingDetails();
    }

    function resetBookingDetails() {
      displayDateInput.value = '';
      displayStartTimeInput.value = '';
      displayEndTimeInput.value = '';
      summaryHoursDiv.classList.add('hidden');
      dailyTotalHoursSpan.textContent = '--';
      monthlyTotalHoursSpan.textContent = '--';
      currentWorkEntryId = null; // Auch hier die ID zurücksetzen
    }

    // ==== Admin-Funktionen (Login, Tab-Switch, Arbeitszeiten, Mitarbeiter - größtenteils unverändert)====
    async function handleAdminLogin(e) {
      e.preventDefault();
      const password = document.getElementById("adminPassword").value;
      try {
        const response = await fetch("/admin-login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password }),
          credentials: "include"
        });
        if (response.ok) {
          alert("✅ Admin erfolgreich angemeldet.");
          document.getElementById("adminPassword").value = ""; // Passwortfeld leeren
          document.getElementById("adminTabs").classList.remove("hidden");
          document.getElementById("adminLoginForm").classList.add("hidden");
          // Initiales Laden für den ersten Tab (Arbeitszeiten)
          loadAdminWorkHours();
        } else {
          const result = await response.text();
          alert("❌ Login fehlgeschlagen: " + response.status + " – " + result);
        }
      } catch (error) {
        console.error("❌ Netzwerkfehler beim Admin-Login:", error);
        alert("❌ Netzwerkfehler oder Server nicht erreichbar.");
      }
    }

    function handleTabSwitch(event) {
      const clickedTab = event.currentTarget;
      // Alle Tabs deselektieren und Inhalte verstecken
      document.querySelectorAll(".tabs li").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(tc => tc.classList.add("hidden"));
      // Geklickten Tab aktivieren und zugehörigen Inhalt anzeigen
      clickedTab.classList.add("active");
      const targetContentId = "tab-" + clickedTab.getAttribute("data-tab");
      const targetContent = document.getElementById(targetContentId);
      if (targetContent) {
        targetContent.classList.remove("hidden");
        // Lade spezifische Daten, wenn Tab gewechselt wird
        if (targetContentId === 'tab-workhours') loadAdminWorkHours();
        if (targetContentId === 'tab-employees') loadEmployees();
        if (targetContentId === 'tab-reports') loadEmployeeOptionsForReports(); // Lädt Optionen für Auswertungs-Tab
      }
    }

     function loadEmployeeOptionsForReports() {
        // Stellt sicher, dass die Mitarbeiterliste im Auswertungs-Dropdown aktuell ist.
        // Da loadEmployeeOptions() beide Dropdowns befüllt, reicht evtl. ein Aufruf beim Login.
        // Diese Funktion kann zur Sicherheit hier aufgerufen werden, falls der Tab gewechselt wird.
        console.log("Mitarbeiteroptionen für Auswertungen geprüft/geladen.");
        // Optional: loadEmployeeOptions(); // Erneutes Laden erzwingen, falls nötig
     }
          async function loadAdminWorkHours() {
      const tbody = document.querySelector("#workHoursTable tbody");
      tbody.innerHTML = "<tr><td colspan='7'>Lade Daten...</td></tr>"; // Ladeanzeige
      try {
        const response = await fetch('/admin-work-hours', { credentials: "include" });
        if (!response.ok) throw new Error(`Admin-Arbeitszeiten konnten nicht geladen werden (${response.status}).`);
        const data = await response.json();
        tbody.innerHTML = ""; // Vorherigen Inhalt löschen
        if (data.length === 0) {
          tbody.innerHTML = "<tr><td colspan='7'>Keine Arbeitszeiten erfasst.</td></tr>";
          return;
        }
        data.forEach(entry => {
          const row = document.createElement("tr");
          const hours = parseFloat(entry.hours) || 0;
          let displayDate = 'N/A';
          // Datumsformatierung sicherstellen
          if (entry.date) {
             try {
                 // Stelle sicher, dass das Datum korrekt als UTC interpretiert wird
                 const dateObj = new Date(entry.date.split('T')[0] + 'T00:00:00Z');
                 displayDate = dateObj.toLocaleDateString("de-DE", { timeZone: 'UTC' });
             } catch(e) {
                 displayDate = entry.date; // Fallback
                 console.warn("Konnte Admin-Datum nicht formatieren:", entry.date, e);
             }
          }

          row.innerHTML = `
            <td>${entry.id}</td>
            <td>${entry.name || 'Unbekannt'}</td>
            <td>${displayDate}</td>
            <td>${entry.startTime || '--:--'} - ${entry.endTime || '--:--'}</td>
            <td>${hours.toFixed(2)}</td>
            <td>${entry.comment || ''}</td>
            <td>
              <button onclick='editEntry(${JSON.stringify(entry)})'>Bearbeiten</button>
              <button onclick="deleteEntry(${entry.id})">Löschen</button>
            </td>`;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error("Fehler beim Laden der Admin-Arbeitszeiten:", error);
        tbody.innerHTML = `<tr><td colspan="7">❌ Fehler beim Laden: ${error.message}</td></tr>`;
      }
    }

    function editEntry(entry) {
      // Fülle das Bearbeitungsformular
      document.getElementById("editId").value = entry.id;
      document.getElementById("editName").value = entry.name || "";
      document.getElementById("editDate").value = entry.date ? entry.date.split("T")[0] : ""; // Nur YYYY-MM-DD
      document.getElementById("editStartTime").value = entry.startTime || "";
      document.getElementById("editEndTime").value = entry.endTime || "";
      document.getElementById("editComment").value = entry.comment || "";
      // Zeige den Bearbeitungsbereich an und scrolle dorthin
      document.getElementById("editWorkHoursSection").classList.remove("hidden");
      document.getElementById("editWorkHoursSection").scrollIntoView({ behavior: "smooth" });
    }

    function cancelEditWorkHours() {
      document.getElementById("editWorkHoursSection").classList.add("hidden");
      document.getElementById("editForm").reset(); // Formular zurücksetzen
      document.getElementById("editId").value = ""; // ID leeren
    }

    async function saveChanges() {
      const id = document.getElementById("editId").value;
      if (!id) return; // Sollte nicht passieren, aber sicher ist sicher

      const data = {
        id,
        name: document.getElementById("editName").value,
        date: document.getElementById("editDate").value,
        startTime: document.getElementById("editStartTime").value,
        endTime: document.getElementById("editEndTime").value,
        comment: document.getElementById("editComment").value
      };
      // Einfache Validierung
      if (!data.name || !data.date || !data.startTime || !data.endTime) {
        alert("Bitte füllen Sie alle erforderlichen Felder aus (Name, Datum, Startzeit, Endzeit).");
        return;
      }

      try {
        const response = await fetch("/api/admin/update-hours", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
          credentials: "include"
        });
        const result = await response.text(); // Text oder JSON, je nachdem was der Server sendet
        if (response.ok) {
          alert("✅ Änderungen erfolgreich gespeichert.");
          cancelEditWorkHours(); // Formular schließen/zurücksetzen
          loadAdminWorkHours(); // Tabelle neu laden
        } else {
          alert(`❌ Fehler beim Speichern (${response.status}): ${result}`);
        }
      } catch (error) {
        console.error("Fehler beim Speichern der Änderungen:", error);
        alert("❌ Netzwerkfehler beim Speichern.");
      }
    }

    async function deleteEntry(id) {
      if (!confirm(`Soll der Arbeitszeiteintrag mit der ID ${id} wirklich gelöscht werden?`)) return;
      try {
        const response = await fetch(`/api/admin/delete-hours/${id}`, {
          method: "DELETE",
          credentials: "include"
        });
        const result = await response.text();
        if (response.ok) {
          alert("✅ Eintrag erfolgreich gelöscht.");
          loadAdminWorkHours(); // Tabelle neu laden
        } else {
          alert(`❌ Fehler beim Löschen (${response.status}): ${result}`);
        }
      } catch (error) {
        console.error(`Fehler beim Löschen des Eintrags ${id}:`, error);
        alert("❌ Netzwerkfehler beim Löschen.");
      }
    }

    async function downloadAdminCsv() {
      // Öffnet den Download-Link in einem neuen Tab/Fenster
      window.open('/admin-download-csv', '_blank');
    }

    async function deleteAllWorkHours() {
      if (!confirm('WARNUNG!\n\nSind Sie sicher, dass Sie ALLE erfassten Arbeitszeiten unwiderruflich löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden und löscht auch die Monatsbilanzen!')) return;
      try {
        const response = await fetch('/adminDeleteData', {
          method: 'DELETE',
          credentials: 'include' // Wichtig für Admin-Authentifizierung via Session
        });
        const result = await response.text();
        if (response.ok) {
          alert('✅ Alle Arbeitszeiten und Monatsbilanzen wurden erfolgreich gelöscht.');
          loadAdminWorkHours(); // Tabelle neu laden (sollte jetzt leer sein)
          balanceResultDiv.innerHTML = ''; // Auch das Auswertungsergebnis löschen
        } else {
          alert(`❌ Fehler beim Löschen aller Arbeitszeiten (${response.status}): ${result}`);
        }
      } catch (error) {
        console.error('Fehler beim Löschen aller Arbeitszeiten:', error);
        alert('❌ Netzwerkfehler beim Versuch, alle Daten zu löschen.');
      }
    }

    // ==== Mitarbeiterverwaltung (unverändert) ====
    async function loadEmployees() {
        const list = document.getElementById("employeeList");
        list.innerHTML = "<li>Lade Mitarbeiter...</li>"; // Ladeanzeige
        try {
            const response = await fetch("/admin/employees", { credentials: "include" });
            if (!response.ok) throw new Error(`Mitarbeiterliste konnte nicht geladen werden (${response.status}).`);
            const data = await response.json();
            list.innerHTML = ""; // Ladeanzeige entfernen
            if (data.length > 0) {
                data.forEach(emp => {
                    const li = document.createElement("li");
                    // Stellt sicher, dass Stunden angezeigt werden, auch wenn sie null sind (als 0)
                    li.innerHTML = `
                        <span>${emp.name} (Soll-Std: Mo: ${emp.mo_hours || 0}, Di: ${emp.di_hours || 0}, Mi: ${emp.mi_hours || 0}, Do: ${emp.do_hours || 0}, Fr: ${emp.fr_hours || 0})</span>
                        <div>
                            <button onclick='editEmployee(${JSON.stringify(emp)})'>Bearbeiten</button>
                            <button onclick="deleteEmployee(${emp.id}, '${emp.name}')">Löschen</button>
                        </div>`;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = "<li>Keine Mitarbeiter angelegt.</li>";
            }
        } catch (error) {
            console.error("Fehler beim Laden der Mitarbeiterliste:", error);
            list.innerHTML = `<li>❌ Fehler beim Laden: ${error.message}</li>`;
        }
    }

    async function handleAddEmployee(event) {
      event.preventDefault();
      const form = event.target;
      const data = {
        name: form.employeeName.value.trim(), // Leerzeichen entfernen
        mo_hours: parseFloat(form.mo_hours.value) || 0,
        di_hours: parseFloat(form.di_hours.value) || 0,
        mi_hours: parseFloat(form.mi_hours.value) || 0,
        do_hours: parseFloat(form.do_hours.value) || 0,
        fr_hours: parseFloat(form.fr_hours.value) || 0
      };
      if (!data.name) {
        alert("Bitte geben Sie einen Namen für den Mitarbeiter ein.");
        return;
      }

      try {
        const response = await fetch('/admin/employees', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'include'
        });
        if (response.ok) {
          const result = await response.json();
          alert(`✅ Mitarbeiter "${result.name}" erfolgreich hinzugefügt.`);
          form.reset(); // Formular leeren
          loadEmployees(); // Mitarbeiterliste aktualisieren
          loadEmployeeOptions(); // Dropdowns aktualisieren
        } else {
          const errorText = await response.text().catch(() => response.statusText);
          alert(`❌ Fehler beim Hinzufügen (${response.status}): ${errorText}`);
        }
      } catch (error) {
        console.error('Fehler beim Hinzufügen des Mitarbeiters:', error);
        alert('❌ Netzwerkfehler beim Hinzufügen.');
      }
    }

    function editEmployee(emp) {
        document.getElementById("editEmployeeId").value = emp.id;
        document.getElementById("editEmployeeName").value = emp.name;
        document.getElementById("editMoHours").value = emp.mo_hours || 0;
        document.getElementById("editDiHours").value = emp.di_hours || 0;
        document.getElementById("editMiHours").value = emp.mi_hours || 0;
        document.getElementById("editDoHours").value = emp.do_hours || 0;
        document.getElementById("editFrHours").value = emp.fr_hours || 0;
        document.getElementById("editEmployeeSection").classList.remove("hidden");
        document.getElementById("addEmployeeSection").classList.add("hidden");
        document.getElementById("editEmployeeSection").scrollIntoView({ behavior: "smooth" });
    }

    function cancelEditEmployee() {
        document.getElementById("editEmployeeSection").classList.add("hidden");
        document.getElementById("addEmployeeSection").classList.remove("hidden");
        document.getElementById("editEmployeeForm").reset();
        document.getElementById("editEmployeeId").value = "";
    }

    async function saveEmployeeChanges() {
        const id = document.getElementById("editEmployeeId").value;
        if (!id) return;
        const data = {
            id,
            name: document.getElementById("editEmployeeName").value.trim(),
            mo_hours: parseFloat(document.getElementById("editMoHours").value) || 0,
            di_hours: parseFloat(document.getElementById("editDiHours").value) || 0,
            mi_hours: parseFloat(document.getElementById("editMiHours").value) || 0,
            do_hours: parseFloat(document.getElementById("editDoHours").value) || 0,
            fr_hours: parseFloat(document.getElementById("editFrHours").value) || 0
        };
        if (!data.name) {
            alert("Der Mitarbeitername darf nicht leer sein.");
            return;
        }
        try {
            const response = await fetch(`/admin/employees/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            const result = await response.text();
            if (response.ok) {
                alert(`✅ Mitarbeiterdaten erfolgreich aktualisiert.`);
                cancelEditEmployee();
                loadEmployees();
                loadEmployeeOptions(); // WICHTIG: Dropdowns auch aktualisieren
            } else {
                alert(`❌ Fehler beim Aktualisieren (${response.status}): ${result}`);
            }
        } catch (error) {
            console.error("Fehler beim Speichern der Mitarbeiteränderungen:", error);
            alert("❌ Netzwerkfehler beim Speichern der Mitarbeiterdaten.");
        }
    }

   async function deleteEmployee(id, name) {
        if (!confirm(`Sind Sie sicher, dass Sie den Mitarbeiter "${name}" (ID: ${id}) und alle seine zugehörigen Daten (Arbeitszeiten, Monatsbilanzen) unwiderruflich löschen möchten?`)) return;
        try {
             const response = await fetch(`/admin/employees/${id}`, {
                 method: 'DELETE',
                 credentials: 'include'
             });
             const result = await response.text();
             if (response.ok) {
                 alert(`✅ Mitarbeiter "${name}" und zugehörige Daten erfolgreich gelöscht.`);
                 loadEmployees(); // Liste aktualisieren
                 loadEmployeeOptions(); // Dropdowns aktualisieren (wichtig!)
                 // Ggf. Admin-Arbeitszeit-Tab neu laden, falls dort nach MA gefiltert wird
                 if(document.querySelector('#tab-workhours').classList.contains('active')){
                     loadAdminWorkHours();
                 }
                 // Ggf. Auswertungs-Ergebnis löschen
                 balanceResultDiv.innerHTML = '';
             } else {
                 alert(`❌ Fehler beim Löschen (${response.status}): ${result}`);
             }
        } catch (error) {
             console.error(`Fehler beim Löschen von Mitarbeiter ${id}:`, error);
             alert("❌ Netzwerkfehler beim Löschen des Mitarbeiters.");
        }
   }

    // === NEU: Auswertungen (Monat/Quartal/Jahr) ===

    // Hilfsfunktion zum Umschalten der Sichtbarkeit der Zeitraum-Eingabefelder
    function handlePeriodTypeChange() {
        const selectedType = document.querySelector('input[name="periodType"]:checked').value;
        const pdfButton = downloadPdfBtn; // Referenz

        if (selectedType === 'MONTH') {
            monthSelectDiv.classList.remove('hidden');
            quarterSelectDiv.classList.add('hidden');
            balanceMonthInput.required = true; // Monat ist erforderlich
            balanceQuarterSelect.required = false;
            pdfButton.disabled = false; // PDF-Download für Monat erlauben
            pdfButton.title = "Monatsauswertung als PDF herunterladen";
        } else if (selectedType === 'QUARTER') {
            monthSelectDiv.classList.add('hidden');
            quarterSelectDiv.classList.remove('hidden');
            balanceMonthInput.required = false;
            balanceQuarterSelect.required = true; // Quartal ist erforderlich
            pdfButton.disabled = true; // PDF-Download für Quartal (noch) nicht erlaubt
            pdfButton.title = "PDF-Download nur für Monatsauswertung verfügbar.";
        } else { // YEAR
            monthSelectDiv.classList.add('hidden');
            quarterSelectDiv.classList.add('hidden');
            balanceMonthInput.required = false;
            balanceQuarterSelect.required = false;
            pdfButton.disabled = true; // PDF-Download für Jahr (noch) nicht erlaubt
            pdfButton.title = "PDF-Download nur für Monatsauswertung verfügbar.";
        }
        // Ergebnis leeren, wenn Typ gewechselt wird
        balanceResultDiv.innerHTML = '';
    }


    // Funktion zur Berechnung und Anzeige der Auswertung (Monat, Quartal oder Jahr)
    async function handleCalculateBalance(e) {
      e.preventDefault();
      const name = balanceNameSelect.value;
      const year = balanceYearInput.value;
      const selectedType = document.querySelector('input[name="periodType"]:checked').value;

      let month = null;
      let quarter = null;
      let valid = true;
      let url = '';

      // --- Validierung ---
      if (!name) {
        alert("Bitte wählen Sie einen Mitarbeiter aus.");
        valid = false;
      }
      if (!year || isNaN(parseInt(year))) {
          alert("Bitte geben Sie ein gültiges Jahr ein.");
          valid = false;
      }

      // --- URL und Parameter basierend auf Typ bauen ---
      if (selectedType === 'MONTH') {
          month = balanceMonthInput.value;
          if (!month || isNaN(parseInt(month)) || month < 1 || month > 12) {
              alert("Bitte geben Sie einen gültigen Monat (1-12) ein.");
              valid = false;
          } else {
               url = `/calculate-monthly-balance?name=${encodeURIComponent(name)}&year=${year}&month=${month}`;
          }
      } else if (selectedType === 'QUARTER') {
          quarter = balanceQuarterSelect.value; // Wert ist 1-4
          if (!quarter) { // Sollte nicht passieren wegen required, aber sicher ist sicher
               alert("Bitte wählen Sie ein Quartal aus.");
               valid = false;
          } else {
              url = `/calculate-period-balance?name=${encodeURIComponent(name)}&year=${year}&periodType=QUARTER&periodValue=${quarter}`;
          }
      } else { // YEAR
          url = `/calculate-period-balance?name=${encodeURIComponent(name)}&year=${year}&periodType=YEAR`;
      }

      if (!valid) return; // Abbruch bei Validierungsfehler

      balanceResultDiv.innerHTML = "Berechnung läuft..."; // Feedback für den Nutzer

      try {
        // Fetch an den passenden Backend-Endpunkt
        const response = await fetch(url, { credentials: "include" });

        if (!response.ok) {
          const errorText = await response.text().catch(() => `HTTP-Status ${response.status}`);
          throw new Error(`Fehler ${response.status}: ${errorText}`);
        }

        const data = await response.json();

        // --- Ergebnis anzeigen (unterscheidet zwischen Monats- und Perioden-Antwort) ---
        let html = '';
        if (selectedType === 'MONTH') {
            // Monatsauswertung anzeigen
            html = `<h3>Monatsauswertung für ${data.employeeName || name} (${String(data.month).padStart(2,'0')}/${data.year})</h3>`;
            if (data.previousCarryOver !== undefined) {
                html += `<p>Übertrag Vormonat (Saldo Vormonat Ende): <strong>${data.previousCarryOver.toFixed(2)} Std.</strong></p>`;
                html += `<p>Soll-Arbeitsstunden (aktueller Monat): <strong>${data.totalExpected.toFixed(2)} Std.</strong></p>`;
                html += `<p>Ist-Arbeitsstunden (aktueller Monat): <strong>${data.totalActual.toFixed(2)} Std.</strong></p>`;
                const currentMonthDiff = data.totalActual - data.totalExpected;
                html += `<p>Differenz (aktueller Monat): <strong>${currentMonthDiff.toFixed(2)} Std.</strong></p>`;
                html += `<hr>`;
                html += `<p>Neuer Übertrag (Saldo aktueller Monat Ende): <strong>${data.newCarryOver.toFixed(2)} Std.</strong></p>`;
            } else if (data.message) {
                 html += `<p>${data.message}</p>`;
            } else {
                 html += `<p style="color:orange;">Keine vollständigen Daten für die Monatsberechnung verfügbar.</p>`;
            }
        } else {
             // Periodenauswertung (Quartal/Jahr) anzeigen
             const periodLabel = data.periodIdentifier || (selectedType === 'QUARTER' ? `Q${quarter}` : 'Jahr');
             const startDateFormatted = new Date(data.periodStartDate + 'T00:00:00Z').toLocaleDateString('de-DE', { timeZone: 'UTC' });
             const endDateFormatted = new Date(data.periodEndDate + 'T00:00:00Z').toLocaleDateString('de-DE', { timeZone: 'UTC' });

             html = `<h3>Auswertung ${periodLabel} für ${data.employeeName || name} (${data.year})</h3>`;
             html += `<p>Zeitraum: ${startDateFormatted} - ${endDateFormatted}</p>`;
             if (data.startingBalance !== undefined) {
                 html += `<p>Übertrag Periodenbeginn: <strong>${data.startingBalance.toFixed(2)} Std.</strong></p>`;
                 html += `<p>Soll-Arbeitsstunden (${periodLabel}): <strong>${data.totalExpectedPeriod.toFixed(2)} Std.</strong></p>`;
                 html += `<p>Ist-Arbeitsstunden (${periodLabel}): <strong>${data.totalActualPeriod.toFixed(2)} Std.</strong></p>`;
                 html += `<p>Differenz (${periodLabel}): <strong>${data.periodDifference.toFixed(2)} Std.</strong></p>`;
                 html += `<hr>`;
                 html += `<p>Neuer Übertrag (Saldo Periodenende): <strong>${data.endingBalancePeriod.toFixed(2)} Std.</strong></p>`;
             } else if (data.message) {
                 html += `<p>${data.message}</p>`;
             } else {
                html += `<p style="color:orange;">Keine vollständigen Daten für die Periodenberechnung verfügbar.</p>`;
             }
        }
        balanceResultDiv.innerHTML = html;

      } catch (error) {
        console.error(`Fehler bei der ${selectedType}-Auswertung:`, error);
        balanceResultDiv.innerHTML = `<p style="color:red;">Fehler bei der Berechnung: ${error.message}</p>`;
      }
    }


    // --- PDF DOWNLOAD (nur für Monat aktiviert) ---
    function handleDownloadPdf() {
      const selectedType = document.querySelector('input[name="periodType"]:checked').value;

      // Nur für Monatsauswahl erlauben
      if (selectedType !== 'MONTH') {
          alert("PDF-Download ist derzeit nur für die Monatsauswertung verfügbar.");
          return;
      }

      const name = balanceNameSelect.value;
      const year = balanceYearInput.value;
      const month = balanceMonthInput.value;

      // Validierung für Monat (redundant, aber sicher)
      if (!name || !year || !month || isNaN(parseInt(year)) || isNaN(parseInt(month)) || month < 1 || month > 12) {
        alert("Bitte wählen Sie einen Mitarbeiter aus und geben Sie ein gültiges Jahr und einen gültigen Monat (1-12) ein.");
        return;
      }

      // URL für Monats-PDF Endpunkt
      const pdfUrl = `/api/pdf/create-monthly-pdf?name=${encodeURIComponent(name)}&year=${year}&month=${month}`;

      // PDF in neuem Tab öffnen
      window.open(pdfUrl, '_blank');
    }
    // --- ENDE PDF DOWNLOAD ---

  </script>
</body>
</html>
